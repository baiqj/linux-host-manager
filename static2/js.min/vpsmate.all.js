angular.module("vpsmate.services",[]).factory("Auth",["$rootScope","$http","$location",function(a,d,c){var b={};b.required=function(f,e){d.post("/authstatus").success(function(g){if(f){f.call(null,g.authed=="yes")}if(g.authed=="no"){a.loginto=c.path();a.loginto_section=c.search().s;if(a.loginto=="/"||a.loginto=="/logout"){a.loginto="/main";a.loginto_section=""}c.path("/");c.search("s",null)}}).error(function(h,g){if(e){e.call(null,g)}})};b.getlastactive=function(e){d.get("/authstatus?"+Math.random()).success(function(f){if(e){e.call(null,f.lastactive)}})};return b}]).factory("Module",["$rootScope","$location",function(a,c){var b={};b.init=function(e,d){a.module=e;a.htmlTitle=d};b.initSection=function(d){var e=c.search().s;a.activeTabName=e?e:d};b.getSection=function(){return c.search().s};b.setSection=function(d){a.activeTabName=d};b.getParam=function(d){return c.search()[d]};return b}]).factory("Timeout",["$rootScope","$timeout",function(a,b){var c=function(g,f,e,h,d){if(e&&a.module!=e){return}if(h&&a[d]){return}if(!d){d="timeout"}a[d]=b(function(){if(a[d]){delete a[d]}if(!e||a.module==e){g.call()}},f)};return c}]).factory("Message",["$rootScope","$timeout",function(b,d){var c={};b.showSuccessMsg=false;b.showErrorMsg=false;b.showWarningMsg=false;b.showInfoMsg=false;b.msgTimeout=0;var a=function(){if(b.msgTimeout){d.cancel(b.msgTimeout)}b.msgTimeout=d(function(){b.showSuccessMsg=false;b.showErrorMsg=false;b.showInfoMsg=false;b.msgTimeout=0},5000)};c.setSuccess=function(f,e){b.successMessage=f;if(f){b.showSuccessMsg=true;b.showErrorMsg=false;b.showInfoMsg=false;if(!e){a()}}else{b.showSuccessMsg=false;b.showErrorMsg=false;b.showInfoMsg=false}};c.setError=function(f,e){b.errorMessage=f;if(f){b.showSuccessMsg=false;b.showErrorMsg=true;b.showInfoMsg=false;if(!e){a()}}else{b.showSuccessMsg=false;b.showErrorMsg=false;b.showInfoMsg=false}};c.setInfo=function(f,e){b.infoMessage=f;if(f){b.showSuccessMsg=false;b.showErrorMsg=false;b.showInfoMsg=true;if(!e){a()}}else{b.showSuccessMsg=false;b.showErrorMsg=false;b.showInfoMsg=false}};c.setWarning=function(f,e){b.warningMessage=f;if(f){b.showWarningMsg=true;if(!e){a()}}else{b.showWarningMsg=false}};return c}]).factory("Request",["$http","$rootScope","$location","$timeout","Message",function(h,a,g,d,c){var b={};var f=function(j,i){return function(k){a.processing=false;if(!i&&k.msg){if(k.code==0){c.setSuccess(k.msg)}else{if(k.code==-1){c.setError(k.msg)}else{if(k.code==1){c.setWarning(k.msg)}else{if(k.code==2){c.setInfo(k.msg)}}}}}if(j){j.call(null,k)}}};var e=function(j,i){return function(l,k){a.processing=false;if(!i&&j){if(!j.call(null,l,k)){return}}if(k==403){c.setError("登录无效或超时，请重新登录。",true);a.loginto=g.path();a.loginto_section=g.search().s;if(a.loginto=="/"||a.loginto=="/logout"){a.loginto="/main";a.loginto_section=""}g.path("/");g.search("s",null)}else{c.setError("发生未知错误！")}}};b.setProcessing=function(i){a.processing=i};b.get=function(l,m,i,k){a.processing=true;var j=a.$proxyroot+l;if(j.indexOf("?")>0){j+="&"+Math.random()}else{j+="?"+Math.random()}h.get(j).success(f(m,k)).error(e(i,k))};b.post=function(k,l,m,i,j){a.processing=true;h.post(a.$proxyroot+k,l).success(f(m,j)).error(e(i,j))};return b}]).factory("Backend",["Timeout","Request",function(c,b){var a={};a.call=function(d,g,f,j,h,i,e){d.waiting=true;b.post(f,h,function(k){if(k.code==-1){if(i){if(typeof i.error=="function"){i.error.call(null,k.data)}}return}var l=function(){b.get(j,function(m){if(m.status=="finish"){d.waiting=false;if(m.code==0){if(i){if(typeof i=="function"){i.call(null,m)}else{if(typeof i.success=="function"){i.success.call(null,m)}}}}else{if(i){if(typeof i=="function"){i.call(null,m)}else{if(typeof i.error=="function"){i.error.call(null,m)}}}}}else{if(i){if(typeof i.wait=="function"){i.wait.call(null,m)}}c(l,500,g)}},false,e)};c(l,500,g)},function(k){if(i){if(typeof i.error=="function"){i.error.call(null,k)}}})};return a}]);angular.module("vpsmate.directives",[]).directive("navbar",function(){return{restrict:"A",transclude:true,scope:{},controller:["$scope","$rootScope",function(b,a){a.navbar_loaded=true}],template:'<div class="navbar">				<div class="navbar-inner">					<div class="container">						<button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">							<span class="icon-bar"></span>							<span class="icon-bar"></span>							<span class="icon-bar"></span>						</button>						<a class="brand" href="#/main">VPSMate</a>						<div class="nav-collapse collapse">							<ul class="nav">								<li ng-class="\'active\' | ifmatch:[currentItem,\'main\']"><a href="#/main">首页</a></li>								<li ng-class="\'active\' | ifmatch:[currentItem,\'service(..*)?\']"><a href="#/service">服务管理</a></li>								<li ng-class="\'active\' | ifmatch:[currentItem,\'file\']"><a href="#/file">文件管理</a></li>								<li ng-class="\'active\' | ifmatch:[currentItem,\'site(..*)?\']"><a href="#/site">网站管理</a></li>								<li ng-class="\'active\' | ifmatch:[currentItem,\'database\']"><a href="#/database">数据库管理</a></li>								<!--<li ng-class="\'active\' | ifmatch:[currentItem,\'ftp\']"><a href="#/ftp">FTP管理</a></li>-->								<!--<li ng-class="\'active\' | ifmatch:[currentItem,\'secure\']"><a href="#/secure">安全管理</a></li>								<li ng-class="\'active\' | ifmatch:[currentItem,\'backup\']"><a href="#/backup">备份管理</a></li>								<li ng-class="\'active\' | ifmatch:[currentItem,\'log\']"><a href="#/log">日志管理</a></li>-->								<li ng-class="\'active\' | ifmatch:[currentItem,\'task\']"><a href="#/task">计划任务</a></li>								<li ng-class="\'active\' | ifmatch:[currentItem,\'utils(..*)?\']"><a href="#/utils">系统工具</a></li>							</ul>							<ul class="nav pull-right">								<li ng-class="\'active\' | ifmatch:[currentItem,\'setting(..*)?\']"><a href="#/setting">设置</a></li>								<li class="divider-vertical"></li>								<li ng-class="\'active\' | ifmatch:[currentItem,\'logout\']"><a href="#/logout">退出</a></li>							</ul>						</div>					</div>				</div>			</div>',replace:true}}).directive("loading",function(){return{restrict:"A",transclude:true,scope:{},controller:["$scope",function(a){if(!a.loadingText){a.loadingText="模块加载中，请稍候......"}}],template:'<div style="padding:30px 0 10px 30px;">			<h6>{{loadingText}}</h6>			<div class="progress progress-striped active" style="width:230px">			<div class="bar" style="width:100%;"></div>			</div></div>',replace:true}}).directive("message",function(){return{restrict:"A",transclude:true,scope:{},controller:["$scope","$rootScope",function(b,a){a.showErrorMsg=false;a.errorMessage="";a.showSuccessMsg=false;a.successMessage="";a.showWarningMsg=false;a.warningMessage="";a.showInfoMsg=false;a.infoMessage="";b.$rootScope=a;if(!b.id){b.id="message"}}],template:'<div id="{{id}}" style="position:fixed;left:0;bottom:0;width:100%;z-index:100">			<div class="container">				<div class="alert alert-error" style="display:none;margin-bottom:3px" ng-show="$rootScope.showErrorMsg">				<button ng-click="$rootScope.showErrorMsg=false" type="button" class="close">&times;</button>				<span ng-bind-html-unsafe="$rootScope.errorMessage"></span></div>				<div class="alert alert-success" style="display:none;margin-bottom:3px" ng-show="$rootScope.showSuccessMsg">				<button ng-click="$rootScope.showSuccessMsg=false" type="button" class="close">&times;</button>				<span ng-bind-html-unsafe="$rootScope.successMessage"></span></div>				<div class="alert alert-warning" style="display:none;margin-bottom:3px" ng-show="$rootScope.showWarningMsg">				<button ng-click="$rootScope.showWarningMsg=false" type="button" class="close">&times;</button>				<span ng-bind-html-unsafe="$rootScope.warningMessage"></span></div>				<div class="alert alert-info" style="display:none;margin-bottom:3px" ng-show="$rootScope.showInfoMsg">				<button ng-click="$rootScope.showInfoMsg=false" type="button" class="close">&times;</button>				<span ng-bind-html-unsafe="$rootScope.infoMessage"></span></div>			</div>			</div>',replace:true}}).directive("srvminiop",function(){return{restrict:"A",transclude:true,scope:{},controller:["$scope",function(a){a.$scope=a.$parent}],template:'<div><div class="btn-group" ng-show="$scope.info[\'service.\'+service]">					<button class="btn btn-small" ng-class="\'active\' | iftrue:$scope.info[\'service.\'+service].autostart" data-toggle="button" title="自动启动"						ng-disabled="$scope.waiting" ng-click="$scope.toggleAutostart(name, service)">						<i class="icon-check"></i>					</button>					<button class="btn btn-small" ng-show="$scope.info[\'service.\'+service].status==\'stopped\'" title="启动" ng-disabled="$scope.waiting"						ng-click="$scope.start(name, service)">						<i class="icon-play"></i>					</button>					<button class="btn btn-small" ng-show="$scope.info[\'service.\'+service].status==\'running\'" title="停止" ng-disabled="$scope.waiting"						ng-click="$scope.stop(name, service)">						<i class="icon-stop"></i>					</button>					<button class="btn btn-small" ng-disabled="$scope.info[\'service.\'+service].status==\'stopped\'||$scope.waiting" title="重启"						ng-click="$scope.restart(name, service)">						<i class="icon-refresh"></i>					</button>					<a class="btn btn-small" href="#/service/{{urlname}}" ng-show="$scope.info[\'service.\'+service]!=null" title="设置">						<i class="icon-wrench"></i>					</a>				</div>				<a class="btn btn-small" href="#/service/{{urlname}}" ng-show="!$scope.info[\'service.\'+service]">安装服务</a></div>',replace:true}}).directive("srvbase",function(){return{restrict:"A",transclude:true,scope:{},controller:["$rootScope","$scope","Request","Backend",function(a,c,d,b){c.$scope=c.$parent;c.pkginfo=null;c.$parent.checkVersion=function(){b.call(c.$parent,a.module,"/backend/yum_info","/backend/yum_info_"+c.pkg,{pkg:c.pkg,repo:"installed"},{success:function(f){c.$parent.pkginfo=c.pkginfo=f.data[0]},error:function(f){c.pkginfo={name:"获取失败！"}}},true)};c.toggleAutostart=function(){d.post("/operation/chkconfig",{name:c.name,service:c.service,autostart:!c.$parent.autostart},function(f){c.$parent.checkInstalled()})};var e=function(f){return function(){b.call(c.$parent,a.module,"/backend/service_"+f,"/backend/service_"+f+"_"+c.service,{name:c.name,service:c.service},c.$parent.checkInstalled)}};c.start=e("start");c.stop=e("stop");c.restart=e("restart")}],template:'<table class="table table-button" style="width:600px;">				<thead>					<tr>						<th colspan="2">{{name}} 服务操作</th>					</tr>				</thead>				<tbody>					<tr>						<td style="width:120px;">当前软件版本：</td>						<td>							<span ng-show="!pkginfo">正在获取...</span>							<span style="display:none" ng-show="pkginfo">							{{pkginfo.name}} {{\'v\'+pkginfo.version+\'-\'+pkginfo.release | iftrue:pkginfo.version}} {{"("+pkginfo.from_repo+")" | iftrue:pkginfo.from_repo}}							</span>						</td>					</tr>					<tr>						<td style="width:120px;">当前服务状态：</td>						<td ng-bind-html-unsafe="$scope.status | service.status"></td>					</tr>					<tr>						<td>开机是否启动：</td>						<td>							<button class="btn btn-small" ng-class="\'active\' | iftrue:$scope.autostart" data-toggle="button"								ng-click="toggleAutostart()">								<i class="icon-check"></i> 开机自动启动							</button>						</td>					</tr>					<tr>						<td>启动/停止服务：</td>						<td>							<button class="btn btn-small" ng-show="$scope.status==\'stopped\'" ng-disabled="$scope.waiting"								ng-click="start()">								<i class="icon-play"></i> 启动服务							</button>							<button class="btn btn-small" ng-show="$scope.status==\'running\'" ng-disabled="$scope.waiting"								ng-click="stop()">								<i class="icon-stop"></i> 停止服务							</button>							<button class="btn btn-small" ng-disabled="$scope.status==\'stopped\'||$scope.waiting"								ng-click="restart()">								<i class="icon-refresh"></i> 重启服务							</button>						</td>					</tr>				</tbody>				</table>',replace:true}}).directive("srvinstall",function(){return{restrict:"A",transclude:true,scope:{},controller:["$rootScope","$scope","Request","Timeout","Backend",function(a,d,e,f,c){d.$scope=d.$parent;var b=[];d.installing=false;d.installMsg="";d.startInstall=function(){d.installMsg="正在检测软件源...";d.installing=true;c.call(d.$parent,a.module,"/backend/yum_repolist","/backend/yum_repolist",{},{wait:function(g){d.installMsg=g.msg},success:function(g){d.installMsg=g.msg;b=g.data;d.installRepo()},error:function(g){d.installMsg=g.msg;f(function(){d.installing=false},3000,a.module)}},true)};d.installRepo=function(){var h=false;for(var l=0;l<d.expected_repolist.length;l++){var g=false;for(var k=0;k<b.length;k++){if(b[k]==d.expected_repolist[l]){g=true;break}}if(g){continue}h=true;c.call(d.$parent,a.module,"/backend/yum_installrepo","/backend/yum_installrepo_"+d.expected_repolist[l],{repo:d.expected_repolist[l]},{wait:function(i){d.installMsg=i.msg},success:function(i){d.installMsg=i.msg;b.push(d.expected_repolist[l]);d.installRepo()},error:function(i){d.installMsg=i.msg;f(function(){d.installing=false},3000,a.module)}},true);break}if(!h){d.checkVersion()}};d.showVerList=false;d.checkVersion=function(){c.call(d.$parent,a.module,"/backend/yum_info","/backend/yum_info_"+d.pkg,{pkg:d.pkg},{wait:function(g){d.installMsg=g.msg},success:function(g){d.installMsg=g.msg;d.pkgs=g.data;d.showVerList=true},error:function(g){d.installMsg=g.msg;f(function(){d.installing=false},3000,a.module)}},true)};d.install=function(j,i,h,g){d.installMsg="开始安装...";d.showVerList=false;c.call(d.$parent,a.module,"/backend/yum_install","/backend/yum_install_"+j+"_"+i+"_"+h+"_"+g,{repo:j,pkg:i,version:h,release:g},{wait:function(k){d.installMsg=k.msg},success:function(k){d.installMsg=k.msg;d.$parent.activeTabName="base";f(function(){d.installing=false;d.$parent.checkInstalled()},3000,a.module)},error:function(k){d.installMsg=k.msg;f(function(){d.installing=false},3000,a.module)}},true)};d.uninstall=function(j,i,h,g){d.installMsg="正在清理...";d.showVerList=false;c.call(d.$parent,a.module,"/backend/yum_uninstall","/backend/yum_uninstall_"+i+"_"+h+"_"+g,{repo:j,pkg:i,version:h,release:g},{wait:function(k){d.installMsg=k.msg},success:function(k){d.installMsg=k.msg;f(function(){d.installing=false;d.$parent.checkInstalled()},3000,a.module)},error:function(k){d.installMsg=k.msg;f(function(){d.installing=false},3000,a.module)}},true)}}],template:'<div class="well" style="width:600px;display:none" ng-show="!$scope.installed&&!$scope.checking">				<div ng-show="!installing">					<p>系统检测到 {{name}} 当前尚未安装。</p>					<p>是否要开始安装？</p>				</div>				<div ng-show="installing" ng-bind-html-unsafe="installMsg"></div>				<p ng-show="!installing"><button class="btn btn-small" style="margin-top:10px" ng-click="startInstall()">开始安装</button></p>				<table class="table table-condensed" style="margin-top:20px;display:none" ng-show="showVerList&&pkgs.length>0">					<thead>						<tr>							<th>版本</th>							<th style="width:70px">大小</th>							<th style="width:70px">软件源</th>							<th style="width:80px"></th>						</tr>					</thead>					<tbody>						<tr ng-repeat="pkg in pkgs">							<td>{{pkg.name}} v{{pkg.version}}-{{pkg.release}}</td>							<td>{{pkg.size}}</td>							<td>{{\'已安装\'|iftrue:pkg.repo==\'installed\'}}{{pkg.repo|iftrue:pkg.repo!=\'installed\'}}</td>							<td>								<button class="btn btn-mini" ng-show="pkg.repo==\'installed\'" ng-click="uninstall(pkg.repo, pkg.name, pkg.version, pkg.release)">清除此版本</button>								<button class="btn btn-mini" ng-show="pkg.repo!=\'installed\'" ng-click="install(pkg.repo, pkg.name, pkg.version, pkg.release)">安装此版本</button>							</td>						</tr>					</tbody>				</table>			</div>',replace:true}}).directive("srvupdate",function(){return{restrict:"A",transclude:true,scope:{},controller:["$rootScope","$scope","Request","Timeout","Backend",function(a,c,d,e,b){c.$scope=c.$parent;c.updating=false;c.updateMsg="";c.startUpdate=function(){c.updating=true;c.updateMsg="正在检测当前版本信息...";b.call(c.$parent,a.module,"/backend/yum_info","/backend/yum_info_"+c.pkg,{pkg:c.pkg,repo:"installed"},{wait:function(f){c.updateMsg=f.msg},success:function(f){c.updateMsg=f.msg;c.pkginfo=f.data[0];c.checkVersion(c.pkginfo.name)},error:function(f){c.updateMsg=f.msg;e(function(){c.updating=false},3000,a.module)}},true)};c.showVerList=false;c.checkVersion=function(f){c.updateMsg="正在检测新版本...";b.call(c.$parent,a.module,"/backend/yum_info","/backend/yum_info_"+f,{pkg:f,option:"update"},{wait:function(g){c.updateMsg=g.msg},success:function(g){c.updateMsg=g.msg;c.pkgs=g.data;c.showVerList=true},error:function(g){c.updateMsg=g.msg;e(function(){c.updating=false},3000,a.module)}},true)};c.update=function(i,h,g,f){c.updateMsg="开始升级...";c.showVerList=false;b.call(c.$parent,a.module,"/backend/yum_update","/backend/yum_update_"+i+"_"+h+"_"+g+"_"+f,{repo:i,pkg:h,version:g,release:f},{wait:function(j){c.updateMsg=j.msg},success:function(j){c.updateMsg=j.msg;c.$parent.activeTabName="base";e(function(){c.updating=false;c.$parent.checkInstalled()},3000,a.module)},error:function(j){c.updateMsg=j.msg;e(function(){c.updating=false},3000,a.module)}},true)}}],template:'<div class="well" style="width:600px;display:none" ng-show="$scope.installed&&!$scope.checking">				<div ng-show="!updating">					<p>在此检测并查找可用的新版本并升级。</p>				</div>				<div ng-show="updating" ng-bind-html-unsafe="updateMsg"></div>				<p ng-show="!updating"><button class="btn btn-small" style="margin-top:10px" ng-click="startUpdate()">检测新版本</button></p>				<table class="table table-condensed" style="margin-top:20px;display:none" ng-show="showVerList&&pkgs.length>0">					<thead>						<tr>							<th>版本</th>							<th style="width:70px">大小</th>							<th style="width:70px">软件源</th>							<th style="width:90px"></th>						</tr>					</thead>					<tbody>						<tr ng-repeat="pkg in pkgs">							<td>{{pkg.name}} v{{pkg.version}}-{{pkg.release}}</td>							<td>{{pkg.size}}</td>							<td>{{\'已安装\'|iftrue:pkg.repo==\'installed\'}}{{pkg.repo|iftrue:pkg.repo!=\'installed\'}}</td>							<td>								<button class="btn btn-mini" ng-show="pkg.repo!=\'installed\'" ng-click="update(pkg.repo, pkg.name, pkg.version, pkg.release)">升级到此版本</button>							</td>						</tr>					</tbody>				</table>			</div>',replace:true}}).directive("srvext",function(){return{restrict:"A",transclude:true,scope:{},controller:["$rootScope","$scope","Request","Timeout","Backend",function(a,c,d,e,b){c.$scope=c.$parent;c.operating=false;c.showMsg="";c.start=function(){c.operating=true;c.showMsg="正在检测版本信息...";b.call(c.$parent,a.module,"/backend/yum_info","/backend/yum_info_"+c.pkg,{pkg:c.pkg,repo:"installed"},{wait:function(f){c.showMsg=f.msg},success:function(f){c.showMsg=f.msg;c.pkginfo=f.data[0];c.checkExt()},error:function(f){c.showMsg=f.msg;e(function(){c.operating=false},3000,a.module)}},true)};c.showExtList=false;c.checkExt=function(){c.operating=true;c.showExtList=false;c.showMsg="正在检测扩展...";b.call(c.$parent,a.module,"/backend/yum_ext_info","/backend/yum_ext_info_"+c.pkginfo.name,{pkg:c.pkginfo.name},{wait:function(f){c.showMsg=f.msg},success:function(f){c.showMsg=f.msg;c.exts=f.data;c.showExtList=true},error:function(f){c.showMsg=f.msg;e(function(){c.operating=false},3000,a.module)}},true)};c.install=function(i,h,g,f){c.showMsg="开始安装...";c.showExtList=false;b.call(c.$parent,a.module,"/backend/yum_install","/backend/yum_install_"+i+"_"+c.pkginfo.name+"_"+h+"_"+g+"_"+f,{repo:i,pkg:c.pkginfo.name,ext:h,version:g,release:f},{wait:function(j){c.showMsg=j.msg},success:function(j){c.showMsg=j.msg;e(function(){c.operating=false;c.checkExt()},3000,a.module)},error:function(j){c.showMsg=j.msg;e(function(){c.operating=false},3000,a.module)}},true)};c.uninstall=function(i,h,g,f){c.showMsg="正在删除...";c.showExtList=false;b.call(c.$parent,a.module,"/backend/yum_uninstall","/backend/yum_uninstall_"+c.pkginfo.name+"_"+h+"_"+g+"_"+f,{repo:i,pkg:c.pkginfo.name,ext:h,version:g,release:f},{wait:function(j){c.showMsg=j.msg},success:function(j){c.showMsg=j.msg;e(function(){c.operating=false;c.checkExt()},3000,a.module)},error:function(j){c.showMsg=j.msg;e(function(){c.operating=false},3000,a.module)}},true)}}],template:'<div class="well" style="width:600px;display:none" ng-show="$scope.installed&&!$scope.checking">				<div ng-show="!operating">					<p>点击下面的按钮检测扩展安装情况。</p>				</div>				<div ng-show="operating" ng-bind-html-unsafe="showMsg"></div>				<p ng-show="!operating"><button class="btn btn-small" style="margin-top:10px" ng-click="start()">检测扩展</button></p>				<table class="table table-condensed" style="margin-top:20px;display:none" ng-show="showExtList&&exts.length>0">					<thead>						<tr>							<th>扩展名称</th>							<th>版本</th>							<th style="width:70px">软件源</th>							<th style="width:90px"></th>						</tr>					</thead>					<tbody>						<tr ng-repeat="ext in exts">							<td>{{ext.name}}</td>							<td>{{ext.version}}-{{ext.release}}</td>							<td>{{\'已安装\'|iftrue:ext.repo==\'installed\'}}{{ext.repo|iftrue:ext.repo!=\'installed\'}}</td>							<td>								<button class="btn btn-mini" ng-show="ext.repo==\'installed\'" ng-click="uninstall(ext.repo, ext.name, ext.version, ext.release)">删除扩展</button>								<button class="btn btn-mini" ng-show="ext.repo!=\'installed\'" ng-click="install(ext.repo, ext.name, ext.version, ext.release)">安装该扩展</button>							</td>						</tr>					</tbody>				</table>			</div>',replace:true}}).directive("srvuninstall",function(){return{restrict:"A",transclude:true,scope:{},controller:["$rootScope","$scope","Request","Timeout","Backend",function(a,c,d,e,b){c.$scope=c.$parent;c.uninstalling=false;c.uninstallMsg="";c.startUninstall=function(){c.uninstallMsg="开始卸载...";c.uninstalling=true;b.call(c.$parent,a.module,"/backend/yum_info","/backend/yum_info_"+c.pkg,{pkg:c.pkg,repo:"installed"},{wait:function(f){c.uninstallMsg=f.msg},success:function(f){c.uninstallMsg=f.msg;c.pkginfo=f.data[0];c.showVersion=true},error:function(f){c.uninstallMsg=f.msg;e(function(){c.uninstalling=false},3000,a.module)}},true)};c.uninstall=function(i,h,g,f){c.uninstallMsg="正在卸载...";c.showVersion=false;b.call(c.$parent,a.module,"/backend/yum_uninstall","/backend/yum_uninstall_"+h+"_"+g+"_"+f,{repo:i,pkg:h,version:g,release:f},{wait:function(j){c.uninstallMsg=j.msg},success:function(j){c.uninstallMsg=j.msg;e(function(){c.uninstalling=false;c.$parent.checkInstalled()},3000,a.module)},error:function(j){c.uninstallMsg=j.msg;e(function(){c.uninstalling=false},3000,a.module)}},true)}}],template:'<div class="well" style="width:600px;" ng-show="$scope.installed&&!$scope.checking">				<div ng-show="!uninstalling">					<p>确定要卸载 {{name}} 吗？</p>				</div>				<div ng-show="uninstalling" ng-bind-html-unsafe="uninstallMsg"></div>				<p ng-show="!uninstalling"><button class="btn btn-small" style="margin-top:10px" ng-click="startUninstall()">开始卸载</button></p>				<table class="table table-condensed" style="margin-top:20px;display:none" ng-show="showVersion">					<thead>						<tr><th colspan="2">请确认要卸载的软件信息：</th></tr>					</thead>					<tbody>						<tr><td style="width:80px">名称：</td><td>{{pkginfo.name}}</td></tr>						<tr><td>版本：</td><td>{{pkginfo.version}}-{{pkginfo.release}}</td></tr>						<tr><td>大小：</td><td>{{pkginfo.size}}</td></tr>						<tr ng-show="pkginfo.from_repo"><td>软件源：</td><td>{{pkginfo.from_repo}}</td></tr>					</tbody>				</table>				<p ng-show="showVersion"><button class="btn btn-mini" ng-click="uninstall(pkginfo.repo, pkginfo.name, pkginfo.version, pkginfo.release)">确认并卸载</button>			</div>',replace:true}}).directive("srvfile",function(){return{restrict:"A",transclude:true,scope:{},controller:["$scope",function(a){}],template:'			<table class="table table-button" style="width:600px;">				<tbody>					<tr class="warning">						<td colspan="3" class="text-error">注意：如果您没有配置文件修改经验，请勿随意修改，否则可能导致服务无法启动。</td>					</tr>					<tr ng-repeat="item in items">						<td style="width:120px;">{{item.name}}</td>						<td>							<i class="icon-folder-open" ng-show="item.isdir"></i>							<i class="icon-file" ng-show="item.isfile"></i>							{{item.path}}						</td>						<td style="width:100px">							<a class="btn btn-small" href="#/file?path={{item.path}}" ng-show="item.isdir">								打开 <i class="icon-chevron-right"></i>							</a>							<a class="btn btn-small" href="#/file?file={{item.path}}" ng-show="item.isfile">								打开 <i class="icon-chevron-right"></i>							</a>						</td>					</tr>				</tbody>			</table>',replace:true}}).directive("srvlog",function(){return{restrict:"A",transclude:true,scope:{},controller:["$scope",function(a){}],template:'			<table class="table table-button" style="width:600px;">				<tbody>					<tr class="warning">						<td colspan="3" class="text-error">注意：尽量不要对日志文件进行修改，否则可能导致新日志无法写入。</td>					</tr>					<tr ng-repeat="item in items">						<td style="width:120px;">{{item.name}}</td>						<td>							<i class="icon-folder-open" ng-show="item.isdir"></i>							<i class="icon-file" ng-show="item.isfile"></i>							{{item.path}}						</td>						<td style="width:100px">							<a class="btn btn-small" href="#/file?path={{item.path}}" ng-show="item.isdir">								打开 <i class="icon-chevron-right"></i>							</a>							<a class="btn btn-small" href="#/file?file={{item.path}}" ng-show="item.isfile">								打开 <i class="icon-chevron-right"></i>							</a>						</td>					</tr>				</tbody>			</table>',replace:true}}).directive("selector",function(){return{restrict:"A",transclude:true,scope:{},controller:["$scope","Request",function(a,b){a.$scope=a.$parent;a.onlydir=true;a.onlyfile=true;a.path="/";var c=function(){if(!a.curpath){return}var g=a.curpath.split("/");var d=[];for(var e=1;e<g.length;e++){if(!g[e]){continue}var f=g[e-1]+"/"+g[e];d.push({name:g[e],path:f});g[e]=f}a.pathinfos=d};a.load=function(d){if(a.onlyfile){a.otherdir=true;a.listdir(d)}else{a.otherdir=false;a.path=d}};a.listdir=function(d){if(d){a.path=d}if(!a.path){a.path="/root"}else{if(a.path!="/"&&a.path.substr(-1)=="/"){a.path=a.path.substr(0,a.path.length-1)}}a.path=a.path.replace("//","/");var e=a.path;b.post("/operation/file",{action:"listdir",path:e,showhidden:false,remember:false,onlydir:a.onlydir},function(f){if(f.code==0){a.items=f.data;a.curpath=e;a.lastpath=e;a.curpath_pre=e=="/"?"":e}else{a.path=a.lastpath}c()},false,true)};a.$parent.selector=a}],template:'<div>			<div ng-show="onlydir&&!onlyfile&&!otherdir">				<p>当前目录为：{{path}}</p>				<p>					<button class="btn" ng-click="selecthandler(path)">选择当前目录</button>					<button class="btn" ng-click="otherdir=true;listdir(path)">选择其它目录</button>				</p>			</div>			<div ng-show="otherdir">			<ul class="breadcrumb" style="margin-bottom:0">				<li><a ng-click="listdir(\'/\')">根目录</a> <span class="divider">/</span></li>				<li ng-repeat="pathinfo in pathinfos" ng-show="pathinfos.length>0"><a ng-click="listdir(pathinfo.path)">{{pathinfo.name}}</a> <span class="divider">/</span></li>				<li><button class="btn btn-mini" ng-show="onlydir" ng-click="selecthandler(curpath)">选取该目录</button></li>			</ul>			<table class="table table-condensed table-hover">				<thead>					<tr>						<th></th>						<th style="width:80px"></th>					</tr>				</thead>				<tbody>					<tr ng-repeat="item in items">						<td>							<i class="icon-folder-open" title="文件夹" ng-show="item.isdir"></i>							<i class="icon-file" title="文件" ng-show="item.isreg"></i>							<i class="icon-asterisk" title="链接" ng-show="item.islnk&&(item.link_isdir||item.link_isreg)"></i>							<i class="icon-ban-circle" title="未知" ng-show="!item.isdir&&!item.isreg&&(!item.islnk||(item.islnk&&!item.link_isdir&&!item.link_isreg))"></i>							<a class="black" ng-click="listdir(curpath_pre+\'/\'+item.name)" ng-show="item.isdir||(item.islnk&&item.link_isdir)">{{item.name}}</a>							<a class="black" ng-show="item.isreg||(item.islnk&&!item.link_isdir)">{{item.name}}</a>							<span class="text-info" ng-show="item.islnk">-> {{item.linkto}}</span>						</td>						<td>							<button class="btn btn-mini" ng-show="onlydir&&(item.isdir||(item.islnk&&item.link_isdir))" ng-click="selecthandler(curpath_pre+\'/\'+item.name)">选取该目录</button>							<button class="btn btn-mini" ng-show="onlyfile&&(item.isreg||(item.islnk&&item.link_isreg))" ng-click="selecthandler(curpath_pre+\'/\'+item.name)">选取该文件</button>						</td>					</tr>				</tbody>			</table>			</div>',replace:true}}).directive("autofocus",function(){return function(a,b){b[0].focus()}});angular.module("vpsmate.filters",[]).filter("iftrue",function(){return function(a,b){return b?a:""}}).filter("ifmatch",function(){return function(a,b){return b[0].match(new RegExp("^"+b[1]+"$"))?a:""}}).filter("ifnotmatch",function(){return function(a,b){return b[0].match(new RegExp("^"+b[1]+"$"))?"":a}}).filter("ifin",function(){return function(a,b){return typeof b[1][b[0]]!="undefined"?a:""}}).filter("ifnotin",function(){return function(a,b){return typeof b[1][b[0]]!="undefined"?"":a}}).filter("ifverget",function(){return function(a,c){if(!c[0]||!c[1]){return""}var e=c[0].split(".");var d=c[1].split(".");for(var b=0;b<e.length;b++){if(d.length==b){return a}if(e[b]==d[b]){continue}else{if(e[b]>d[b]){return a}else{return""}}}if(e.length!=d.length){return""}return a}}).filter("urlencode",function(){return function(a){return a?encodeURIComponent(a):""}}).filter("netiface.updown",function(){return function(a){return a=="up"?'<span class="label label-success">启用</span>':'<span class="label label-warning">停用</span>'}}).filter("netiface.encap",function(){return function(a){if(a=="Local Loopback"){return"本地环路"}if(a=="Ethernet"){return"以太网"}if(a=="Point-to-Point Protocol"){return"点对点"}if(a=="UNSPEC"){return"未识别"}return a}}).filter("loadavg.overload",function(){return function(a,c){if(!a){return""}var b=a-c;b=parseInt(b*100/c);if(b<0){return'<span class="label label-success">'+Math.abs(b)+"%空闲</span>"}else{if(b>100){return'<span class="label label-important">'+b+"%过载</span>"}else{return'<span class="label label-warning">'+b+"%过载</span>"}}}}).filter("uptime.idlerate",function(){return function(a){if(!a){return""}var b=parseInt(a);if(b<10){return'<span class="label label-important">'+a+"空闲</span>"}else{if(b<25){return'<span class="label label-warning">'+a+"空闲</span>"}else{return'<span class="label label-success">'+a+"空闲</span>"}}}}).filter("space.used",function(){return function(a){if(!a){return""}var b=parseInt(a);if(b>90){return'<span class="label label-important">'+a+"</span>"}else{if(b>75){return'<span class="label label-warning">'+a+"</span>"}else{return'<span class="label label-success">'+a+"</span>"}}}}).filter("space.free",function(){return function(a){if(!a){return""}var b=parseInt(a);if(b<10){return'<span class="label label-important">'+a+"</span>"}else{if(b<25){return'<span class="label label-warning">'+a+"</span>"}else{return'<span class="label label-success">'+a+"</span>"}}}}).filter("service.status",function(){return function(a){if(!a){return'<span class="label">未安装</span>'}return a=="running"?'<span class="label label-success">运行中</span>':'<span class="label label-important">已停止</span>'}}).filter("user.lock",function(){return function(a){return a?'<span class="label">锁定</span>':'<span class="label label-success">正常</span>'}}).filter("site.status",function(){return function(a){return a=="on"?'<span class="label label-success">启用</span>':'<span class="label label-important">停用</span>'}}).filter("site.engine",function(){return function(a){if(a=="static"){return"静态"}else{if(a=="fastcgi"){return"FastCGI"}else{if(a=="scgi"){return"SCGI"}else{if(a=="uwsgi"){return"uWSGI"}else{if(a=="redirect"){return"跳转"}else{if(a=="rewrite"){return"重写"}else{if(a=="proxy"){return"反代"}else{if(a=="return"){return"错误"}else{return a}}}}}}}}}}).filter("site.port",function(){return function(a){if(a=="80"){return"http"}else{if(a=="443"){return"https"}else{return""}}}}).filter("site.default_server",function(){return function(a){return !a?'<span class="label label-info">默认</span>':""}}).filter("bytes2human",function(){return function(e){var c=["G","M","K"];var a=c.length;var b=[];for(var d=0;d<a;d++){b[d]=1<<(a-d)*10}for(var d=0;d<a;d++){if(e>=b[d]){return Math.round((e/b[d])*10)/10+c[d]}}return e+"B"}}).filter("mysql.user",function(){return function(a){return a==""?'<span class="text-error">任意</span>':a}}).filter("mysql.haspasswd",function(){return function(a){return a=="N"?'<span class="text-error">否</span>':"是"}}).filter("mysql.grant",function(){return function(a){return a=="N"?"否":"是"}}).filter("mysql.privtype",function(){return function(a,b){if(a=="*"||a==""){return"全局指定"}if(a==b){return"按数据库指定"}return"通配符"}}).filter("mysql.privtype_en",function(){return function(a,b){if(a=="*"||a==""){return"global"}if(a==b){return"bydb"}return"wildcard"}}).filter("mysql.privs",function(){return function(b,e){if(!b){return"---"}var f=["Select_priv","Insert_priv","Update_priv","Delete_priv","Create_priv","Alter_priv","Index_priv","Drop_priv","Create_tmp_table_priv","Show_view_priv","Create_routine_priv","Alter_routine_priv","Execute_priv","Create_view_priv","Event_priv","Trigger_priv","Lock_tables_priv","References_priv"];var a=["File_priv","Super_priv","Process_priv","Reload_priv","Shutdown_priv","Show_db_priv","Repl_client_priv","Repl_slave_priv","Create_user_priv"];if(e=="global"){f=f.concat(a)}var d=0;for(var c=0;c<f.length;c++){if(b[f[c]]=="Y"){d++}}if(d==0){return e=="global"?"无全局权限":"无权限"}else{if(d==f.length){return"所有权限"}else{return"部分权限"}}}});var releasetime="2013-01-18 18:32:57 CST";var _v=new Date(releasetime.replace(/-/g,"/")).getTime()/1000;angular.module("vpsmate",["vpsmate.services","vpsmate.directives","vpsmate.filters"]).config(["$routeProvider",function(a){var b=function(e,g,d){var f={templateUrl:template_path+"/partials/"+e+".html?_v="+_v,controller:g,reloadOnSearch:false};if(!d){f.resolve=Auth}return f};a.when("/",b("login",LoginCtrl,true)).when("/main",b("main",MainCtrl)).when("/service/nginx",b("service/nginx",ServiceNginxCtrl)).when("/service/apache",b("service/apache",ServiceApacheCtrl)).when("/service/vsftpd",b("service/vsftpd",ServiceVsftpdCtrl)).when("/service/mysql",b("service/mysql",ServiceMySQLCtrl)).when("/service/redis",b("service/redis",ServiceRedisCtrl)).when("/service/memcache",b("service/memcache",ServiceMemcacheCtrl)).when("/service/mongodb",b("service/mongodb",ServiceMongoDBCtrl)).when("/service/php",b("service/php",ServicePHPCtrl)).when("/service/sendmail",b("service/sendmail",ServiceSendmailCtrl)).when("/service/ssh",b("service/ssh",ServiceSSHCtrl)).when("/service/iptables",b("service/iptables",ServiceIPTablesCtrl)).when("/service/cron",b("service/cron",ServiceCronCtrl)).when("/service/ntp",b("service/ntp",ServiceNTPCtrl)).when("/service",b("service/index",ServiceCtrl)).when("/file",b("file/file",FileCtrl)).when("/file/go#(:path)",b("file/file",FileCtrl)).when("/file/trash",b("file/trash",FileTrashCtrl)).when("/site",b("site/index",SiteCtrl)).when("/site/nginx/:section",b("site/nginx/site",SiteNginxCtrl)).when("/database",b("database/index",DatabaseCtrl)).when("/database/mysql/db/new",b("database/mysql/dbnew",DatabaseMySQLNewDBCtrl)).when("/database/mysql/db/edit/:section",b("database/mysql/dbedit",DatabaseMySQLEditDBCtrl)).when("/database/mysql/user/new",b("database/mysql/usernew",DatabaseMySQLNewUserCtrl)).when("/database/mysql/user/edit/:section",b("database/mysql/useredit",DatabaseMySQLEditUserCtrl)).when("/ftp",b("ftp",FtpCtrl)).when("/task",b("task",TaskCtrl)).when("/utils",b("utils/index",UtilsCtrl)).when("/utils/user",b("utils/user",UtilsUserCtrl)).when("/utils/network",b("utils/network",UtilsNetworkCtrl)).when("/utils/time",b("utils/time",UtilsTimeCtrl)).when("/utils/partition",b("utils/partition",UtilsPartitionCtrl)).when("/utils/autofm",b("utils/autofm",UtilsAutoFMCtrl)).when("/utils/movedata",b("utils/movedata",UtilsMoveDataCtrl)).when("/setting",b("setting",SettingCtrl)).when("/logout",b("logout",LogoutCtrl)).when("/sorry",b("sorry",SorryCtrl)).otherwise({redirectTo:"/sorry"})}]).run(["$rootScope","$location","Request",function(a,c,b){a.sec=function(d){c.search("s",d)};a.virt="?";a.checkVirt=function(d){if(a.virt!="?"){return}b.get("/query/server.virt",function(e){a.virt=e["server.virt"];if(d){d.call()}})};a.$mysql={password:"",password_validated:false};a.$proxyroot=location_path}]).value("version",{version:"1.0",build:"10",releasetime:releasetime,changelog:"http://www.vpsmate.org/changelog"});var Auth={auth:function(b,c,d){var a=b.defer();d.setInfo("正在加载，请稍候...",true);c.required(function(e){d.setInfo(false);if(e){a.resolve()}},function(e){if(e==403){d.setError('身份认证失败，请<a href="#/">重新登录</a>！')}else{d.setError("对不起，加载失败！（网络异常或服务器故障）")}});return a.promise},auto_auth:function(a,h,d,e){if(!a._auth_check_inited){a._auth_check_inited=true;var b=300*1000;var c=2500*1000;var g=new Date().getTime();$(document).mousemove(function(){g=new Date().getTime()});$(document).keydown(function(){g=new Date().getTime()});var f=(function(){var j=false;var i=new Date().getTime();if(i-g<b){d.required()}else{if(i-g>c){j=true;d.getlastactive(function(n){n=parseInt(n)*1000;if(i-n>c){var k=a.htmlTitle;var m=["登录超时","!!!!!!!!"];var l=0;var o=false;var p=function(){if(!o){a.htmlTitle=m[(l++)%2];e(p,1000,false,true,"_authtimeout_title")}else{a.htmlTitle=k}};p();a._authrenew=function(){g=new Date().getTime();o=true;d.required();e(f,b,false,true,"_authtimeout")};$("#_authconfirm").modal()}else{g=n;e(f,b,false,true,"_authtimeout")}})}}if(!j&&h.path()!="/"){e(f,b,false,true,"_authtimeout")}});e(f,b,false,true,"_authtimeout")}}};Auth.auth.$inject=["$q","Auth","Message"];Auth.auto_auth.$inject=["$rootScope","$location","Auth","Timeout"];var getCookie=function(a){var b=document.cookie.match("\\b"+a+"=([^;]*)\\b");return b?b[1]:undefined};var LoginCtrl=["$scope","$rootScope","$location","Module","Message","Request",function(b,a,h,c,f,e){var d="login";c.init(d,"登录");b.loginText="登录";b.showForgetPwdMsg=false;b.showLoginForm=true;b.username="";b.password="";var g=function(m){var l=new RegExp("^(?=.{8,})(?=.*[A-Z])(?=.*[a-z])(?=.*[0-9])(?=.*\\W).*$","g");var k=new RegExp("^(?=.{7,})(((?=.*[A-Z])(?=.*[a-z]))|((?=.*[A-Z])(?=.*[0-9]))|((?=.*[a-z])(?=.*[0-9]))).*$","g");var j=new RegExp("(?=.{6,}).*","g");if(false==j.test(m)){return"无安全性可言"}else{if(l.test(m)){return"高"}else{if(k.test(m)){return"一般"}else{return"低"}}}};b.login=function(j){b.loginText="登录中...";e.post("/login",{username:b.username,password:j?b.password:hex_md5(b.password)},function(k){if(k.code>=0){b.showLoginForm=false;var m=a.loginto?a.loginto:"/main";var l=a.loginto_section;if(k.code==0){h.path(m);if(l){h.search("s",l)}}else{b.pwdStrength=g(b.password);if(b.pwdStrength!="高"){f.setError(false);f.setWarning(false);$("#main").hide();b.loginMessage=k.msg;b.loginWarning=true}else{h.path(m);if(l){h.search("s",l)}}}}else{b.loginText="登录"}})}}];var LogoutCtrl=["$scope","$location","Module","Request","Timeout",function(a,f,b,d,e){var c="logout";b.init(c,"退出登录");a.loaded=false;e(function(){a.loaded=true;d.get("/xsrf",function(){d.post("/logout",{},function(g){e(function(){f.path("/")},3000,c)})})},1000,c)}];var deepUpdate=function(b,a){for(i in a){if(typeof(a[i])=="object"){deepUpdate(b[i],a[i])}else{if(b[i]!=a[i]){b[i]=a[i]}}}};var MainCtrl=["$scope","$routeParams","$location","Module","Timeout","Request","version",function(b,g,h,c,f,e,a){var d="main";c.init(d,"首页");c.initSection("server");b.version=a;b.info=null;b.loaded=false;b.detectVer=true;b.hasNewver=false;e.get("/setting/upver",function(k){if(k.code==-1){b.upverMessage=k.msg}else{if(k.code==0){var j=k.data;if(parseFloat(j.version)>parseFloat(a.version)||(parseFloat(j.version)==parseFloat(a.version)&&parseInt(j.build)>parseInt(a.build))){b.detectVer=false;b.hasNewver=true}}}});b.checkUpdate=function(){h.path("/setting");h.search("s","upversion")};b.loadInfo=function(j){if(!j){j="*"}e.get("/query/"+j,function(n){if(b.info==null){b.info=n;b.info["server.cpustat"]["total"]["used_rate"]="获取中...";for(var p=0;p<n["server.netifaces"].length;p++){b.info["server.netifaces"][p]["rx_speed"]="0";b.info["server.netifaces"][p]["tx_speed"]="0"}if(!b.loaded){b.loaded=true}}else{if(b.info){var o=n["server.cpustat"]["total"];var r=b.info["server.cpustat"]["total"];var s=(o.used-r.used)/(o.all-r.all);s=Math.round(s*10000)*10;var m=100000-s;s=((s+1)/1000).toString();m=((m+1)/1000).toString();o.used_rate=s.substring(0,s.length-1)+"%";o.idle_rate=m.substring(0,m.length-1)+"%";var l=n["server.netifaces"];var q=b.info["server.netifaces"];for(var p=0;p<l.length;p++){var k=l[p]["timestamp"]-q[p]["timestamp"];if(k>0){l[p]["rx_speed"]=Math.round((l[p]["rx_bytes"]-q[p]["rx_bytes"])/k);l[p]["tx_speed"]=Math.round((l[p]["tx_bytes"]-q[p]["tx_bytes"])/k)}}}deepUpdate(b.info,n)}f(b.loadInfo,1000,d)})}}];var FtpCtrl=["$scope","Module",function(a,b){var c="ftp";b.init(c,"FTP管理");a.loaded=true}];var TaskCtrl=["$scope","Module",function(a,b){var c="task";b.init(c,"计划任务");a.loaded=true}];var SettingCtrl=["$scope","$routeParams","Module","Timeout","Message","Request","version",function(b,h,c,g,f,e,a){var d="setting";c.init(d,"系统设置");c.initSection("authinfo");b.version=a;b.showUpdateBtn=false;b.showRestartBtn=true;b.loaded=true;b.password=b.passwordc="";b.loadAuthInfo=function(){e.get("/setting/auth",function(j){b.username=j.username;b.passwordcheck=j.passwordcheck})};b.loadServerInfo=function(){e.get("/setting/server",function(j){b.ip=j.ip;b.port=j.port})};b.loadAccessKey=function(){e.get("/setting/accesskey",function(j){b.accesskey=j.accesskey;b.accesskeyenable=j.accesskeyenable})};b.updateAuthInfo=function(){e.post("/setting/auth",{username:b.username,password:b.password?hex_md5(b.password):"",passwordc:b.passwordc?hex_md5(b.passwordc):"",passwordcheck:b.passwordcheck},function(j){if(j.code==0){b.loadAuthInfo()}})};b.updateServerInfo=function(){e.post("/setting/server",{port:b.port,ip:b.ip},function(){if(data.code==0){b.loadServerInfo()}})};b.updateAccessKey=function(){e.post("/setting/accesskey",{accesskey:b.accesskey,accesskeyenable:b.accesskeyenable},function(j){if(j.code==0){b.loadAccessKey()}})};b.checkUpVersion=function(){b.upverMessage="正在检测新版本...";e.get("/setting/upver?force=1",function(k){if(k.code==-1){b.upverMessage=k.msg}else{if(k.code==0){var j=k.data;if(parseFloat(j.version)>parseFloat(a.version)||(parseFloat(j.version)==parseFloat(a.version)&&parseInt(j.build)>parseInt(a.build))){b.upverMessage='<table class="table table-condensed"><thead><tr><th colspan="2">有可用的新版本</th></tr></thead><tbody><tr><td>版本信息：</td><td>v'+j.version+" b"+j.build+"</td></tr><tr><td>发布时间：</td><td>"+j.releasetime+'</td></tr><tr><td>变更记录：</td><td><a href="'+j.changelog+'" target="_blank">查看版本变更记录</a></td></tr></tbody></table>';b.updateBtnText="开始在线升级";b.showUpdateBtn=true}else{b.upverMessage="当前已是最新版本！"}}}})};b.update=function(){b.upverMessage="正在升级，请稍候...";b.showUpdateBtn=false;e.post("/backend/update",{},function(k){var j=function(){e.get("backend/update",function(l){f.setInfo("");if(l.msg){b.upverMessage=l.msg}if(l.status=="finish"&&l.code==0){b.upverMessage="正在重启 VPSMate...";g(function(){e.post("/backend/service_restart",{service:"vpsmate"},function(n){var m=function(){e.get("backend/service_restart_vpsmate",function(o){f.setInfo("");if(o.msg){b.upverMessage=o.msg}g(m,500,d)},function(p,o){if(o==403||o==0){b.upverMessage="升级成功！请刷新页面重新登录。";return false}return true})};g(m,500,d)})},1000,d)}else{g(j,500,d)}})};g(j,500,d)})};b.restartMessage="是否要重启 VPSMate？";b.restart=function(){b.restartMessage="正在重启，请稍候...";b.showRestartBtn=false;g(function(){e.post("/backend/service_restart",{service:"vpsmate"},function(k){var j=function(){e.get("backend/service_restart_vpsmate",function(l){if(l.msg){b.restartMessage=l.msg}g(j,500,d)},function(m,l){if(l==403||l==0){b.restartMessage="重启成功！请刷新页面重新登录。";return false}return true})};g(j,500,d)})},1000,d)};b.genaccesskey=function(){var l="";for(var k=0;k<32;k++){l+=String.fromCharCode(Math.floor(256*Math.random()))}var j=function(p){var m="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var n="";var w,u,s,v,t,r,q;var o=0;while(o<p.length){w=p.charCodeAt(o++);u=p.charCodeAt(o++);s=p.charCodeAt(o++);v=w>>2;t=((w&3)<<4)|(u>>4);r=((u&15)<<2)|(s>>6);q=s&63;if(isNaN(u)){r=q=64}else{if(isNaN(s)){q=64}}n=n+m.charAt(v)+m.charAt(t)+m.charAt(r)+m.charAt(q)}return n};b.accesskey=j(l)}}];var SorryCtrl=["$scope","Module","$timeout",function(a,b,d){var c="sorry";b.init(c,"页面不存在");a.loaded=true}];var FileCtrl=["$scope","$routeParams","Module","Message","Request","Backend",function(m,h,r,a,o,i){var e="file";r.init(e,"文件管理");var b=h.path;var j=h.file;var k=true;var n=true;m.path=m.lastpath="/root";m.curpath="";m.showhidden=false;m.clipboard={srcpath:"",count:0,items:{}};m.confirm=m.cancel=function(){};var d=function(){var v=m.curpath.split("/");var s=[];for(var t=1;t<v.length;t++){if(!v[t]){continue}var u=v[t-1]+"/"+v[t];s.push({name:v[t],path:u});v[t]=u}m.pathinfos=s};m.loaded=false;m.load=function(){if(b||j){m.loaded=true;k=false;n=false;if(j){b=j.split("/");j=b.pop();b=b.join("/");if(!b){b="/"}}m.listdir(b,true,function(){if(j){m.editfile(j)}})}else{o.post("/operation/file",{action:"last"},function(u){if(u.code==0){m.loaded=true;var t=u.data.lastfile;var s=u.data.lastdir;m.listdir(s,true,function(){if(t&&t.indexOf(s)===0){t=t.replace(s+"/","");if(t.indexOf("/")==-1){m.editfile(t)}}})}},false,true)}};m.fileloading=false;m.listdir=function(t,s,v){if(t){m.path=t}if(m.path==""){m.path="/root"}else{if(m.path!="/"&&m.path.substr(-1)=="/"){m.path=m.path.substr(0,m.path.length-1)}}m.path=m.path.replace("//","/");var u=m.path;m.fileloading=true;o.post("/operation/file",{action:"listdir",path:u,showhidden:m.showhidden,remember:k},function(w){if(w.code==0){m.items=w.data;m.curpath=u;m.lastpath=u;if(s){m.selects={};m.selectall=false}}else{m.path=m.lastpath}m.fileloading=false;d();if(v){v.call()}},false,true)};m.getitem=function(s,t){if(!t){t=s}else{delete m.selects[t]}o.post("/operation/file",{action:"getitem",path:m.curpath+"/"+s},function(z){if(z.code==0){var v=z.data;var y=false;for(var u=0;u<m.items.length;u++){if(m.items[u].name==t){m.items[u]=v;y=true;break}}if(!y){var w=false;var u=0;if(v.isdir||v.islnk&&v.link_isdir){for(;u<m.items.length;u++){var x=m.items[u];if(x.isdir||x.islnk&&x.link_isdir){if(m.items[u].name.localeCompare(v.name)>1){m.items.splice(u,0,v);w=true;break}}else{break}}}else{for(;u<m.items.length;u++){var x=m.items[u];if(x.isdir||x.islnk&&x.link_isdir){continue}if(m.items[u].name.localeCompare(v.name)>1){m.items.splice(u,0,v);w=true;break}}}if(!w){m.items.splice(u,0,v)}}}else{for(var u=0;u<m.items.length;u++){if(m.items[u].name==s){m.items.splice(u,1);break}}}},false,true)};m.upandlist=function(){var s=m.curpath.split("/");s.pop();m.listdir(s.join("/")+"/",true)};m.editfile=function(s){o.post("/operation/file",{action:"fread",path:m.curpath+"/"+s,remember:n},function(u){if(u.code==0){a.setSuccess("");var t=u.data;m.filename=t.filename;m.filepath=t.filepath;m.filecharset=t.charset;m.filecharset_org=t.charset;g.setValue("");$("#list").hide();$("#edit").show();g.setOption("mode",t.mimetype);g.setValue(t.content);q=false}})};m.return2list=m.canceledit=function(){if(q){m.confirm_title="是否放弃修改？";m.confirm_body=m.filepath+" 已被修改，是否放弃修改？";$("#confirm").modal();m.cancel=function(){};m.confirm=function(){$("#edit").hide();$("#list").show();o.post("/operation/file",{action:"fclose"},false,false,true)}}else{$("#edit").hide();$("#list").show();o.post("/operation/file",{action:"fclose"},false,false,true)}};m.savefile=function(){if(!q&&m.filecharset==m.filecharset_org){a.setInfo("文件未修改，无须保存！");return}o.post("/operation/file",{action:"fwrite",path:m.filepath,charset:m.filecharset,content:g.getValue()},function(s){if(s.code==0){q=false;m.getitem(m.filename)}})};m.newfolder=function(){m.newname_title="新建文件夹";m.newname_label="文件夹名称";m.newname_name="";$("#newname").modal();m.newname=function(){o.post("/operation/file",{action:"createfolder",path:m.curpath,name:m.newname_name},function(s){if(s.code==0){m.getitem(m.newname_name)}})}};m.newfile=function(){m.newname_title="新建文件";m.newname_label="文件名称";m.newname_name="";$("#newname").modal();m.newname=function(){o.post("/operation/file",{action:"createfile",path:m.curpath,name:m.newname_name},function(s){if(s.code==0){m.getitem(m.newname_name)}})}};m.upload=function(){$("#upload").modal()};m.doupload=function(){var s=$("#uploadform").find("input[name=ufile]").val().split(/[\\\/]/);var t=s[s.length-1];o.post("/operation/file",{action:"getitem",path:m.curpath+"/"+t},function(u){if(u.code==0){m.confirm_title="上传文件覆盖确认";m.confirm_body="<p>系统检测到当前目录下已存在同名文件 "+t+"。</p><p>确认要覆盖这个文件吗？</p>";$("#confirm").modal();m.confirm=function(){$("#uploadform").submit()}}else{$("#uploadform").submit()}},false,true)};m.download=function(){$("#download").modal();m.dodownload=function(){i.call(m,e,"/backend/wget","/backend/wget_"+encodeURIComponent(encodeURIComponent(m.downloadurl)),{url:m.downloadurl,path:m.curpath},{success:function(s){m.listdir()}})}};m.togglehidden=function(){m.showhidden=!m.showhidden;m.listdir()};m.rename=function(s){m.newname_title="重命名";m.newname_label="新名称";m.newname_name=s;$("#newname").modal();m.newname=function(){o.post("/operation/file",{action:"rename",path:m.curpath+"/"+s,name:m.newname_name},function(t){if(t.code==0){m.getitem(m.newname_name,s)}})}};var p=function(s){return function(u,v){var t=m.clipboard;if(t.srcpath!=m.curpath){t.items={};t.count=0}if(typeof v=="undefined"){if(typeof t.items[u]=="undefined"){t.srcpath=m.curpath;t.items[u]=s;t.count++}else{if(t.items[u]==s){delete t.items[u];t.count--}else{if(typeof v=="undefined"){t.items[u]=s}}}}else{if(v){if(typeof t.items[u]=="undefined"){t.srcpath=m.curpath;t.count++}t.items[u]=s}else{if(typeof t.items[u]!="undefined"){delete t.items[u];t.count--}}}}};m.togglecopy=p("copy");m.togglecut=p("cut");m.togglelink=p("link");m.paste=function(){f()};var l=function(v,t,s,u){if(v=="copy"){i.call(m,e,"/backend/copy","/backend/copy_"+t+"_"+s,{srcpath:t,despath:s},{success:function(w){delete m.clipboard.items[u];m.selects={};m.listdir();f()},error:function(w){m.listdir()}})}else{if(v=="cut"){i.call(m,e,"/backend/move","/backend/move_"+t+"_"+s,{srcpath:t,despath:s},{success:function(w){delete m.clipboard.items[u];m.selects={};m.listdir();f()},error:function(w){m.listdir()}})}else{if(v=="link"){o.post("/operation/file",{action:"link",srcpath:t,despath:s},function(w){if(w.code==0){m.selects={};m.listdir();delete m.clipboard.items[u];f()}})}}}};var f=function(t){var s="";for(s in m.clipboard.items){break}if(!s){return}var u=m.clipboard.items[s];o.post("/operation/file",{action:"exist",name:t?t:s,path:m.curpath},function(x){if(x.code==0){var w=m.clipboard.srcpath+"/"+s;var v=m.curpath+"/"+(t?t:s);if(x.data){m.overwrite_filename=(t?t:s);m.overwrite_option="rename";m.overwrite_newname=(t?t:s)+".new";$("#overwriteconfirm").modal();m.overwrite=function(){if(m.overwrite_option=="rename"){f(m.overwrite_newname)}else{l(u,w,v,s)}}}else{l(u,w,v,s)}}})};m.move2trash=function(s){o.post("/operation/file",{action:"delete",paths:m.curpath+"/"+s},function(v){if(v.code==0){m.getitem(s);var t="."+s+".bak";for(var u=0;u<m.items.length;u++){if(m.items[u].name==t){m.getitem(t);break}}}})};m.compressconfirm=function(s,t){m.compress_isreg=t;m.compress_type=t?".gz":".tar.gz";m.compress_zipname=s;m.compress_name=s;m.compress_names=[];$("#compressconfirm").modal()};m.compress=function(){var t=m.curpath+"/"+m.compress_zipname+m.compress_type;var s=m.curpath+"/"+m.compress_name;i.call(m,e,"/backend/compress","/backend/compress_"+t+"_"+s,{zippath:t,paths:s},{success:function(v){var u=m.compress_zipname+m.compress_type;if(m.compress_type==".gz"){m.getitem(u,m.compress_name)}else{m.getitem(u)}}})};m.decompress=function(t){var u=t.split(".");var s=u.pop();var w=u.pop();if(s=="gz"&&w!="tar"){var v=m.curpath+"/"+t;i.call(m,e,"/backend/decompress","/backend/decompress_"+v+"_",{zippath:v},{success:function(x){m.getitem(t.substr(0,t.length-3),t)}});return}m.selector_title="请选择要解压到的目录";m.selector.onlydir=true;m.selector.onlyfile=false;m.selector.load(m.curpath);m.selector.selecthandler=function(x){$("#selector").modal("hide");a.setInfo("正在检测目录...",true);o.post("/operation/file",{action:"listdir",path:x,showhidden:true,remember:false},function(z){if(z.code==0){a.setInfo("");var y=function(){var A=m.curpath+"/"+t;i.call(m,e,"/backend/decompress","/backend/decompress_"+A+"_"+x,{zippath:A,despath:x},{success:function(B){if(m.curpath==x){m.listdir()}}})};if(z.data.length>0){m.confirm_title="解压确认";m.confirm_body="<p>系统检测到目录 "+x+" 下存在文件，继续解压将可能覆盖这些文件。</p><p>确认要继续解压吗？</p>";$("#confirm").modal();m.confirm=y}else{y()}}else{a.setError("检测目录失败！")}},false,true)};$("#selector").modal()};m.$watch("selectall",function(s){angular.forEach(m.items,function(t){m.selects[t.name]=s})});m.multicopy=function(){var s=false;angular.forEach(m.selects,function(t,u){m.togglecopy(u,t);if(t){s=true}});if(!s){a.setError("请先选择文件或目录！");return}};m.multicut=function(){var s=false;angular.forEach(m.selects,function(t,u){m.togglecut(u,t);if(t){s=true}});if(!s){a.setError("请先选择文件或目录！");return}};m.multidel=function(){var s=[];angular.forEach(m.selects,function(t,u){if(t){s.push(m.curpath+"/"+u)}});if(s.length==0){a.setError("请先选择文件或目录！");return}o.post("/operation/file",{action:"delete",paths:s.join(",")},function(t){if(t.code==0){m.selects={};m.listdir()}})};m.tarconfirm=function(){var s=[];angular.forEach(m.selects,function(t,u){if(t){s.push(u)}});if(s.length==0){a.setError("请先选择文件或目录！");return}if(s.length==1){m.compressconfirm(s[0],false);return}m.compress_isreg=false;m.compress_type=".tar.gz";m.compress_zipname=m.curpath.split("/").pop();m.compress_name="多个项目";m.compress_names=s;$("#compressconfirm").modal()};m.tar=function(){var u=m.curpath+"/"+m.compress_zipname+m.compress_type;var s=[];for(var t=0;t<m.compress_names.length;t++){s.push(m.curpath+"/"+m.compress_names[t])}if(s.length==0){a.setError("请先选择文件或目录！");return}i.call(m,e,"/backend/compress","/backend/compress_"+u+"_"+s.join(","),{zippath:u,paths:s.join(",")},{success:function(v){m.listdir()}})};m.chownconfirm=function(u,t,w,s){if(!u){var v=[];angular.forEach(m.selects,function(x,y){if(x){v.push(y)}});if(v.length==0){a.setError("请先选择文件或目录！");return}}if(!m.users){o.post("/operation/user",{action:"listuser",fullinfo:false},function(x){if(x.code==0){m.users=x.data}},false,true)}if(!m.groups){o.post("/operation/user",{action:"listgroup",fullinfo:false},function(x){if(x.code==0){m.groups=x.data}},false,true)}if(u){m.chown_user=t;m.chown_group=w;m.chown_names=[u];m.chown_recursively=true;m.chown_hasdir=s}else{m.chown_names=v;m.chown_recursively=true;m.chown_hasdir=true}$("#chownconfirm").modal()};m.chown=function(){var t=[];for(var s=0;s<m.chown_names.length;s++){t.push(m.curpath+"/"+m.chown_names[s])}t=t.join(",");i.call(m,e,"/backend/chown","/backend/chown_"+t,{paths:t,user:m.chown_user,group:m.chown_group,recursively:m.chown_recursively},{success:function(u){if(m.chown_names.length==1){m.getitem(m.chown_names[0])}else{m.listdir()}}})};m.chmodconfirm=function(t,u,s){if(!t){var v=[];angular.forEach(m.selects,function(w,x){if(w){v.push(x)}});if(v.length==0){a.setError("请先选择文件或目录！");return}u="0744"}u=parseInt(u,8);m.chmod_permbits=[[(u&256)!=0,(u&128)!=0,(u&64)!=0],[(u&32)!=0,(u&16)!=0,(u&8)!=0],[(u&4)!=0,(u&2)!=0,(u&1)!=0],];m.chmod_recursively=true;if(t){m.chmod_names=[t];m.chmod_hasdir=s}else{m.chmod_names=v;m.chmod_hasdir=true}$("#chmodconfirm").modal()};m.chmod=function(){var u=0;for(var t=0;t<3;t++){for(var s=0;s<3;s++){u|=(m.chmod_permbits[t][s]<<(8-t*3-s))}}u=u.toString(8);var v=[];for(var t=0;t<m.chmod_names.length;t++){v.push(m.curpath+"/"+m.chmod_names[t])}v=v.join(",");i.call(m,e,"/backend/chmod","/backend/chmod_"+v,{paths:v,perms:u,recursively:m.chmod_recursively},{success:function(w){if(m.chmod_names.length==1){m.getitem(m.chmod_names[0])}else{m.listdir()}}})};var q=false;var g=CodeMirror(document.getElementById("editor"),{value:"",lineNumbers:true,lineWrapping:true,matchBrackets:true,onCursorActivity:function(){g.setLineClass(c,null,null);c=g.setLineClass(g.getCursor().line,null,"activeline");if(!$.browser.msie){g.matchHighlight("CodeMirror-matchhighlight")}},onChange:function(){q=true}});var c=g.setLineClass(0,"activeline")}];var FileTrashCtrl=["$scope","$routeParams","Module","Message","Request","Backend",function(b,g,c,f,e,a){var d="file.trash";c.init(d,"回收站管理");b.loaded=true;b.confirm=function(){};b.fileloading=false;b.tlist=function(){b.fileloading=true;e.post("/operation/file",{action:"tlist"},function(h){if(h.code==0){b.items=h.data;b.fileloading=false}})};b.restore=function(h,i){e.post("/operation/file",{action:"trestore",mount:h,uuid:i},function(j){if(j.code==0){b.tlist()}})};b.tdeleteconfirm=function(i,h,j){b.confirm_title="删除确认";b.confirm_body="<p>删除后文件将不可恢复！</p><p>确认要删除 "+i+" 吗？</p>";$("#confirm").modal();b.confirm=function(){b.tdelete(h,j)}};b.tdelete=function(h,i){e.post("/operation/file",{action:"titem",mount:h,uuid:i},function(j){if(j.code==0){var k=j.data.realpath;a.call(b,d,"/backend/remove","/backend/remove_"+k,{paths:k},function(){e.post("/operation/file",{action:"tdelete",mount:h,uuid:i},function(l){if(l.code==0){b.tlist()}})})}})};b.tcleanconfirm=function(){b.confirm_title="清空确认";b.confirm_body="<p>清空回收站后，回收站中的所有文件都将被删除且不可恢复！<p>								<p>确认要清空回收站吗？</p>";$("#confirm").modal();b.confirm=function(){b.tclean()}};b.tclean=function(){e.post("/operation/file",{action:"trashs"},function(h){if(h.code==0){var i=h.data.join(",");a.call(b,d,"/backend/remove","/backend/remove_"+i,{paths:i},function(){f.setSuccess("清空回收站完成！");b.tlist()})}})}}];var SiteCtrl=["$scope","Module","$routeParams","Request","Message","Backend",function(i,e,h,a,f,d){var c="site";e.init(c,"网站管理");i.loaded=false;var g=e.getSection();i.has_httpserver=false;i.nginx_supported=false;i.apache_supported=false;i.site_packages=[];i.load=function(){a.get("/query/service.nginx,service.httpd",function(j){if(j["service.nginx"]&&j["service.nginx"].status){i.nginx_supported=true}if(j["service.httpd"]&&j["service.httpd"].status){i.apache_supported=true}i.has_httpserver=i.nginx_supported||i.apache_supported;if(i.has_httpserver){if(g){if(g=="nginx"&&i.nginx_supported){e.setSection("nginx")}else{if(g=="apache"&&i.apache_supported){e.setSection("apache")}else{if(g=="package"){e.setSection("package")}else{e.setSection(i.nginx_supported?"nginx":"apache")}}}}else{e.setSection(i.nginx_supported?"nginx":"apache")}}i.loaded=true;i.loadsites()});a.get("/sitepackage/getlist",function(j){if(j.code==0){i.site_packages=j.data}})};i.package_install_setting=function(j){i.curpkg=j;i.curver=j.versions[0];i.pkgver=i.curver.code;i.installpath="/var/www";$("#pkg_install_setting").modal()};i.package_version_select=function(j){i.pkgver=j.code;i.curver=j};i.selectinstallpath=function(j){i.selector_title="请选择安装目录";i.selector.onlydir=true;i.selector.onlyfile=false;i.selector.load(i.installpath);i.selector.selecthandler=function(k){$("#selector").modal("hide");i.installpath=k};$("#selector").modal()};i.package_install=function(){f.setInfo("正在检测安装目录...",true);a.post("/operation/file",{action:"listdir",path:i.installpath,showhidden:true,remember:false},function(j){if(j.code==0){f.setInfo("");if(j.data.length>0){i.confirm_title="安装确认";i.confirm_body="<p>系统检测到目录 "+i.installpath+" 下存在文件，继续安装将可能会覆盖原文件。</p><p>确认要继续安装吗？</p>";$("#confirm").modal();i.confirm=b}else{b()}}else{f.setError("安装失败！"+j.msg)}},false,true)};function b(){f.setInfo("正在请求安装文件...");a.get("/sitepackage/getdownloadtask?name="+i.curpkg.code+"&version="+i.pkgver,function(j){if(j.code==0){i.downloadurl=j.data.url;i.downloadpath=j.data.path;i.extractpath=j.data.temp;d.call(i,c,"/backend/wget","/backend/wget_"+encodeURIComponent(encodeURIComponent(i.downloadurl)),{url:i.downloadurl,path:i.downloadpath},{success:function(l){var m=i.downloadpath;var k=i.extractpath;d.call(i,c,"/backend/decompress","/backend/decompress_"+m+"_"+k,{zippath:m,despath:k},{success:function(p){var q=i.curver.core_path;var o=i.extractpath+"/"+q+"/*";var n=i.installpath;d.call(i,c,"/backend/copy","/backend/copy_"+o+"_"+n,{srcpath:o,despath:n},{success:function(r){f.setInfo("正在清理安装临时文件...");d.call(i,c,"/backend/remove","/backend/remove_"+i.extractpath,{paths:i.extractpath},function(){f.setInfo("正在设置目录权限...");d.call(i,c,"/backend/chown","/backend/chown_"+i.installpath,{paths:i.installpath,user:"apache",group:"apache",recursively:true},{success:function(s){f.setSuccess(i.curpkg.name+" v"+i.pkgver+" 安装完成！")}})},true)},error:function(r){f.setError("复制安装文件过程中出现错误，安装取消！")}})}})},error:function(k){f.setError("下载安装包过程中出现错误，安装取消！")}},false)}})}i.loadsites=function(){if(i.nginx_supported){i.loadnginx()}if(i.apache_supported){i.loadapache()}};i.nginxloading=false;i.loadnginx=function(){i.nginxloading=true;a.post("/operation/nginx",{action:"getservers"},function(j){if(j.code==0){i.servers=j.data;i.nginxloading=false}})};i.loadapache=function(){};i.nginx_enableserver=function(l,k,j){a.post("/operation/nginx",{action:"enableserver",ip:l,port:k,server_name:j},function(m){if(m.code==0){i.loadnginx()}})};i.nginx_disableserver=function(l,k,j){a.post("/operation/nginx",{action:"disableserver",ip:l,port:k,server_name:j},function(m){if(m.code==0){i.loadnginx()}})};i.nginx_deleteserverconfirm=function(l,k,j){i.nginx_ip=l;i.nginx_port=k;i.nginx_server_name=j;$("#nginx_deleteserverconfirm").modal()};i.nginx_deleteserver=function(){a.post("/operation/nginx",{action:"deleteserver",ip:i.nginx_ip,port:i.nginx_port,server_name:i.nginx_server_name},function(j){if(j.code==0){i.loadnginx()}})}}];var SiteNginxCtrl=["$scope","Module","$routeParams","$location","Request","Backend","Timeout",function(n,u,h,k,q,i,s){var j=h.section;var p=j=="new"?"new":"edit";var l=p=="edit"?j.substr(5):"";var e,f,o;if(p=="edit"){l=l.split("_");if(l.length==3){e=l[0];f=l[1];o=l[2]}else{if(l.length==4&&l[3]==""){e=l[0];f=l[1];o="_"}else{k.path("/site");return}}}var b="site.nginx";u.init(b,p=="new"?"新建站点（Nginx）":"编辑站点（Nginx）");n.loaded=false;n.showglobaladv=false;n.curloc=-1;n.setloc=function(v){n.curloc=v};n.action=p;var d={server_names:[],listens:[],charset:"",index:"index.html index.htm index.php",locations:[],limit_rate:"",limit_conn:"",ssl_crt:"",ssl_key:"",rewrite_enable:false,rewrite_rules:""};var t={name:"",default_name:false};var r={ip:"",port:"80",ssl:false,default_server:false};var a={urlpath:"/",engine:"static","static":{root:"/var/www/",autocreate:true,autoindex:false,rewrite_enable:false,rewrite_detect_file:true,rewrite_rules:""},fastcgi:{root:"/var/www/",autocreate:true,fastcgi_pass:"127.0.0.1:9000",rewrite_enable:false,rewrite_detect_file:true,rewrite_rules:""},proxy:{protocol:"http",host:"",realip:true,charset:"",backends:[],balance:"ip_hash",keepalive:"10",proxy_cache_enable:false,proxy_cache:"",proxy_cache_min_uses:"",proxy_cache_methods_post:false,proxy_cache_key:{schema:true,host:false,proxy_host:true,uri:true,},proxy_cache_valid:[],proxy_cache_use_stale:{error:false,timeout:false,invalid_header:false,updating:false,http_500:false,http_502:false,http_503:false,http_504:false,http_404:false},proxy_cache_lock:false,proxy_cache_lock_timeout:"5"},redirect:{url:"",type:"301",option:"keep"},error:{code:"404"}};var m={server:"",weight:"",fail_timeout:"10",max_fails:"3"};var g={code:"any",time:"1",time_unit:"h"};n.setting=angular.copy(d);n.gen_by_vpsmate=p=="new"?true:false;var c={"301_1":"rewrite ^ http://example.com$request_uri? permanent","301_2":"rewrite ^ http://example.com/ permanent","302_1":"rewrite ^ http://example.com$request_uri? redirect","302_2":"rewrite ^ http://example.com/ redirect"};n.$watch("rewrite_template",function(v){n.setting.rewrite_rules=v?c[v]:""});n.load=function(){if(p=="new"){n.loaded=true}else{n.getserver()}i.call(n,b,"/backend/yum_info","/backend/yum_info_nginx",{pkg:"nginx",repo:"installed"},{success:function(v){n.nginx_version=v.data[0].version},error:function(v){n.nginx_version=""}},true);n.loadproxycaches()};n.proxy_caches=[];n.loadproxycaches=function(){q.post("/operation/nginx",{action:"gethttpsettings",items:"proxy_cache_path[]"},function(x){if(x.code==0){var w=$.browser.msie?[""]:[];var y=x.data.proxy_cache_path;if(y){for(var v=0;v<y.length;v++){w.push(y[v].name)}}n.proxy_caches=w}},false,true)};n.getserver=function(v){q.post("/operation/nginx",{action:"getserver",ip:e,port:f,server_name:o},function(B){if(B.code==0){var E=B.data;var K=n.setting;n.gen_by_vpsmate=E._vpsmate;for(A in E.server_names){var w=E.server_names[A];K.server_names.push({name:w,default_name:w=="_"})}for(A in E.listens){var z=E.listens[A];var I=angular.copy(r);if(typeof z.ip!="undefined"){I.ip=z.ip}if(typeof z.port!="undefined"){I.port=z.port}if(typeof z.ssl!="undefined"){I.ssl=z.ssl}if(typeof z.default_server!="undefined"){I.default_server=z.default_server}K.listens.push(I)}if(E.index){K.index=E.index}if(E.charset){K.charset=E.charset}if(E.limit_rate){K.limit_rate=E.limit_rate}if(E.limit_conn){K.limit_conn=E.limit_conn}if(E.ssl_crt){K.ssl_crt=E.ssl_crt}if(E.ssl_key){K.ssl_key=E.ssl_key}if(E.rewrite_rules){K.rewrite_rules=E.rewrite_rules.join("\n");if(K.rewrite_rules){K.rewrite_enable=true}}if(E.locations){for(A in E.locations){var C=E.locations[A];var I=angular.copy(a);if(typeof C.urlpath!="undefined"){I.urlpath=C.urlpath;I.oldurlpath=I.urlpath}if(typeof C.error_code!="undefined"){I.engine="error";I.error.code=C.error_code}else{if(typeof C.fastcgi_pass!="undefined"){I.engine="fastcgi";I.fastcgi.fastcgi_pass=C.fastcgi_pass;if(C.root){I.fastcgi.root=C.root}I.fastcgi.rewrite_detect_file=C.rewrite_detect_file?true:false;if(C.rewrite_rules){I.fastcgi.rewrite_rules=C.rewrite_rules.join(";\n");if(I.fastcgi.rewrite_rules){I.fastcgi.rewrite_rules+=";";I.fastcgi.rewrite_enable=true}}}else{if(typeof C.proxy_protocol!="undefined"){I.engine="proxy";I.proxy.protocol=C.proxy_protocol;if(typeof C.proxy_host!="undefined"){I.proxy.host=C.proxy_host}if(typeof C.proxy_realip!="undefined"){I.proxy.realip=C.proxy_realip}if(typeof C.proxy_balance!="undefined"){I.proxy.balance=C.proxy_balance}if(typeof C.proxy_keepalive!="undefined"){I.proxy.keepalive=C.proxy_keepalive}for(A in C.proxy_backends){var F=C.proxy_backends[A];var G=angular.copy(m);if(typeof F.server!="undefined"){G.server=F.server}if(typeof F.weight!="undefined"){G.weight=F.weight}if(typeof F.fail_timeout!="undefined"){G.fail_timeout=F.fail_timeout}if(typeof F.max_fails!="undefined"){G.max_fails=F.max_fails}I.proxy.backends.push(G)}if(typeof C.proxy_cache!="undefined"){I.proxy.proxy_cache_enable=true;I.proxy.proxy_cache=C.proxy_cache;if(typeof C.proxy_cache_min_uses!="undefined"){I.proxy.proxy_cache_min_uses=C.proxy_cache_min_uses}if(typeof C.proxy_cache_methods!="undefined"){I.proxy.proxy_cache_methods_post=C.proxy_cache_methods=="POST"}if(typeof C.proxy_cache_key!="undefined"){var y=C.proxy_cache_key.split("$");var J=I.proxy.proxy_cache_key;for(var A=0;A<y.length;A++){if(y[A]=="schema"){J.schema=true}else{if(y[A]=="host"){J.host=true}else{if(y[A]=="proxy_host"){J.proxy_host=true}else{if(y[A]=="request_uri"){J.uri=true}}}}}}if(typeof C.proxy_cache_valid!="undefined"){var D=C.proxy_cache_valid;for(var A=0;A<D.length;A++){I.proxy.proxy_cache_valid.push({code:D[A].code,time:parseInt(D[A].time)+"",time_unit:D[A].time.substr(D[A].time.length-1),})}}if(typeof C.proxy_cache_use_stale!="undefined"){var x=C.proxy_cache_use_stale;var H=I.proxy.proxy_cache_use_stale;for(var A=0;A<x.length;A++){if(x[A]=="error"){H.error=true}else{if(x[A]=="timeout"){H.timeout=true}else{if(x[A]=="invalid_header"){H.invalid_header=true}else{if(x[A]=="updating"){H.updating=true}else{if(x[A]=="http_500"){H.http_500=true}else{if(x[A]=="http_502"){H.http_502=true}else{if(x[A]=="http_503"){H.http_503=true}else{if(x[A]=="http_504"){H.http_504=true}else{if(x[A]=="http_404"){H.http_404=true}}}}}}}}}}}if(typeof C.proxy_cache_lock!="undefined"){I.proxy.proxy_cache_lock=C.proxy_cache_lock;if(typeof C.proxy_cache_lock_timeout!="undefined"){I.proxy.proxy_cache_lock_timeout=C.proxy_cache_lock_timeout}}}}else{if(typeof C.redirect_url!="undefined"){I.engine="redirect";I.redirect.url=C.redirect_url;if(typeof C.redirect_type!="undefined"){I.redirect.type=C.redirect_type}if(typeof C.redirect_option!="undefined"){I.redirect.option=C.redirect_option}}else{if(typeof C.root!="undefined"){I.engine="static";I["static"].root=C.root;I["static"].rewrite_detect_file=C.rewrite_detect_file?true:false;if(typeof C.autoindex!="undefined"){I["static"].autoindex=C.autoindex}if(C.rewrite_rules){I["static"].rewrite_rules=C.rewrite_rules.join(";\n");if(I["static"].rewrite_rules){I["static"].rewrite_rules+=";";I["static"].rewrite_enable=true}}}}}}}if(I.proxy.backends.length==0){I.proxy.backends.push(angular.copy(m))}K.locations.push(I)}}n.curloc=0;n.loaded=true}else{s(function(){k.path("/site")},1000,b)}},false,v)};n.deleteservername=function(v){n.setting.server_names.splice(v,1)};n.addservername=function(){n.setting.server_names.push(angular.copy(t))};n.deletelisten=function(v){n.setting.listens.splice(v,1)};n.addlisten=function(){n.setting.listens.push(angular.copy(r))};n.deletelocation=function(v){n.setting.locations.splice(v,1);n.curloc--;if(n.curloc<0&&n.setting.locations.length>0){n.curloc=0}};n.addlocation=function(){var v=n.setting.locations;v.splice(n.curloc+1,0,angular.copy(a));n.proxy_addbackend(n.curloc+1);n.curloc++};n.proxy_deletebackend=function(v,w){n.setting.locations[v].proxy.backends.splice(w,1)};n.proxy_addbackend=function(v){n.setting.locations[v].proxy.backends.push(angular.copy(m));n.proxy_addvalid(v)};n.proxy_deletevalid=function(v,w){n.setting.locations[v].proxy.proxy_cache_valid.splice(w,1)};n.proxy_addvalid=function(v){n.setting.locations[v].proxy.proxy_cache_valid.push(angular.copy(g))};n.$watch("setting.server_names[0].name",function(D,x){var w=D;var v=x;var A=n.setting.locations;for(var z=0;z<A.length;z++){if(A[z].urlpath=="/"){var B=a["static"].root;var y=B+"/"+v;y=y.replace("//","/");if(A[z]["static"].root==y){var C=B+"/"+w;A[z]["static"].root=C.replace("//","/")}var B=a.fastcgi.root;var y=B+"/"+v;y=y.replace("//","/");if(A[z].fastcgi.root==y){var C=B+"/"+w;A[z].fastcgi.root=C.replace("//","/")}}}});n.urlpathchange=function(w){if(w.urlpath.length==0){w.urlpath="/"}if(w.engine=="fastcgi"&&w.fastcgi.rewrite_enable){var v=new RegExp("([\\^\\s])("+(w.oldurlpath+"/").replace("//","/").replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")+")","gm");w.fastcgi.rewrite_rules=w.fastcgi.rewrite_rules.replace(v,"$1"+(w.urlpath+"/").replace("//","/"));w.oldurlpath=w.urlpath}};n.selectstaticfolder=function(v){n.selector_title="请选择站点目录";n.selector.onlydir=true;n.selector.onlyfile=false;n.selector.load(n.setting.locations[v]["static"].root);n.selector.selecthandler=function(w){$("#selector").modal("hide");n.setting.locations[v]["static"].root=w};$("#selector").modal()};n.selectfastcgifolder=function(v){n.selector_title="请选择站点目录";n.selector.onlydir=true;n.selector.onlyfile=false;n.selector.load(n.setting.locations[v].fastcgi.root);n.selector.selecthandler=function(w){$("#selector").modal("hide");n.setting.locations[v].fastcgi.root=w};$("#selector").modal()};n.selectsslcrt=function(v){n.selector_title="请选择CRT文件（*.crt）";n.selector.onlydir=false;n.selector.onlyfile=true;n.selector.load("/root");n.selector.selecthandler=function(w){$("#selector").modal("hide");n.setting.ssl_crt=w};$("#selector").modal()};n.selectsslkey=function(v){n.selector_title="请选择密钥文件（*.key）";n.selector.onlydir=false;n.selector.onlyfile=true;n.selector.load("/root");n.selector.selecthandler=function(w){$("#selector").modal("hide");n.setting.ssl_key=w};$("#selector").modal()};n.addserver=function(){q.post("/operation/nginx",{action:"addserver",version:n.nginx_version,setting:angular.toJson(n.setting)},function(x){if(x.code==0){var w=n.setting;n.loaded=false;var v=(w.listens[0].ip?w.listens[0].ip:"*")+"_"+w.listens[0].port+"_"+w.server_names[0].name;s(function(){k.path("/site/nginx/edit_"+encodeURIComponent(v))},1000,b)}})};n.updateserver=function(){q.post("/operation/nginx",{action:"updateserver",ip:e,port:f,server_name:o,version:n.nginx_version,setting:angular.toJson(n.setting)},function(x){if(x.code==0){var w=n.setting;n.loaded=false;var v=(w.listens[0].ip?w.listens[0].ip:"*")+"_"+w.listens[0].port+"_"+w.server_names[0].name;s(function(){var y="/site/nginx/edit_"+encodeURIComponent(v);if(y!=k.path()){k.path(y)}else{n.restore()}},1000,b)}})};n.restore=function(){n.setting=angular.copy(d);n.getserver()};if(j=="new"){n.addservername();n.addlisten();n.addlocation()}}];var UtilsCtrl=["$scope","Module","Request",function(a,b,d){var c="utils";b.init(c,"系统工具");a.loaded=true;a.rebootconfirm=function(){$("#rebootconfirm").modal()};a.reboot=function(){d.post("/operation/reboot")}}];var UtilsUserCtrl=["$scope","$routeParams","Module","Timeout","Request",function(a,f,b,e,d){var c="utils.user";b.init(c,"用户管理");b.initSection("user");a.loaded=true;a.loadUsers=function(){d.post("/operation/user",{action:"listuser"},function(g){if(g.code==0){a.users=g.data}},false,true)};a.loadGroups=function(){d.post("/operation/user",{action:"listgroup"},function(g){if(g.code==0){a.groups=g.data}},false,true)};a.useraddconfirm=function(){a.curuser={pw_name:"",pw_gecos:"",pw_gname:"",pw_shell:"/bin/bash",pw_passwd:"",pw_passwdc:"",createhome:true,lock:false};$("#useraddconfirm").modal()};a.useradd=function(){var g=a.curuser;g.action="useradd";d.post("/operation/user",g,function(h){if(h.code==0){a.loadUsers();a.loadGroups()}})};a.usermodconfirm=function(h){var g=a.users[h];a.curuser={pw_name:g.pw_name,pw_gecos:g.pw_gecos,pw_gname:g.pw_gname,pw_dir:g.pw_dir,pw_shell:g.pw_shell,pw_passwd:"",pw_passwdc:"",lock:g.lock};$("#usermodconfirm").modal()};a.usermod=function(){var g=a.curuser;g.action="usermod";d.post("/operation/user",g,function(h){if(h.code==0){a.loadUsers();a.loadGroups()}})};a.userdelconfirm=function(h){var g=a.users[h];a.curuser={pw_name:g.pw_name};$("#userdelconfirm").modal()};a.userdel=function(){d.post("/operation/user",{action:"userdel",pw_name:a.curuser.pw_name},function(g){if(g.code==0){a.loadUsers();a.loadGroups()}})};a.groupaddconfirm=function(){a.curgrp_name="";$("#groupaddconfirm").modal()};a.groupadd=function(){d.post("/operation/user",{action:"groupadd",gr_name:a.curgrp_name},function(g){if(g.code==0){a.loadGroups()}})};a.groupmodconfirm=function(g){a.curgrp_newname=a.curgrp_name=a.groups[g].gr_name;$("#groupmodconfirm").modal()};a.groupmod=function(){d.post("/operation/user",{action:"groupmod",gr_name:a.curgrp_name,gr_newname:a.curgrp_newname},function(g){if(g.code==0){a.loadGroups()}})};a.groupdelconfirm=function(g){a.curgrp_name=a.groups[g].gr_name;$("#groupdelconfirm").modal()};a.groupdel=function(){d.post("/operation/user",{action:"groupdel",gr_name:a.curgrp_name},function(g){if(g.code==0){a.loadGroups()}})};a.groupmemsaddconfirm=function(g){a.curgrp_name=a.groups[g].gr_name;a.curgrp_mem="";$("#groupmemsaddconfirm").modal()};a.groupmemsadd=function(){d.post("/operation/user",{action:"groupmems_add",gr_name:a.curgrp_name,mem:a.curgrp_mem},function(g){if(g.code==0){a.loadUsers();a.loadGroups()}})};a.groupmemsdelconfirm=function(g){a.curgrp_name=a.groups[g].gr_name;a.curgrp_mems=a.groups[g].gr_mem;a.curgrp_mem="";$("#groupmemsdelconfirm").modal()};a.groupmemsdel=function(){d.post("/operation/user",{action:"groupmems_del",gr_name:a.curgrp_name,mem:a.curgrp_mem},function(g){if(g.code==0){a.loadUsers();a.loadGroups()}})}}];var UtilsNetworkCtrl=["$scope","$routeParams","Module","Timeout","Message","Request",function(a,g,b,f,e,d){var c="utils.network";b.init(c,"网络设置");b.initSection("ip");a.restartMessage="是否要重启网络？";a.loaded=true;a.showRestartBtn=true;a.loadIfNames=function(){d.get("/utils/network/ifnames",function(h){a.ifnames=h.ifnames;a.ifname=a.ifnames[0];a.loadIfConfig(a.ifname)})};a.loadIfConfig=function(h){a.ifname=h;d.get("/utils/network/ifconfig/"+h,function(i){a.ip=i.ip;a.mask=i.mask;a.gw=i.gw})};a.saveIfConfig=function(){d.post("/utils/network/ifconfig/"+a.ifname,{ip:a.ip,mask:a.mask,gw:a.gw},function(h){if(h.code==0){a.loadIfConfig(a.ifname)}})};a.loadNameservers=function(){d.get("/utils/network/nameservers",function(h){a.nameservers=h.nameservers})};a.saveNameservers=function(){var h=[];$(".nameserver").each(function(){var i=$(this).val();if(i){h.push(i)}});d.post("/utils/network/nameservers",{nameservers:h.join(",")},function(i){if(i.code==0){a.loadNameservers()}})};a.addNameserver=function(){a.nameservers.push("")};a.delNameserver=function(h){a.nameservers.splice(h,1)};a.restart=function(){a.restartMessage="正在重启，请稍候...";a.showRestartBtn=false;f(function(){d.post("/backend/service_restart",{service:"network"},function(i){var h=function(){d.get("backend/service_restart_network",function(j){if(j.msg){a.restartMessage=j.msg}if(j.status=="finish"){e.setSuccess("");f(function(){a.restartMessage="是否要重启网络？";a.showRestartBtn=true},3000,c)}else{f(h,500,c)}})};f(h,500,c)})},1000,c)}}];var UtilsTimeCtrl=["$scope","$routeParams","Module","Timeout","Request","Backend",function(j,h,f,e,a,d){var c="utils.time";f.init(c,"时间设置");f.initSection("datetime");j.loaded=true;j.loadDatetime=function(){a.get("/utils/time/datetime",function(k){j.datetime=k;j.newDatetime=k.str})};j.saveDatetime=function(){a.post("/backend/datetime",{datetime:j.newDatetime},function(k){a.setProcessing(true);var l=function(){a.get("backend/datetime",function(m){if(m.status!="finish"){a.setProcessing(true);e(l,500,c)}})};e(l,500,c)})};j.loadTimezone=function(){a.get("/utils/time/timezone",function(l){var k=l.timezone;j.timezone=k?k:"时区不可识别";if(k){var m=k.split("/");j.timezone_region=m[0];j.timezone_city=m[1]}else{j.timezone_region="Asia";j.timezone_city="Shanghai"}})};j.loadTimezones=function(k,l){if(k){a.get("/utils/time/timezone_list/"+k,function(m){j.cities=m.cities;if(l){l.call()}})}else{a.get("/utils/time/timezone_list",function(n){j.regions=n.regions;var m=function(){a.get("/utils/time/timezone_list/"+j.timezone_region,function(o){j.cities=o.cities})};if(j.timezone_region){m()}else{e(m,500,c)}})}};j.setTimezone=function(k,l){j.timezone_region=k;j.loadTimezones(k,function(){j.timezone_city=l})};j.saveTimezone=function(){var k=j.timezone_region;var l=j.timezone_city;a.post("/utils/time/timezone",{timezone:k+"/"+l},function(m){if(m.code==0){j.loadTimezone();j.loadDatetime()}})};j.synctime=function(){var k="pool.ntp.org";a.post("/backend/ntpdate",{server:k},function(l){a.setProcessing(true);var m=function(){a.get("backend/ntpdate_"+k,function(n){if(n.status!="finish"){a.setProcessing(true);e(m,500,c)}else{j.loadDatetime()}})};e(m,500,c)})};j.ntpdChecking=true;var b=function(){j.installMessage="时间同步需要使用 NTP 服务，您当前尚未安装该服务。<br>是否安装？";j.showInstallBtn=true};var i=function(){j.startMessage="NTP 服务已安装但还未启动，是否启动？";j.showStartBtn=true};var g=function(){j.stopMessage="NTP 服务正在运行，是否停止？";j.showStopBtn=true};b();i();g();j.loadSync=function(){a.get("/query/service.ntpd",function(k){j.ntpdStatus=null;if(k["service.ntpd"]){j.ntpdStatus=k["service.ntpd"]["status"]}j.ntpdChecking=false})};j.install=function(){j.installMessage="正在安装，请稍候...";j.showInstallBtn=false;d.call(j,c,"/backend/yum_install","/backend/yum_install_base_ntp",{repo:"base",pkg:"ntp"},{wait:function(k){j.installMessage=k.msg},success:function(k){j.installMessage=k.msg;e(j.loadSync,3000,c)},error:function(k){j.installMessage=k.msg;e(j.loadSync,3000,c)}},true)};j.start=function(){j.startMessage="正在启动，请稍候...";j.showStartBtn=false;d.call(j,c,"/backend/service_start","/backend/service_start_ntpd",{name:"NTP",service:"ntpd"},{wait:function(k){j.startMessage=k.msg},success:function(k){j.startMessage=k.msg;e(function(){i();j.loadSync()},3000,c)},error:function(k){j.startMessage=k.msg;e(function(){i();j.loadSync()},3000,c)}},true)};j.stop=function(){j.stopMessage="正在停止，请稍候...";j.showStopBtn=false;d.call(j,c,"/backend/service_stop","/backend/service_stop_ntpd",{name:"NTP",service:"ntpd"},{wait:function(k){j.stopMessage=k.msg},success:function(k){j.stopMessage=k.msg;e(function(){g();j.loadSync()},3000,c)},error:function(k){j.stopMessage=k.msg;e(function(){g();j.loadSync()},3000,c)}},true)}}];var UtilsPartitionCtrl=["$scope","Module","Timeout","Request","Message","Backend",function(b,c,g,f,e,a){var d="utils.partition";c.init(d,"磁盘分区");b.loaded=false;b.waiting=true;b.loadDiskinfo=function(){f.get("/query/server.diskinfo",function(h){if(!b.loaded){b.loaded=true}b.diskinfo=h["server.diskinfo"];b.waiting=false})};b.swaponconfirm=function(h){b.devname=h;$("#swaponconfirm").modal()};b.swapon=function(){a.call(b,d,"/backend/swapon","/backend/swapon_on_"+b.devname,{devname:b.devname},{success:b.loadDiskinfo})};b.swapoffconfirm=function(h){b.devname=h;$("#swapoffconfirm").modal()};b.swapoff=function(){a.call(b,d,"/backend/swapoff","/backend/swapon_off_"+b.devname,{devname:b.devname},{success:b.loadDiskinfo})};b.umountconfirm=function(h){b.devname=h;$("#umountconfirm").modal()};b.umount=function(){a.call(b,d,"/backend/umount","/backend/mount_umount_"+b.devname,{devname:b.devname},{success:b.loadDiskinfo})};b.mountconfirm=function(i,h){b.devname=i;b.mountpoint="";b.fstype=h;f.get("/query/config.fstab("+i+")",function(j){if(j["config.fstab"]&&typeof(j["config.fstab"]["mount"])!="undefined"){b.mountpoint=j["config.fstab"]["mount"]}});$("#mountconfirm").modal()};b.selectmountpoint=function(h){b.selector_title="请选择挂载点";b.selector.onlydir=true;b.selector.onlyfile=false;b.selector.load(b.mountpoint?b.mountpoint:"/");b.selector.selecthandler=function(i){$("#selector").modal("hide");b.mountpoint=i};$("#selector").modal()};b.mount=function(){a.call(b,d,"/backend/mount","/backend/mount_mount_"+b.devname,{devname:b.devname,mountpoint:b.mountpoint,fstype:b.fstype},{success:b.loadDiskinfo})};b.formatconfirm=function(h){b.devname=h;f.get("/query/tool.supportfs",function(i){b.supportfs=i["tool.supportfs"]});$("#formatconfirm").modal()};b.format=function(){a.call(b,d,"/backend/format","/backend/format_"+b.devname,{devname:b.devname,fstype:b.fstype},{success:b.loadDiskinfo})};b.addpartconfirm=function(h,i){b.devname=h;b.unpartition=i;$("#addpartconfirm").modal()};b.addpart=function(){b.waiting=true;e.setInfo("正在 "+b.devname+" 上创建分区，请稍候...",true);f.post("/operation/fdisk",{action:"add",devname:b.devname,size:b.size,unit:b.unit},function(h){if(h.code==0){b.loadDiskinfo()}else{b.waiting=false}})};b.delpartconfirm=function(h){b.devname=h;$("#delpartconfirm").modal()};b.delpart=function(){b.waiting=true;e.setInfo("正在删除分区 "+b.devname+"，请稍候...",true);f.post("/operation/fdisk",{action:"delete",devname:b.devname},function(h){if(h.code==0){b.loadDiskinfo()}else{b.waiting=false}})};b.scanpartconfirm=function(h){b.devname=h;$("#scanpartconfirm").modal()};b.scanpart=function(){b.waiting=true;e.setInfo("正在扫描 "+b.devname+" 的分区，请稍候...",true);f.post("/operation/fdisk",{action:"scan",devname:b.devname},function(h){if(h.code==0){g(b.loadDiskinfo,1000,d)}else{b.waiting=false}})}}];var UtilsAutoFMCtrl=["$scope","Module","Timeout","Request","Message","Backend",function(b,c,g,f,e,a){var d="utils.autofm";c.init(d,"自动格式化挂载");b.loaded=false;b.waiting=true;b.diskcount=0;b.loadDiskinfo=function(){f.get("/query/server.diskinfo",function(j){if(!b.loaded){b.loaded=true}b.diskinfo=j["server.diskinfo"];b.waiting=false;b.diskcount=0;for(var h in j["server.diskinfo"]["partitions"]){var k=j["server.diskinfo"]["partitions"][h];if(k.is_hw&&!k.is_pv&&k.partcount==0&&!k.mount){b.diskcount++}}})};b.confirm=function(h){b.devname=h;b.mountpoint="";b.fstype="";f.post("/operation/file",{action:"listdir",path:"/data",showhidden:true,remember:false},function(l){if(l.code==0){var j=l.data;if(j.length==0){b.mountpoint="/data/0"}else{var m={};for(var k=0;k<j.length;k++){m[j[k].name]=true}var n=0;while(1){if(!m[""+n]){break}n++}b.mountpoint="/data/"+n}}else{f.post("/operation/file",{action:"createfolder",path:"/",name:"data"});b.mountpoint="/data/0"}},false,true);f.get("/query/tool.supportfs",function(l){var j=l["tool.supportfs"];for(var k=0;k<j.length;k++){if(j[k]=="swap"){j.splice(k,1)}if(j[k]=="xfs"){b.fstype="xfs"}else{if(j[k]=="ext4"){b.fstype="ext4"}else{if(j[k]=="ext3"){b.fstype="ext3"}}}}b.supportfs=j});$("#confirm").modal()};b.selectmountpoint=function(h){b.selector_title="请选择挂载点";b.selector.onlydir=true;b.selector.onlyfile=false;b.selector.load(b.mountpoint);b.selector.selecthandler=function(i){$("#selector").modal("hide");b.mountpoint=i};$("#selector").modal()};b.autofm=function(){f.post("/operation/file",{action:"listdir",path:b.mountpoint,showhidden:true,remember:false},function(l){if(l.code==0){var h=l.data;if(h.length>0){var o=false;for(var k=0;k<h.length;k++){if(h[k].name=="lost+found"){o=true;break}}if(o){e.setError("已有其它设备挂载在 "+b.mountpoint+" 下，请重新选择挂载点。")}else{e.setError("挂载点 "+b.mountpoint+" 下存在文件或目录，无法挂载！请重新选择挂载点。")}}else{b.format()}}else{var n=b.mountpoint.split("/");var j=n.pop();var m=n.join("/");f.post("/operation/file",{action:"createfolder",path:m,name:j},b.format)}},false,true)};b.mount=function(){a.call(b,d,"/backend/mount","/backend/mount_mount_"+b.devname,{devname:b.devname,mountpoint:b.mountpoint,fstype:b.fstype},{success:b.loadDiskinfo})};b.format=function(){a.call(b,d,"/backend/format","/backend/format_"+b.devname,{devname:b.devname,fstype:b.fstype},{success:b.mount})}}];var UtilsMoveDataCtrl=["$scope","Module","Timeout","Request","Message","Backend",function(b,c,g,f,e,a){var d="utils.movedata";c.init(d,"数据移至数据盘");b.loaded=false;b.waiting=true;b.srcpath="/var";b.despath="/";b.mountpoint="/";b.loadMounts=function(){f.get("/query/server.mounts",function(h){if(!b.loaded){b.loaded=true}b.mounts=h["server.mounts"];b.waiting=false})};b.setdespath=function(h){b.despath=h};b.selectsrcpath=function(h){b.selector_title="请选择要迁移的目录（原始目录）";b.selector.onlydir=true;b.selector.onlyfile=false;b.selector.load(b.srcpath);b.selector.selecthandler=function(i){$("#selector").modal("hide");b.srcpath=i};$("#selector").modal()};b.selectdespath=function(h){b.selector_title="请选择要迁移到的目录（目标目录）";b.selector.onlydir=true;b.selector.onlyfile=false;b.selector.load(b.despath);b.selector.selecthandler=function(i){$("#selector").modal("hide");b.despath=i};$("#selector").modal()};b.movedata=function(){b.waiting=true;var i=b.srcpath.replace(/\/$/,"");var j=i.split("/").pop();var h=b.despath.replace(/\/$/,"")+"/"+j;if(h==i){e.setError("路径没有改变，无须迁移！");b.waiting=false;return}e.setInfo("正在检测，请稍候...",true);f.post("/operation/file",{action:"getitem",path:i},function(k){if(k.code==0){if(!k.data.isdir){e.setError(b.srcpath+" 不是有效的目录！（可能是文件或链接）");b.waiting=false;return}f.post("/operation/file",{action:"getitem",path:h},function(l){if(l.code==0){e.setError("目标目录下已有同名文件或目录 "+h+"，迁移失败！");b.waiting=false}else{a.call(b,d,"/backend/move","/backend/move_"+i+"_"+h,{srcpath:i,despath:h},{success:function(m){e.setInfo("正在原始目录创建链接...");f.post("/operation/file",{action:"link",srcpath:h,despath:i},function(n){if(n.code==0){e.setSuccess("迁移完成！")}else{e.setError("迁移失败！"+n.msg)}b.waiting=false},false,true)},error:function(m){e.setError("迁移过程中发生错误，迁移失败！");b.waiting=false}})}},false,true)}})}}];var DatabaseCtrl=["$scope","Module","$rootScope","Request","Message","Backend",function(c,d,a,g,f,b){var e="database";d.init(e,"数据库管理");c.loaded=false;var h=d.getSection();c.has_dbserver=false;c.mysql_supported=false;c.load=function(){g.get("/query/service.mysqld",function(i){if(i["service.mysqld"]&&i["service.mysqld"].status){c.mysql_supported=true}c.has_dbserver=c.mysql_supported;if(c.has_dbserver){if(h){if(h=="mysqld"&&c.mysql_supported){d.setSection("mysqld")}else{d.setSection(c.mysql_supported?"mysql":"mysql")}}else{d.setSection(c.mysql_supported?"mysql":"mysql")}}c.loaded=true})};c.validate_password=function(){c.processing=true;g.post("/operation/mysql",{action:"checkpwd",password:a.$mysql.password},function(i){if(i.code==0){a.$mysql.password_validated=true;c.loaddbs();c.loadusers()}c.processing=false})};c.dbloading=true;c.loaddbs=function(){c.dbloading=true;b.call(c,e,"/backend/mysql_databases","/backend/mysql_databases",{password:a.$mysql.password},{success:function(i){c.dbs=i.data;c.dbloading=false},error:function(){c.dbloading=false}})};c.userloading=true;c.loadusers=function(){c.userloading=true;b.call(c,e,"/backend/mysql_users","/backend/mysql_users",{password:a.$mysql.password},{success:function(i){c.users=i.data;c.userloading=false},error:function(){c.userloading=false}})};if(a.$mysql.password_validated){c.loaddbs();c.loadusers()}}];var DatabaseMySQLNewDBCtrl=["$scope","Module","$rootScope","$location","Request","Message","Backend",function(c,d,a,h,g,f,b){var e="database.mysql.db.new";d.init(e,"新建数据库");c.loaded=true;c.collation="utf8_general_ci";c.validate_password=function(){c.processing=true;g.post("/operation/mysql",{action:"checkpwd",password:a.$mysql.password},function(i){if(i.code==0){a.$mysql.password_validated=true}c.processing=false})};c.newdb=function(){c.processing=true;b.call(c,e,"/backend/mysql_create","/backend/mysql_create_"+c.dbname,{password:a.$mysql.password,dbname:c.dbname,collation:c.collation},{success:function(i){h.path("/database/mysql/db/edit/"+encodeURIComponent(c.dbname));c.processing=false},error:function(){c.processing=false}})}}];var DatabaseMySQLEditDBCtrl=["$scope","Module","$rootScope","$routeParams","$location","Request","Message","Backend",function(j,d,g,i,e,a,f,c){var h=i.section;j.dbname=decodeURIComponent(h);var b="database.mysql.db.edit";d.init(b,"管理数据库 "+j.dbname);d.initSection("users");j.loaded=true;j.validate_password=function(){j.processing=true;a.post("/operation/mysql",{action:"checkpwd",password:g.$mysql.password},function(k){if(k.code==0){g.$mysql.password_validated=true;j.loaddbinfo()}j.processing=false})};j.dbloading=true;j.loaddbinfo=function(){j.dbloading=true;c.call(j,b,"/backend/mysql_dbinfo","/backend/mysql_dbinfo_"+j.dbname,{password:g.$mysql.password,dbname:j.dbname},{success:function(k){j.dbinfo=k.data;j.dbloading=false;j.loadusers()},error:function(){j.dbloading=false}})};j.userloading=true;j.loadusers=function(){j.userloading=true;c.call(j,b,"/backend/mysql_users","/backend/mysql_users_"+j.dbname,{password:g.$mysql.password,dbname:j.dbname},{success:function(k){j.users=k.data;j.userloading=false},error:function(){j.userloading=false}})};j.setcollation=function(){j.processing=true;a.post("/operation/mysql",{action:"alter_database",password:g.$mysql.password,dbname:j.dbname,collation:j.dbinfo.collation},function(){j.processing=false})};j.rename=function(){j.processing=true;c.call(j,b,"/backend/mysql_rename","/backend/mysql_rename_"+j.dbname,{password:g.$mysql.password,dbname:j.dbname,newname:j.dbinfo.name},{success:function(k){e.path("/database/mysql/db/edit/"+encodeURIComponent(j.dbinfo.name));j.processing=false},error:function(){j.processing=false}})};j.selectexportfolder=function(){j.selector.onlydir=true;j.selector.onlyfile=false;j.selector.load(j.exportpath?j.exportpath:"/root");j.selector.selecthandler=function(k){$("#selector").modal("hide");j.exportpath=k};$("#selector").modal()};j.exportdb=function(){j.processing=true;c.call(j,b,"/backend/mysql_export","/backend/mysql_export_"+j.dbname,{password:g.$mysql.password,dbname:j.dbname,path:j.exportpath},function(k){j.processing=false})};j.dropdb=function(){j.processing=true;c.call(j,b,"/backend/mysql_drop","/backend/mysql_drop_"+j.dbname,{password:g.$mysql.password,dbname:j.dbname},function(k){if(k.code==0){e.path("/database");e.search("s","mysql")}j.processing=false})};if(g.$mysql.password_validated){j.loaddbinfo()}}];var DatabaseMySQLNewUserCtrl=["$scope","Module","$rootScope","$location","Request","Message","Backend",function(c,d,a,h,g,f,b){var e="database.mysql.user.new";d.init(e,"添加新用户");c.loaded=true;c.dbname=d.getParam("dbname");c.validate_password=function(){c.processing=true;g.post("/operation/mysql",{action:"checkpwd",password:a.$mysql.password},function(i){if(i.code==0){a.$mysql.password_validated=true}c.processing=false})};c.newuser=function(){if(!c.emptypassword){if(c.password!=c.passwordc){f.setError("新密码和确认密码不一致！");return}}var i=c.user+"@"+c.host;c.processing=true;b.call(c,e,"/backend/mysql_createuser","/backend/mysql_createuser_"+i,{password:a.$mysql.password,user:c.user,host:c.host,pwd:c.emptypassword?"":c.password},{success:function(j){h.path("/database/mysql/user/edit/"+encodeURIComponent(i));if(c.dbname){h.search("dbname",c.dbname)}c.processing=false},error:function(){c.processing=false}})};c.genpassword=function(){var n="ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";var p=16;var m="";var j=0;var o=0;for(var l=0;l<p;l++){if((Math.floor(Math.random()*2)==0)&&o<3||j>=5){var k=Math.floor(Math.random()*10);m+=k;o+=1}else{var k=Math.floor(Math.random()*n.length);m+=n.substring(k,k+1);j+=1}}c.randpassword=c.password=c.passwordc=m}}];var DatabaseMySQLEditUserCtrl=["$scope","Module","$rootScope","$routeParams","$location","Request","Message","Backend",function(l,d,i,k,e,a,g,c){var j=k.section;l.username=decodeURIComponent(j);var f=l.username.split("@");l.user=f[0];l.host=f[1];var b="database.mysql.user.edit";d.init(b,"管理用户 "+l.username);d.initSection("privs");l.loaded=true;l.validate_password=function(){l.processing=true;a.post("/operation/mysql",{action:"checkpwd",password:i.$mysql.password},function(m){if(m.code==0){i.$mysql.password_validated=true;l.loadprivs();l.loaddbs()}l.processing=false})};l.privsloading=true;l.loadprivs=function(){l.privsloading=true;c.call(l,b,"/backend/mysql_userprivs","/backend/mysql_userprivs_"+l.username,{password:i.$mysql.password,username:l.username},{success:function(m){l.privs=m.data;l.privsloading=false;var n=d.getParam("dbname");var o=d.getParam("privtype");if(n){l.privs_dbname=n;l.editprivs(false,o)}},error:function(){l.privsloading=false}})};l.$watch("selectall",function(m){angular.forEach(l.curprivs,function(n,o){if(o.indexOf("_priv")>0){l.curprivs[o]=m?"Y":"N"}})});var h={Select_priv:"N",Insert_priv:"N",Update_priv:"N",Delete_priv:"N",Create_priv:"N",Alter_priv:"N",Index_priv:"N",Drop_priv:"N",Create_tmp_table_priv:"N",Show_view_priv:"N",Create_routine_priv:"N",Alter_routine_priv:"N",Execute_priv:"N",Create_view_priv:"N",Event_priv:"N",Trigger_priv:"N",Grant_priv:"N",Lock_tables_priv:"N",References_priv:"N"};l.editprivs=function(o,p){if(p=="global"){l.orgprivs=l.privs.global;l.curprivs=angular.copy(l.privs.global)}else{if(!o){if(!l.privs_dbname){return}var n=false;for(var m=0;m<l.privs.bydb.length;m++){if(l.privs.bydb[m].Db==l.privs_dbname){l.orgprivs=l.privs.bydb[m];l.curprivs=angular.copy(l.privs.bydb[m]);n=true;break}}if(!n){l.orgprivs=null;l.curprivs=angular.copy(h);l.curprivs.Db=l.privs_dbname;l.curprivs.flag="new"}}else{l.orgprivs=o;l.curprivs=angular.copy(o)}}if(!l.curprivs.Db){l.privsedit_title="设置 "+l.username+" 的全局权限"}else{l.privsedit_title="设置 "+l.username+" 在数据库 "+l.curprivs.Db+" 的权限"}$("#privsedit").modal()};l.updateprivs=function(){c.call(l,b,"/backend/mysql_updateuserprivs","/backend/mysql_updateuserprivs_"+encodeURIComponent(l.username+(l.curprivs.Db?"_"+l.curprivs.Db:"")),{password:i.$mysql.password,username:l.username,privs:angular.toJson(l.curprivs),dbname:l.curprivs.Db},{success:function(m){if(l.curprivs.flag=="new"){l.privs.bydb.push(l.curprivs)}else{angular.copy(l.curprivs,l.orgprivs)}var n=d.getParam("dbname");if(n){e.path("/database/mysql/db/edit/"+encodeURIComponent(n))}}})};l.loaddbs=function(){l.dbloading=true;c.call(l,b,"/backend/mysql_databases","/backend/mysql_databases",{password:i.$mysql.password},{success:function(m){l.dbs=m.data}},true)};l.setpassword=function(){if(!l.emptypassword){if(l.newpassword!=l.newpasswordc){g.setError("新密码和确认密码不一致！");return}}l.processing=true;c.call(l,b,"/backend/mysql_setuserpassword","/backend/mysql_setuserpassword_"+l.username,{password:i.$mysql.password,username:l.username,pwd:l.emptypassword?"":l.newpassword},{success:function(m){l.processing=false;if(l.username=="root@localhost"){i.$mysql={password:"",password_validated:false}}},error:function(){l.processing=false}})};l.dropuser=function(){l.processing=true;c.call(l,b,"/backend/mysql_dropuser","/backend/mysql_dropuser_"+l.username,{password:i.$mysql.password,username:l.username},function(m){if(m.code==0){e.path("/database");e.search("s","mysql")}l.processing=false})};if(i.$mysql.password_validated){l.loadprivs();l.loaddbs()}}];var ServiceCtrl=["$scope","$routeParams","Module","Timeout","Request","Backend",function(b,h,c,f,e,a){var d="service";c.init(d,"服务管理");c.initSection("http");b.scope=b;b.info=null;b.loaded=false;b.waiting=true;b.loadInfo=function(){e.get("/query/server.virt,service.**",function(i){if(!b.loaded){b.loaded=true}if(b.info==null){b.info=i}else{deepUpdate(b.info,i)}b.waiting=false})};b.toggleAutostart=function(j,i){var k=b.info["service."+i]["autostart"];e.post("/operation/chkconfig",{name:j,service:i,autostart:!k},function(l){b.loadInfo()})};var g=function(i){return function(k,j){a.call(b,d,"/backend/service_"+i,"/backend/service_"+i+"_"+j,{name:k,service:j},b.loadInfo)}};b.start=g("start");b.stop=g("stop");b.restart=g("restart")}];var ServiceNginxCtrl=["$scope","$routeParams","Module","Request",function(a,e,b,d){var c="service.nginx";b.init(c,"Nginx");b.initSection("base");a.scope=a;a.info=null;a.loaded=false;a.installed=false;a.waiting=true;a.checking=false;a.checkInstalled=function(){a.checking=true;d.get("/query/service.nginx",function(g){var h=g["service.nginx"];if(h){a.installed=true;a.autostart=h.autostart;a.status=h.status;if(a.checkVersion){a.checkVersion()}a.getsettings();a.getcachesettings()}else{a.installed=false}a.loaded=true;a.waiting=false;a.checking=false});d.get("/client/ip",function(g){a.ip=g})};a.setting={limit_rate:"",limit_conn:"",limit_conn_zone:"",client_max_body_size:"",keepalive_timeout:"",access_status:"off",allow:"",deny:"",gzip:""};a.getsettings=function(){if(!a.installed){return}d.post("/operation/nginx",{action:"gethttpsettings",items:"limit_rate,limit_conn,limit_conn_zone,client_max_body_size,keepalive_timeout,allow[],deny[],gzip"},function(h){if(h.code==0){a.setting=h.data;var g=a.setting;if(g.allow&&g.allow.length>0){g.access_status="white"}else{if(g.deny&&g.deny.length>0){g.access_status="black"}else{g.access_status="off"}}if(g.allow){g.allow=g.allow.join("\n")}if(g.deny){g.deny=g.deny.join("\n")}}},false,true)};a.savesettings=function(){var g=angular.copy(a.setting);g.action="sethttpsettings";g.version=a.pkginfo.version;d.post("/operation/nginx",g,function(h){if(h.code==0){a.getsettings()}})};var f={name:"newcache",mem:"10",path:"/var/www/cache",path_level_1:"1",path_level_2:"2",path_level_3:"0",inactive:"10",inactive_unit:"m",max_size:"100",max_size_unit:"m",autocreate:true};a.proxy_caches=[];a.curcache=-1;a.setcache=function(g){a.curcache=g};a.getcachesettings=function(){if(!a.installed){return}d.post("/operation/nginx",{action:"gethttpsettings",items:"proxy_cache_path[]"},function(h){if(h.code==0){a.proxy_caches=[];var k=h.data.proxy_cache_path;if(k){for(var g=0;g<k.length;g++){var j=angular.copy(f);angular.extend(j,k[g]);a.proxy_caches.push(j)}a.curcache=0}}},false,true)};a.deletecache=function(g){a.proxy_caches.splice(g,1);a.curcache--;if(a.curcache<0&&a.proxy_caches.length>0){a.curcache=0}};a.addcache=function(){var g=a.proxy_caches;g.splice(a.curcache+1,0,angular.copy(f));a.curcache++};a.selectcachefolder=function(g){a.selector_title="请选择缓存目录";a.selector.onlydir=true;a.selector.onlyfile=false;a.selector.load(a.proxy_caches[g].path);a.selector.selecthandler=function(h){$("#selector").modal("hide");a.proxy_caches[g].path=h};$("#selector").modal()};a.savecaches=function(){var g={action:"setproxycachesettings",proxy_caches:angular.toJson(a.proxy_caches)};d.post("/operation/nginx",g,function(h){if(h.code==0){a.getcachesettings()}})}}];var ServiceApacheCtrl=["$scope","$routeParams","Module","Request",function(a,e,b,d){var c="service.apache";b.init(c,"Apache");b.initSection("base");a.scope=a;a.info=null;a.loaded=false;a.installed=false;a.waiting=true;a.checking=false;a.checkInstalled=function(){a.checking=true;d.get("/query/service.httpd",function(f){var g=f["service.httpd"];if(g){a.installed=true;a.autostart=g.autostart;a.status=g.status;if(a.checkVersion){a.checkVersion()}}else{a.installed=false}a.loaded=true;a.waiting=false;a.checking=false})}}];var ServiceVsftpdCtrl=["$scope","$routeParams","Module","Request",function(a,e,b,d){var c="service.vsftpd";b.init(c,"vsftpd");b.initSection("base");a.scope=a;a.info=null;a.loaded=false;a.installed=false;a.waiting=true;a.checking=false;a.checkInstalled=function(){a.checking=true;d.get("/query/service.vsftpd",function(f){var g=f["service.vsftpd"];if(g){a.installed=true;a.autostart=g.autostart;a.status=g.status;if(a.checkVersion){a.checkVersion()}}else{a.installed=false}a.loaded=true;a.waiting=false;a.checking=false})}}];var ServiceMySQLCtrl=["$scope","$rootScope","$routeParams","Module","Message","Request","Backend",function(c,a,h,d,g,f,b){var e="service.mysqld";d.init(e,"MySQL");d.initSection("base");c.scope=c;c.info=null;c.loaded=false;c.installed=false;c.waiting=true;c.checking=false;c.processing=false;c.checkInstalled=function(){c.checking=true;f.get("/query/service.mysqld",function(i){var j=i["service.mysqld"];if(j){c.installed=true;c.autostart=j.autostart;c.status=j.status;if(c.checkVersion){c.checkVersion()}}else{c.installed=false}c.loaded=true;c.waiting=false;c.checking=false})};c.updatepwd=function(){if(c.status!="running"){g.setError("MySQL还未启动，无法修改密码！");return}c.processing=true;f.post("/operation/mysql",{action:"updatepwd",newpassword:c.root_passwd,newpasswordc:c.root_passwdc,password:c.root_opasswd},function(i){if(i.code==0){c.root_passwd="";c.root_passwdc="";c.root_opasswd="";a.$mysql={password:"",password_validated:false}}c.processing=false})};c.fupdatepwd=function(){c.processing=true;b.call(c,e,"/backend/mysql_fupdatepwd","/backend/mysql_fupdatepwd",{password:c.root_passwd,passwordc:c.root_passwdc},function(i){if(i.code==0){c.root_passwd="";c.root_passwdc="";a.$mysql={password:"",password_validated:false}}c.processing=false})}}];var ServiceRedisCtrl=["$scope","$routeParams","Module","Request",function(a,e,b,d){var c="service.redis";b.init(c,"Redis");b.initSection("base");a.scope=a;a.info=null;a.loaded=false;a.installed=false;a.waiting=true;a.checking=false;a.checkInstalled=function(){a.checking=true;d.get("/query/service.redis",function(f){var g=f["service.redis"];if(g){a.installed=true;a.autostart=g.autostart;a.status=g.status;if(a.checkVersion){a.checkVersion()}}else{a.installed=false}a.loaded=true;a.waiting=false;a.checking=false})}}];var ServiceMemcacheCtrl=["$scope","$routeParams","Module","Request",function(a,e,b,d){var c="service.memcache";b.init(c,"Memcache");b.initSection("base");a.scope=a;a.info=null;a.loaded=false;a.installed=false;a.waiting=true;a.checking=false;a.checkInstalled=function(){a.checking=true;d.get("/query/service.memcached",function(f){var g=f["service.memcached"];if(g){a.installed=true;a.autostart=g.autostart;a.status=g.status;if(a.checkVersion){a.checkVersion()}}else{a.installed=false}a.loaded=true;a.waiting=false;a.checking=false})}}];var ServiceMongoDBCtrl=["$scope","$routeParams","Module","Request",function(a,e,b,d){var c="service.mongodb";b.init(c,"MongoDB");b.initSection("base");a.scope=a;a.info=null;a.loaded=false;a.installed=false;a.waiting=true;a.checking=false;a.checkInstalled=function(){a.checking=true;d.get("/query/service.mongod",function(f){var g=f["service.mongod"];if(g){a.installed=true;a.autostart=g.autostart;a.status=g.status;if(a.checkVersion){a.checkVersion()}}else{a.installed=false}a.loaded=true;a.waiting=false;a.checking=false})}}];var ServicePHPCtrl=["$scope","$routeParams","Module","Request",function(a,e,b,d){var c="service.php";b.init(c,"PHP");b.initSection("base");a.scope=a;a.info=null;a.loaded=false;a.installed=false;a.waiting=true;a.checking=false;a.checkInstalled=function(){a.checking=true;d.get("/query/service.php-fpm",function(g){var h=g["service.php-fpm"];if(h){a.installed=true;a.autostart=h.autostart;a.status=h.status;if(a.checkVersion){a.checkVersion()}a.getphpsettings();a.getfpmsettings()}else{a.installed=false}a.loaded=true;a.waiting=false;a.checking=false})};a.setting={php:{short_open_tag:false,expose_php:false,max_execution_time:"",memory_limit:"",display_errors:false,post_max_size:"",upload_max_filesize:"","date.timezone":""},fpm:{listen:"",pm:false,"pm.max_children":"","pm.start_servers":"","pm.min_spare_servers":"","pm.max_spare_servers":"","pm.max_requests":"",request_terminate_timeout:"",request_slowlog_timeout:""}};var f=function(g){g=parseInt(g);if(isNaN(g)){g=""}else{g+=""}return g};a.getphpsettings=function(){if(!a.installed){return}d.post("/operation/php",{action:"getphpsettings"},function(h){if(h.code==0){var g=h.data;var i=a.setting.php;i.short_open_tag=(g.short_open_tag&&g.short_open_tag.toLowerCase()=="on");i.expose_php=(g.expose_php&&g.expose_php.toLowerCase()=="on");i.max_execution_time=g.max_execution_time?g.max_execution_time:"";i.memory_limit=g.memory_limit?f(g.memory_limit):"";i.display_errors=(g.display_errors&&g.display_errors.toLowerCase()=="on");i.post_max_size=g.post_max_size?f(g.post_max_size):"";i.upload_max_filesize=g.upload_max_filesize?f(g.upload_max_filesize):"";i["date.timezone"]=g["date.timezone"]?g["date.timezone"]:""}},false,true)};a.getfpmsettings=function(){if(!a.installed){return}d.post("/operation/php",{action:"getfpmsettings"},function(h){if(h.code==0){var g=h.data;var i=a.setting.fpm;i.listen=g.listen?g.listen:"";i.pm=(g.pm&&g.pm.toLowerCase()=="dynamic");i["pm.max_children"]=g["pm.max_children"]?f(g["pm.max_children"]):"";i["pm.start_servers"]=g["pm.start_servers"]?f(g["pm.start_servers"]):"";i["pm.min_spare_servers"]=g["pm.min_spare_servers"]?f(g["pm.min_spare_servers"]):"";i["pm.max_spare_servers"]=g["pm.max_spare_servers"]?f(g["pm.max_spare_servers"]):"";i["pm.max_requests"]=g["pm.max_requests"]?f(g["pm.max_requests"]):"";i.request_terminate_timeout=g.request_terminate_timeout?f(g.request_terminate_timeout):"";i.request_slowlog_timeout=g.request_slowlog_timeout?f(g.request_slowlog_timeout):""}},false,true)};a.updatephpsettings=function(){var g=angular.copy(a.setting.php);g.action="updatephpsettings";d.post("/operation/php",g,a.getphpsettings)};a.updatefpmsettings=function(){var g=angular.copy(a.setting.fpm);g.action="updatefpmsettings";d.post("/operation/php",g,a.getfpmsettings)}}];var ServiceSendmailCtrl=["$scope","$routeParams","Module","Request",function(a,e,b,d){var c="service.sendmail";b.init(c,"Sendmail");b.initSection("base");a.scope=a;a.info=null;a.loaded=false;a.installed=false;a.waiting=true;a.checking=false;a.checkInstalled=function(){a.checking=true;d.get("/query/service.sendmail",function(f){var g=f["service.sendmail"];if(g){a.installed=true;a.autostart=g.autostart;a.status=g.status;if(a.checkVersion){a.checkVersion()}}else{a.installed=false}a.loaded=true;a.waiting=false;a.checking=false})}}];var ServiceSSHCtrl=["$scope","$routeParams","Module","Request","Backend","Message",function(b,g,c,f,a,e){var d="service.ssh";c.init(d,"SSH");c.initSection("base");b.scope=b;b.info=null;b.loaded=false;b.installed=false;b.waiting=true;b.checking=false;b.checkInstalled=function(){b.checking=true;f.get("/query/service.sshd",function(h){var i=h["service.sshd"];if(i){b.installed=true;b.autostart=i.autostart;b.status=i.status;b.getsettings();if(b.checkVersion){b.checkVersion()}}else{b.installed=false}b.loaded=true;b.waiting=false;b.checking=false})};b.setting={};b.getsettings=function(){if(!b.installed){return}f.post("/operation/ssh",{action:"getsettings"},function(h){if(h.code==0){b.setting=h.data;b.setting.disable_pwdauth=!b.setting.enable_pwdauth}},false,true)};b.savesettings=function(){var h={};h.action="savesettings";h.port=b.setting.port;h.enable_pwdauth=b.setting.enable_pwdauth;h.enable_sftp=b.setting.enable_sftp;f.post("/operation/ssh",h,function(i){if(i.code==0){b.getsettings()}})};b.savepksettings=function(){var h={};h.action="savesettings";h.pubkey=b.setting.pubkey;h.enable_pubkauth=b.setting.enable_pubkauth;h.enable_pwdauth=!b.setting.disable_pwdauth;f.post("/operation/ssh",h,function(i){if(i.code==0){b.getsettings()}})};b.gensshkey=function(){if(b.setting.pubkey||b.setting.prvkey){b.confirm_title="重新生成公钥/私钥对";b.confirm_body="公钥/私钥已存在，是否覆盖原文件？";$("#confirm").modal();b.confirm=b.dogenkey;return}b.dogenkey()};b.dogenkey=function(){a.call(b,d,"/backend/ssh_genkey","/backend/ssh_genkey",{},{success:function(h){b.getsettings()}})};b.chpasswd=function(){$("#chpasswd").modal()};b.dochpasswd=function(){if(b.newpassword!=b.newpasswordc){e.setError("新密码和确认密码不一致！");return}a.call(b,d,"/backend/ssh_chpasswd","/backend/ssh_chpasswd",{path:b.setting.prvkey,oldpassword:b.oldpassword,newpassword:b.newpassword},{success:function(h){b.oldpassword=b.newpassword=b.newpasswordc=""}})}}];var ServiceIPTablesCtrl=["$scope","$routeParams","Module","Request",function(a,e,b,d){var c="service.iptables";b.init(c,"IPTables");b.initSection("base");a.scope=a;a.info=null;a.loaded=false;a.installed=false;a.waiting=true;a.checking=false;a.checkInstalled=function(){a.checking=true;d.get("/query/service.iptables",function(f){var g=f["service.iptables"];if(g){a.installed=true;a.autostart=g.autostart;a.status=g.status;if(a.checkVersion){a.checkVersion()}}else{a.installed=false}a.loaded=true;a.waiting=false;a.checking=false})}}];var ServiceCronCtrl=["$scope","$routeParams","Module","Request",function(a,e,b,d){var c="service.cron";b.init(c,"Cron");b.initSection("base");a.scope=a;a.info=null;a.loaded=false;a.installed=false;a.waiting=true;a.checking=false;a.checkInstalled=function(){a.checking=true;d.get("/query/service.crond",function(f){var g=f["service.crond"];if(g){a.installed=true;a.autostart=g.autostart;a.status=g.status;if(a.checkVersion){a.checkVersion()}}else{a.installed=false}a.loaded=true;a.waiting=false;a.checking=false})}}];var ServiceNTPCtrl=["$scope","$routeParams","Module","Request",function(a,e,b,d){var c="service.ntp";b.init(c,"NTP");b.initSection("base");a.scope=a;a.info=null;a.loaded=false;a.installed=false;a.waiting=true;a.checking=false;a.checkInstalled=function(){a.checking=true;d.get("/query/service.ntpd",function(f){var g=f["service.ntpd"];if(g){a.installed=true;a.autostart=g.autostart;a.status=g.status;if(a.checkVersion){a.checkVersion()}}else{a.installed=false}a.loaded=true;a.waiting=false;a.checking=false})}}];