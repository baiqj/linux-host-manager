var UtilsCtrl=["$scope","Module","Request",function(a,b,d){var c="utils";b.init(c,"系统工具");a.loaded=true;a.rebootconfirm=function(){$("#rebootconfirm").modal()};a.reboot=function(){d.post("/operation/reboot")}}];var UtilsUserCtrl=["$scope","$routeParams","Module","Timeout","Request",function(a,f,b,e,d){var c="utils.user";b.init(c,"用户管理");b.initSection("user");a.loaded=true;a.loadUsers=function(){d.post("/operation/user",{action:"listuser"},function(g){if(g.code==0){a.users=g.data}},false,true)};a.loadGroups=function(){d.post("/operation/user",{action:"listgroup"},function(g){if(g.code==0){a.groups=g.data}},false,true)};a.useraddconfirm=function(){a.curuser={pw_name:"",pw_gecos:"",pw_gname:"",pw_shell:"/bin/bash",pw_passwd:"",pw_passwdc:"",createhome:true,lock:false};$("#useraddconfirm").modal()};a.useradd=function(){var g=a.curuser;g.action="useradd";d.post("/operation/user",g,function(h){if(h.code==0){a.loadUsers();a.loadGroups()}})};a.usermodconfirm=function(h){var g=a.users[h];a.curuser={pw_name:g.pw_name,pw_gecos:g.pw_gecos,pw_gname:g.pw_gname,pw_dir:g.pw_dir,pw_shell:g.pw_shell,pw_passwd:"",pw_passwdc:"",lock:g.lock};$("#usermodconfirm").modal()};a.usermod=function(){var g=a.curuser;g.action="usermod";d.post("/operation/user",g,function(h){if(h.code==0){a.loadUsers();a.loadGroups()}})};a.userdelconfirm=function(h){var g=a.users[h];a.curuser={pw_name:g.pw_name};$("#userdelconfirm").modal()};a.userdel=function(){d.post("/operation/user",{action:"userdel",pw_name:a.curuser.pw_name},function(g){if(g.code==0){a.loadUsers();a.loadGroups()}})};a.groupaddconfirm=function(){a.curgrp_name="";$("#groupaddconfirm").modal()};a.groupadd=function(){d.post("/operation/user",{action:"groupadd",gr_name:a.curgrp_name},function(g){if(g.code==0){a.loadGroups()}})};a.groupmodconfirm=function(g){a.curgrp_newname=a.curgrp_name=a.groups[g].gr_name;$("#groupmodconfirm").modal()};a.groupmod=function(){d.post("/operation/user",{action:"groupmod",gr_name:a.curgrp_name,gr_newname:a.curgrp_newname},function(g){if(g.code==0){a.loadGroups()}})};a.groupdelconfirm=function(g){a.curgrp_name=a.groups[g].gr_name;$("#groupdelconfirm").modal()};a.groupdel=function(){d.post("/operation/user",{action:"groupdel",gr_name:a.curgrp_name},function(g){if(g.code==0){a.loadGroups()}})};a.groupmemsaddconfirm=function(g){a.curgrp_name=a.groups[g].gr_name;a.curgrp_mem="";$("#groupmemsaddconfirm").modal()};a.groupmemsadd=function(){d.post("/operation/user",{action:"groupmems_add",gr_name:a.curgrp_name,mem:a.curgrp_mem},function(g){if(g.code==0){a.loadUsers();a.loadGroups()}})};a.groupmemsdelconfirm=function(g){a.curgrp_name=a.groups[g].gr_name;a.curgrp_mems=a.groups[g].gr_mem;a.curgrp_mem="";$("#groupmemsdelconfirm").modal()};a.groupmemsdel=function(){d.post("/operation/user",{action:"groupmems_del",gr_name:a.curgrp_name,mem:a.curgrp_mem},function(g){if(g.code==0){a.loadUsers();a.loadGroups()}})}}];var UtilsNetworkCtrl=["$scope","$routeParams","Module","Timeout","Message","Request",function(a,g,b,f,e,d){var c="utils.network";b.init(c,"网络设置");b.initSection("ip");a.restartMessage="是否要重启网络？";a.loaded=true;a.showRestartBtn=true;a.loadIfNames=function(){d.get("/utils/network/ifnames",function(h){a.ifnames=h.ifnames;a.ifname=a.ifnames[0];a.loadIfConfig(a.ifname)})};a.loadIfConfig=function(h){a.ifname=h;d.get("/utils/network/ifconfig/"+h,function(i){a.ip=i.ip;a.mask=i.mask;a.gw=i.gw})};a.saveIfConfig=function(){d.post("/utils/network/ifconfig/"+a.ifname,{ip:a.ip,mask:a.mask,gw:a.gw},function(h){if(h.code==0){a.loadIfConfig(a.ifname)}})};a.loadNameservers=function(){d.get("/utils/network/nameservers",function(h){a.nameservers=h.nameservers})};a.saveNameservers=function(){var h=[];$(".nameserver").each(function(){var i=$(this).val();if(i){h.push(i)}});d.post("/utils/network/nameservers",{nameservers:h.join(",")},function(i){if(i.code==0){a.loadNameservers()}})};a.addNameserver=function(){a.nameservers.push("")};a.delNameserver=function(h){a.nameservers.splice(h,1)};a.restart=function(){a.restartMessage="正在重启，请稍候...";a.showRestartBtn=false;f(function(){d.post("/backend/service_restart",{service:"network"},function(i){var h=function(){d.get("backend/service_restart_network",function(j){if(j.msg){a.restartMessage=j.msg}if(j.status=="finish"){e.setSuccess("");f(function(){a.restartMessage="是否要重启网络？";a.showRestartBtn=true},3000,c)}else{f(h,500,c)}})};f(h,500,c)})},1000,c)}}];var UtilsTimeCtrl=["$scope","$routeParams","Module","Timeout","Request","Backend",function(j,h,f,e,a,d){var c="utils.time";f.init(c,"时间设置");f.initSection("datetime");j.loaded=true;j.loadDatetime=function(){a.get("/utils/time/datetime",function(k){j.datetime=k;j.newDatetime=k.str})};j.saveDatetime=function(){a.post("/backend/datetime",{datetime:j.newDatetime},function(k){a.setProcessing(true);var l=function(){a.get("backend/datetime",function(m){if(m.status!="finish"){a.setProcessing(true);e(l,500,c)}})};e(l,500,c)})};j.loadTimezone=function(){a.get("/utils/time/timezone",function(l){var k=l.timezone;j.timezone=k?k:"时区不可识别";if(k){var m=k.split("/");j.timezone_region=m[0];j.timezone_city=m[1]}else{j.timezone_region="Asia";j.timezone_city="Shanghai"}})};j.loadTimezones=function(k,l){if(k){a.get("/utils/time/timezone_list/"+k,function(m){j.cities=m.cities;if(l){l.call()}})}else{a.get("/utils/time/timezone_list",function(n){j.regions=n.regions;var m=function(){a.get("/utils/time/timezone_list/"+j.timezone_region,function(o){j.cities=o.cities})};if(j.timezone_region){m()}else{e(m,500,c)}})}};j.setTimezone=function(k,l){j.timezone_region=k;j.loadTimezones(k,function(){j.timezone_city=l})};j.saveTimezone=function(){var k=j.timezone_region;var l=j.timezone_city;a.post("/utils/time/timezone",{timezone:k+"/"+l},function(m){if(m.code==0){j.loadTimezone();j.loadDatetime()}})};j.synctime=function(){var k="pool.ntp.org";a.post("/backend/ntpdate",{server:k},function(l){a.setProcessing(true);var m=function(){a.get("backend/ntpdate_"+k,function(n){if(n.status!="finish"){a.setProcessing(true);e(m,500,c)}else{j.loadDatetime()}})};e(m,500,c)})};j.ntpdChecking=true;var b=function(){j.installMessage="时间同步需要使用 NTP 服务，您当前尚未安装该服务。<br>是否安装？";j.showInstallBtn=true};var i=function(){j.startMessage="NTP 服务已安装但还未启动，是否启动？";j.showStartBtn=true};var g=function(){j.stopMessage="NTP 服务正在运行，是否停止？";j.showStopBtn=true};b();i();g();j.loadSync=function(){a.get("/query/service.ntpd",function(k){j.ntpdStatus=null;if(k["service.ntpd"]){j.ntpdStatus=k["service.ntpd"]["status"]}j.ntpdChecking=false})};j.install=function(){j.installMessage="正在安装，请稍候...";j.showInstallBtn=false;d.call(j,c,"/backend/yum_install","/backend/yum_install_base_ntp",{repo:"base",pkg:"ntp"},{wait:function(k){j.installMessage=k.msg},success:function(k){j.installMessage=k.msg;e(j.loadSync,3000,c)},error:function(k){j.installMessage=k.msg;e(j.loadSync,3000,c)}},true)};j.start=function(){j.startMessage="正在启动，请稍候...";j.showStartBtn=false;d.call(j,c,"/backend/service_start","/backend/service_start_ntpd",{name:"NTP",service:"ntpd"},{wait:function(k){j.startMessage=k.msg},success:function(k){j.startMessage=k.msg;e(function(){i();j.loadSync()},3000,c)},error:function(k){j.startMessage=k.msg;e(function(){i();j.loadSync()},3000,c)}},true)};j.stop=function(){j.stopMessage="正在停止，请稍候...";j.showStopBtn=false;d.call(j,c,"/backend/service_stop","/backend/service_stop_ntpd",{name:"NTP",service:"ntpd"},{wait:function(k){j.stopMessage=k.msg},success:function(k){j.stopMessage=k.msg;e(function(){g();j.loadSync()},3000,c)},error:function(k){j.stopMessage=k.msg;e(function(){g();j.loadSync()},3000,c)}},true)}}];var UtilsPartitionCtrl=["$scope","Module","Timeout","Request","Message","Backend",function(b,c,g,f,e,a){var d="utils.partition";c.init(d,"磁盘分区");b.loaded=false;b.waiting=true;b.loadDiskinfo=function(){f.get("/query/server.diskinfo",function(h){if(!b.loaded){b.loaded=true}b.diskinfo=h["server.diskinfo"];b.waiting=false})};b.swaponconfirm=function(h){b.devname=h;$("#swaponconfirm").modal()};b.swapon=function(){a.call(b,d,"/backend/swapon","/backend/swapon_on_"+b.devname,{devname:b.devname},{success:b.loadDiskinfo})};b.swapoffconfirm=function(h){b.devname=h;$("#swapoffconfirm").modal()};b.swapoff=function(){a.call(b,d,"/backend/swapoff","/backend/swapon_off_"+b.devname,{devname:b.devname},{success:b.loadDiskinfo})};b.umountconfirm=function(h){b.devname=h;$("#umountconfirm").modal()};b.umount=function(){a.call(b,d,"/backend/umount","/backend/mount_umount_"+b.devname,{devname:b.devname},{success:b.loadDiskinfo})};b.mountconfirm=function(i,h){b.devname=i;b.mountpoint="";b.fstype=h;f.get("/query/config.fstab("+i+")",function(j){if(j["config.fstab"]&&typeof(j["config.fstab"]["mount"])!="undefined"){b.mountpoint=j["config.fstab"]["mount"]}});$("#mountconfirm").modal()};b.selectmountpoint=function(h){b.selector_title="请选择挂载点";b.selector.onlydir=true;b.selector.onlyfile=false;b.selector.load(b.mountpoint?b.mountpoint:"/");b.selector.selecthandler=function(i){$("#selector").modal("hide");b.mountpoint=i};$("#selector").modal()};b.mount=function(){a.call(b,d,"/backend/mount","/backend/mount_mount_"+b.devname,{devname:b.devname,mountpoint:b.mountpoint,fstype:b.fstype},{success:b.loadDiskinfo})};b.formatconfirm=function(h){b.devname=h;f.get("/query/tool.supportfs",function(i){b.supportfs=i["tool.supportfs"]});$("#formatconfirm").modal()};b.format=function(){a.call(b,d,"/backend/format","/backend/format_"+b.devname,{devname:b.devname,fstype:b.fstype},{success:b.loadDiskinfo})};b.addpartconfirm=function(h,i){b.devname=h;b.unpartition=i;$("#addpartconfirm").modal()};b.addpart=function(){b.waiting=true;e.setInfo("正在 "+b.devname+" 上创建分区，请稍候...",true);f.post("/operation/fdisk",{action:"add",devname:b.devname,size:b.size,unit:b.unit},function(h){if(h.code==0){b.loadDiskinfo()}else{b.waiting=false}})};b.delpartconfirm=function(h){b.devname=h;$("#delpartconfirm").modal()};b.delpart=function(){b.waiting=true;e.setInfo("正在删除分区 "+b.devname+"，请稍候...",true);f.post("/operation/fdisk",{action:"delete",devname:b.devname},function(h){if(h.code==0){b.loadDiskinfo()}else{b.waiting=false}})};b.scanpartconfirm=function(h){b.devname=h;$("#scanpartconfirm").modal()};b.scanpart=function(){b.waiting=true;e.setInfo("正在扫描 "+b.devname+" 的分区，请稍候...",true);f.post("/operation/fdisk",{action:"scan",devname:b.devname},function(h){if(h.code==0){g(b.loadDiskinfo,1000,d)}else{b.waiting=false}})}}];var UtilsAutoFMCtrl=["$scope","Module","Timeout","Request","Message","Backend",function(b,c,g,f,e,a){var d="utils.autofm";c.init(d,"自动格式化挂载");b.loaded=false;b.waiting=true;b.diskcount=0;b.loadDiskinfo=function(){f.get("/query/server.diskinfo",function(j){if(!b.loaded){b.loaded=true}b.diskinfo=j["server.diskinfo"];b.waiting=false;b.diskcount=0;for(var h in j["server.diskinfo"]["partitions"]){var k=j["server.diskinfo"]["partitions"][h];if(k.is_hw&&!k.is_pv&&k.partcount==0&&!k.mount){b.diskcount++}}})};b.confirm=function(h){b.devname=h;b.mountpoint="";b.fstype="";f.post("/operation/file",{action:"listdir",path:"/data",showhidden:true,remember:false},function(l){if(l.code==0){var j=l.data;if(j.length==0){b.mountpoint="/data/0"}else{var m={};for(var k=0;k<j.length;k++){m[j[k].name]=true}var n=0;while(1){if(!m[""+n]){break}n++}b.mountpoint="/data/"+n}}else{f.post("/operation/file",{action:"createfolder",path:"/",name:"data"});b.mountpoint="/data/0"}},false,true);f.get("/query/tool.supportfs",function(l){var j=l["tool.supportfs"];for(var k=0;k<j.length;k++){if(j[k]=="swap"){j.splice(k,1)}if(j[k]=="xfs"){b.fstype="xfs"}else{if(j[k]=="ext4"){b.fstype="ext4"}else{if(j[k]=="ext3"){b.fstype="ext3"}}}}b.supportfs=j});$("#confirm").modal()};b.selectmountpoint=function(h){b.selector_title="请选择挂载点";b.selector.onlydir=true;b.selector.onlyfile=false;b.selector.load(b.mountpoint);b.selector.selecthandler=function(i){$("#selector").modal("hide");b.mountpoint=i};$("#selector").modal()};b.autofm=function(){f.post("/operation/file",{action:"listdir",path:b.mountpoint,showhidden:true,remember:false},function(l){if(l.code==0){var h=l.data;if(h.length>0){var o=false;for(var k=0;k<h.length;k++){if(h[k].name=="lost+found"){o=true;break}}if(o){e.setError("已有其它设备挂载在 "+b.mountpoint+" 下，请重新选择挂载点。")}else{e.setError("挂载点 "+b.mountpoint+" 下存在文件或目录，无法挂载！请重新选择挂载点。")}}else{b.format()}}else{var n=b.mountpoint.split("/");var j=n.pop();var m=n.join("/");f.post("/operation/file",{action:"createfolder",path:m,name:j},b.format)}},false,true)};b.mount=function(){a.call(b,d,"/backend/mount","/backend/mount_mount_"+b.devname,{devname:b.devname,mountpoint:b.mountpoint,fstype:b.fstype},{success:b.loadDiskinfo})};b.format=function(){a.call(b,d,"/backend/format","/backend/format_"+b.devname,{devname:b.devname,fstype:b.fstype},{success:b.mount})}}];var UtilsMoveDataCtrl=["$scope","Module","Timeout","Request","Message","Backend",function(b,c,g,f,e,a){var d="utils.movedata";c.init(d,"数据移至数据盘");b.loaded=false;b.waiting=true;b.srcpath="/var";b.despath="/";b.mountpoint="/";b.loadMounts=function(){f.get("/query/server.mounts",function(h){if(!b.loaded){b.loaded=true}b.mounts=h["server.mounts"];b.waiting=false})};b.setdespath=function(h){b.despath=h};b.selectsrcpath=function(h){b.selector_title="请选择要迁移的目录（原始目录）";b.selector.onlydir=true;b.selector.onlyfile=false;b.selector.load(b.srcpath);b.selector.selecthandler=function(i){$("#selector").modal("hide");b.srcpath=i};$("#selector").modal()};b.selectdespath=function(h){b.selector_title="请选择要迁移到的目录（目标目录）";b.selector.onlydir=true;b.selector.onlyfile=false;b.selector.load(b.despath);b.selector.selecthandler=function(i){$("#selector").modal("hide");b.despath=i};$("#selector").modal()};b.movedata=function(){b.waiting=true;var i=b.srcpath.replace(/\/$/,"");var j=i.split("/").pop();var h=b.despath.replace(/\/$/,"")+"/"+j;if(h==i){e.setError("路径没有改变，无须迁移！");b.waiting=false;return}e.setInfo("正在检测，请稍候...",true);f.post("/operation/file",{action:"getitem",path:i},function(k){if(k.code==0){if(!k.data.isdir){e.setError(b.srcpath+" 不是有效的目录！（可能是文件或链接）");b.waiting=false;return}f.post("/operation/file",{action:"getitem",path:h},function(l){if(l.code==0){e.setError("目标目录下已有同名文件或目录 "+h+"，迁移失败！");b.waiting=false}else{a.call(b,d,"/backend/move","/backend/move_"+i+"_"+h,{srcpath:i,despath:h},{success:function(m){e.setInfo("正在原始目录创建链接...");f.post("/operation/file",{action:"link",srcpath:h,despath:i},function(n){if(n.code==0){e.setSuccess("迁移完成！")}else{e.setError("迁移失败！"+n.msg)}b.waiting=false},false,true)},error:function(m){e.setError("迁移过程中发生错误，迁移失败！");b.waiting=false}})}},false,true)}})}}];