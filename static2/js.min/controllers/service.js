var ServiceCtrl=["$scope","$routeParams","Module","Timeout","Request","Backend",function(b,h,c,f,e,a){var d="service";c.init(d,"服务管理");c.initSection("http");b.scope=b;b.info=null;b.loaded=false;b.waiting=true;b.loadInfo=function(){e.get("/query/server.virt,service.**",function(i){if(!b.loaded){b.loaded=true}if(b.info==null){b.info=i}else{deepUpdate(b.info,i)}b.waiting=false})};b.toggleAutostart=function(j,i){var k=b.info["service."+i]["autostart"];e.post("/operation/chkconfig",{name:j,service:i,autostart:!k},function(l){b.loadInfo()})};var g=function(i){return function(k,j){a.call(b,d,"/backend/service_"+i,"/backend/service_"+i+"_"+j,{name:k,service:j},b.loadInfo)}};b.start=g("start");b.stop=g("stop");b.restart=g("restart")}];var ServiceNginxCtrl=["$scope","$routeParams","Module","Request",function(a,e,b,d){var c="service.nginx";b.init(c,"Nginx");b.initSection("base");a.scope=a;a.info=null;a.loaded=false;a.installed=false;a.waiting=true;a.checking=false;a.checkInstalled=function(){a.checking=true;d.get("/query/service.nginx",function(g){var h=g["service.nginx"];if(h){a.installed=true;a.autostart=h.autostart;a.status=h.status;if(a.checkVersion){a.checkVersion()}a.getsettings();a.getcachesettings()}else{a.installed=false}a.loaded=true;a.waiting=false;a.checking=false});d.get("/client/ip",function(g){a.ip=g})};a.setting={limit_rate:"",limit_conn:"",limit_conn_zone:"",client_max_body_size:"",keepalive_timeout:"",access_status:"off",allow:"",deny:"",gzip:""};a.getsettings=function(){if(!a.installed){return}d.post("/operation/nginx",{action:"gethttpsettings",items:"limit_rate,limit_conn,limit_conn_zone,client_max_body_size,keepalive_timeout,allow[],deny[],gzip"},function(h){if(h.code==0){a.setting=h.data;var g=a.setting;if(g.allow&&g.allow.length>0){g.access_status="white"}else{if(g.deny&&g.deny.length>0){g.access_status="black"}else{g.access_status="off"}}if(g.allow){g.allow=g.allow.join("\n")}if(g.deny){g.deny=g.deny.join("\n")}}},false,true)};a.savesettings=function(){var g=angular.copy(a.setting);g.action="sethttpsettings";g.version=a.pkginfo.version;d.post("/operation/nginx",g,function(h){if(h.code==0){a.getsettings()}})};var f={name:"newcache",mem:"10",path:"/var/www/cache",path_level_1:"1",path_level_2:"2",path_level_3:"0",inactive:"10",inactive_unit:"m",max_size:"100",max_size_unit:"m",autocreate:true};a.proxy_caches=[];a.curcache=-1;a.setcache=function(g){a.curcache=g};a.getcachesettings=function(){if(!a.installed){return}d.post("/operation/nginx",{action:"gethttpsettings",items:"proxy_cache_path[]"},function(h){if(h.code==0){a.proxy_caches=[];var k=h.data.proxy_cache_path;if(k){for(var g=0;g<k.length;g++){var j=angular.copy(f);angular.extend(j,k[g]);a.proxy_caches.push(j)}a.curcache=0}}},false,true)};a.deletecache=function(g){a.proxy_caches.splice(g,1);a.curcache--;if(a.curcache<0&&a.proxy_caches.length>0){a.curcache=0}};a.addcache=function(){var g=a.proxy_caches;g.splice(a.curcache+1,0,angular.copy(f));a.curcache++};a.selectcachefolder=function(g){a.selector_title="请选择缓存目录";a.selector.onlydir=true;a.selector.onlyfile=false;a.selector.load(a.proxy_caches[g].path);a.selector.selecthandler=function(h){$("#selector").modal("hide");a.proxy_caches[g].path=h};$("#selector").modal()};a.savecaches=function(){var g={action:"setproxycachesettings",proxy_caches:angular.toJson(a.proxy_caches)};d.post("/operation/nginx",g,function(h){if(h.code==0){a.getcachesettings()}})}}];var ServiceApacheCtrl=["$scope","$routeParams","Module","Request",function(a,e,b,d){var c="service.apache";b.init(c,"Apache");b.initSection("base");a.scope=a;a.info=null;a.loaded=false;a.installed=false;a.waiting=true;a.checking=false;a.checkInstalled=function(){a.checking=true;d.get("/query/service.httpd",function(f){var g=f["service.httpd"];if(g){a.installed=true;a.autostart=g.autostart;a.status=g.status;if(a.checkVersion){a.checkVersion()}}else{a.installed=false}a.loaded=true;a.waiting=false;a.checking=false})}}];var ServiceVsftpdCtrl=["$scope","$routeParams","Module","Request",function(a,e,b,d){var c="service.vsftpd";b.init(c,"vsftpd");b.initSection("base");a.scope=a;a.info=null;a.loaded=false;a.installed=false;a.waiting=true;a.checking=false;a.checkInstalled=function(){a.checking=true;d.get("/query/service.vsftpd",function(f){var g=f["service.vsftpd"];if(g){a.installed=true;a.autostart=g.autostart;a.status=g.status;if(a.checkVersion){a.checkVersion()}}else{a.installed=false}a.loaded=true;a.waiting=false;a.checking=false})}}];var ServiceMySQLCtrl=["$scope","$rootScope","$routeParams","Module","Message","Request","Backend",function(c,a,h,d,g,f,b){var e="service.mysqld";d.init(e,"MySQL");d.initSection("base");c.scope=c;c.info=null;c.loaded=false;c.installed=false;c.waiting=true;c.checking=false;c.processing=false;c.checkInstalled=function(){c.checking=true;f.get("/query/service.mysqld",function(i){var j=i["service.mysqld"];if(j){c.installed=true;c.autostart=j.autostart;c.status=j.status;if(c.checkVersion){c.checkVersion()}}else{c.installed=false}c.loaded=true;c.waiting=false;c.checking=false})};c.updatepwd=function(){if(c.status!="running"){g.setError("MySQL还未启动，无法修改密码！");return}c.processing=true;f.post("/operation/mysql",{action:"updatepwd",newpassword:c.root_passwd,newpasswordc:c.root_passwdc,password:c.root_opasswd},function(i){if(i.code==0){c.root_passwd="";c.root_passwdc="";c.root_opasswd="";a.$mysql={password:"",password_validated:false}}c.processing=false})};c.fupdatepwd=function(){c.processing=true;b.call(c,e,"/backend/mysql_fupdatepwd","/backend/mysql_fupdatepwd",{password:c.root_passwd,passwordc:c.root_passwdc},function(i){if(i.code==0){c.root_passwd="";c.root_passwdc="";a.$mysql={password:"",password_validated:false}}c.processing=false})}}];var ServiceRedisCtrl=["$scope","$routeParams","Module","Request",function(a,e,b,d){var c="service.redis";b.init(c,"Redis");b.initSection("base");a.scope=a;a.info=null;a.loaded=false;a.installed=false;a.waiting=true;a.checking=false;a.checkInstalled=function(){a.checking=true;d.get("/query/service.redis",function(f){var g=f["service.redis"];if(g){a.installed=true;a.autostart=g.autostart;a.status=g.status;if(a.checkVersion){a.checkVersion()}}else{a.installed=false}a.loaded=true;a.waiting=false;a.checking=false})}}];var ServiceMemcacheCtrl=["$scope","$routeParams","Module","Request",function(a,e,b,d){var c="service.memcache";b.init(c,"Memcache");b.initSection("base");a.scope=a;a.info=null;a.loaded=false;a.installed=false;a.waiting=true;a.checking=false;a.checkInstalled=function(){a.checking=true;d.get("/query/service.memcached",function(f){var g=f["service.memcached"];if(g){a.installed=true;a.autostart=g.autostart;a.status=g.status;if(a.checkVersion){a.checkVersion()}}else{a.installed=false}a.loaded=true;a.waiting=false;a.checking=false})}}];var ServiceMongoDBCtrl=["$scope","$routeParams","Module","Request",function(a,e,b,d){var c="service.mongodb";b.init(c,"MongoDB");b.initSection("base");a.scope=a;a.info=null;a.loaded=false;a.installed=false;a.waiting=true;a.checking=false;a.checkInstalled=function(){a.checking=true;d.get("/query/service.mongod",function(f){var g=f["service.mongod"];if(g){a.installed=true;a.autostart=g.autostart;a.status=g.status;if(a.checkVersion){a.checkVersion()}}else{a.installed=false}a.loaded=true;a.waiting=false;a.checking=false})}}];var ServicePHPCtrl=["$scope","$routeParams","Module","Request",function(a,e,b,d){var c="service.php";b.init(c,"PHP");b.initSection("base");a.scope=a;a.info=null;a.loaded=false;a.installed=false;a.waiting=true;a.checking=false;a.checkInstalled=function(){a.checking=true;d.get("/query/service.php-fpm",function(g){var h=g["service.php-fpm"];if(h){a.installed=true;a.autostart=h.autostart;a.status=h.status;if(a.checkVersion){a.checkVersion()}a.getphpsettings();a.getfpmsettings()}else{a.installed=false}a.loaded=true;a.waiting=false;a.checking=false})};a.setting={php:{short_open_tag:false,expose_php:false,max_execution_time:"",memory_limit:"",display_errors:false,post_max_size:"",upload_max_filesize:"","date.timezone":""},fpm:{listen:"",pm:false,"pm.max_children":"","pm.start_servers":"","pm.min_spare_servers":"","pm.max_spare_servers":"","pm.max_requests":"",request_terminate_timeout:"",request_slowlog_timeout:""}};var f=function(g){g=parseInt(g);if(isNaN(g)){g=""}else{g+=""}return g};a.getphpsettings=function(){if(!a.installed){return}d.post("/operation/php",{action:"getphpsettings"},function(h){if(h.code==0){var g=h.data;var i=a.setting.php;i.short_open_tag=(g.short_open_tag&&g.short_open_tag.toLowerCase()=="on");i.expose_php=(g.expose_php&&g.expose_php.toLowerCase()=="on");i.max_execution_time=g.max_execution_time?g.max_execution_time:"";i.memory_limit=g.memory_limit?f(g.memory_limit):"";i.display_errors=(g.display_errors&&g.display_errors.toLowerCase()=="on");i.post_max_size=g.post_max_size?f(g.post_max_size):"";i.upload_max_filesize=g.upload_max_filesize?f(g.upload_max_filesize):"";i["date.timezone"]=g["date.timezone"]?g["date.timezone"]:""}},false,true)};a.getfpmsettings=function(){if(!a.installed){return}d.post("/operation/php",{action:"getfpmsettings"},function(h){if(h.code==0){var g=h.data;var i=a.setting.fpm;i.listen=g.listen?g.listen:"";i.pm=(g.pm&&g.pm.toLowerCase()=="dynamic");i["pm.max_children"]=g["pm.max_children"]?f(g["pm.max_children"]):"";i["pm.start_servers"]=g["pm.start_servers"]?f(g["pm.start_servers"]):"";i["pm.min_spare_servers"]=g["pm.min_spare_servers"]?f(g["pm.min_spare_servers"]):"";i["pm.max_spare_servers"]=g["pm.max_spare_servers"]?f(g["pm.max_spare_servers"]):"";i["pm.max_requests"]=g["pm.max_requests"]?f(g["pm.max_requests"]):"";i.request_terminate_timeout=g.request_terminate_timeout?f(g.request_terminate_timeout):"";i.request_slowlog_timeout=g.request_slowlog_timeout?f(g.request_slowlog_timeout):""}},false,true)};a.updatephpsettings=function(){var g=angular.copy(a.setting.php);g.action="updatephpsettings";d.post("/operation/php",g,a.getphpsettings)};a.updatefpmsettings=function(){var g=angular.copy(a.setting.fpm);g.action="updatefpmsettings";d.post("/operation/php",g,a.getfpmsettings)}}];var ServiceSendmailCtrl=["$scope","$routeParams","Module","Request",function(a,e,b,d){var c="service.sendmail";b.init(c,"Sendmail");b.initSection("base");a.scope=a;a.info=null;a.loaded=false;a.installed=false;a.waiting=true;a.checking=false;a.checkInstalled=function(){a.checking=true;d.get("/query/service.sendmail",function(f){var g=f["service.sendmail"];if(g){a.installed=true;a.autostart=g.autostart;a.status=g.status;if(a.checkVersion){a.checkVersion()}}else{a.installed=false}a.loaded=true;a.waiting=false;a.checking=false})}}];var ServiceSSHCtrl=["$scope","$routeParams","Module","Request","Backend","Message",function(b,g,c,f,a,e){var d="service.ssh";c.init(d,"SSH");c.initSection("base");b.scope=b;b.info=null;b.loaded=false;b.installed=false;b.waiting=true;b.checking=false;b.checkInstalled=function(){b.checking=true;f.get("/query/service.sshd",function(h){var i=h["service.sshd"];if(i){b.installed=true;b.autostart=i.autostart;b.status=i.status;b.getsettings();if(b.checkVersion){b.checkVersion()}}else{b.installed=false}b.loaded=true;b.waiting=false;b.checking=false})};b.setting={};b.getsettings=function(){if(!b.installed){return}f.post("/operation/ssh",{action:"getsettings"},function(h){if(h.code==0){b.setting=h.data;b.setting.disable_pwdauth=!b.setting.enable_pwdauth}},false,true)};b.savesettings=function(){var h={};h.action="savesettings";h.port=b.setting.port;h.enable_pwdauth=b.setting.enable_pwdauth;h.enable_sftp=b.setting.enable_sftp;f.post("/operation/ssh",h,function(i){if(i.code==0){b.getsettings()}})};b.savepksettings=function(){var h={};h.action="savesettings";h.pubkey=b.setting.pubkey;h.enable_pubkauth=b.setting.enable_pubkauth;h.enable_pwdauth=!b.setting.disable_pwdauth;f.post("/operation/ssh",h,function(i){if(i.code==0){b.getsettings()}})};b.gensshkey=function(){if(b.setting.pubkey||b.setting.prvkey){b.confirm_title="重新生成公钥/私钥对";b.confirm_body="公钥/私钥已存在，是否覆盖原文件？";$("#confirm").modal();b.confirm=b.dogenkey;return}b.dogenkey()};b.dogenkey=function(){a.call(b,d,"/backend/ssh_genkey","/backend/ssh_genkey",{},{success:function(h){b.getsettings()}})};b.chpasswd=function(){$("#chpasswd").modal()};b.dochpasswd=function(){if(b.newpassword!=b.newpasswordc){e.setError("新密码和确认密码不一致！");return}a.call(b,d,"/backend/ssh_chpasswd","/backend/ssh_chpasswd",{path:b.setting.prvkey,oldpassword:b.oldpassword,newpassword:b.newpassword},{success:function(h){b.oldpassword=b.newpassword=b.newpasswordc=""}})}}];var ServiceIPTablesCtrl=["$scope","$routeParams","Module","Request",function(a,e,b,d){var c="service.iptables";b.init(c,"IPTables");b.initSection("base");a.scope=a;a.info=null;a.loaded=false;a.installed=false;a.waiting=true;a.checking=false;a.checkInstalled=function(){a.checking=true;d.get("/query/service.iptables",function(f){var g=f["service.iptables"];if(g){a.installed=true;a.autostart=g.autostart;a.status=g.status;if(a.checkVersion){a.checkVersion()}}else{a.installed=false}a.loaded=true;a.waiting=false;a.checking=false})}}];var ServiceCronCtrl=["$scope","$routeParams","Module","Request",function(a,e,b,d){var c="service.cron";b.init(c,"Cron");b.initSection("base");a.scope=a;a.info=null;a.loaded=false;a.installed=false;a.waiting=true;a.checking=false;a.checkInstalled=function(){a.checking=true;d.get("/query/service.crond",function(f){var g=f["service.crond"];if(g){a.installed=true;a.autostart=g.autostart;a.status=g.status;if(a.checkVersion){a.checkVersion()}}else{a.installed=false}a.loaded=true;a.waiting=false;a.checking=false})}}];var ServiceNTPCtrl=["$scope","$routeParams","Module","Request",function(a,e,b,d){var c="service.ntp";b.init(c,"NTP");b.initSection("base");a.scope=a;a.info=null;a.loaded=false;a.installed=false;a.waiting=true;a.checking=false;a.checkInstalled=function(){a.checking=true;d.get("/query/service.ntpd",function(f){var g=f["service.ntpd"];if(g){a.installed=true;a.autostart=g.autostart;a.status=g.status;if(a.checkVersion){a.checkVersion()}}else{a.installed=false}a.loaded=true;a.waiting=false;a.checking=false})}}];