var DatabaseCtrl=["$scope","Module","$rootScope","Request","Message","Backend",function(c,d,a,g,f,b){var e="database";d.init(e,"数据库管理");c.loaded=false;var h=d.getSection();c.has_dbserver=false;c.mysql_supported=false;c.load=function(){g.get("/query/service.mysqld",function(i){if(i["service.mysqld"]&&i["service.mysqld"].status){c.mysql_supported=true}c.has_dbserver=c.mysql_supported;if(c.has_dbserver){if(h){if(h=="mysqld"&&c.mysql_supported){d.setSection("mysqld")}else{d.setSection(c.mysql_supported?"mysql":"mysql")}}else{d.setSection(c.mysql_supported?"mysql":"mysql")}}c.loaded=true})};c.validate_password=function(){c.processing=true;g.post("/operation/mysql",{action:"checkpwd",password:a.$mysql.password},function(i){if(i.code==0){a.$mysql.password_validated=true;c.loaddbs();c.loadusers()}c.processing=false})};c.dbloading=true;c.loaddbs=function(){c.dbloading=true;b.call(c,e,"/backend/mysql_databases","/backend/mysql_databases",{password:a.$mysql.password},{success:function(i){c.dbs=i.data;c.dbloading=false},error:function(){c.dbloading=false}})};c.userloading=true;c.loadusers=function(){c.userloading=true;b.call(c,e,"/backend/mysql_users","/backend/mysql_users",{password:a.$mysql.password},{success:function(i){c.users=i.data;c.userloading=false},error:function(){c.userloading=false}})};if(a.$mysql.password_validated){c.loaddbs();c.loadusers()}}];var DatabaseMySQLNewDBCtrl=["$scope","Module","$rootScope","$location","Request","Message","Backend",function(c,d,a,h,g,f,b){var e="database.mysql.db.new";d.init(e,"新建数据库");c.loaded=true;c.collation="utf8_general_ci";c.validate_password=function(){c.processing=true;g.post("/operation/mysql",{action:"checkpwd",password:a.$mysql.password},function(i){if(i.code==0){a.$mysql.password_validated=true}c.processing=false})};c.newdb=function(){c.processing=true;b.call(c,e,"/backend/mysql_create","/backend/mysql_create_"+c.dbname,{password:a.$mysql.password,dbname:c.dbname,collation:c.collation},{success:function(i){h.path("/database/mysql/db/edit/"+encodeURIComponent(c.dbname));c.processing=false},error:function(){c.processing=false}})}}];var DatabaseMySQLEditDBCtrl=["$scope","Module","$rootScope","$routeParams","$location","Request","Message","Backend",function(j,d,g,i,e,a,f,c){var h=i.section;j.dbname=decodeURIComponent(h);var b="database.mysql.db.edit";d.init(b,"管理数据库 "+j.dbname);d.initSection("users");j.loaded=true;j.validate_password=function(){j.processing=true;a.post("/operation/mysql",{action:"checkpwd",password:g.$mysql.password},function(k){if(k.code==0){g.$mysql.password_validated=true;j.loaddbinfo()}j.processing=false})};j.dbloading=true;j.loaddbinfo=function(){j.dbloading=true;c.call(j,b,"/backend/mysql_dbinfo","/backend/mysql_dbinfo_"+j.dbname,{password:g.$mysql.password,dbname:j.dbname},{success:function(k){j.dbinfo=k.data;j.dbloading=false;j.loadusers()},error:function(){j.dbloading=false}})};j.userloading=true;j.loadusers=function(){j.userloading=true;c.call(j,b,"/backend/mysql_users","/backend/mysql_users_"+j.dbname,{password:g.$mysql.password,dbname:j.dbname},{success:function(k){j.users=k.data;j.userloading=false},error:function(){j.userloading=false}})};j.setcollation=function(){j.processing=true;a.post("/operation/mysql",{action:"alter_database",password:g.$mysql.password,dbname:j.dbname,collation:j.dbinfo.collation},function(){j.processing=false})};j.rename=function(){j.processing=true;c.call(j,b,"/backend/mysql_rename","/backend/mysql_rename_"+j.dbname,{password:g.$mysql.password,dbname:j.dbname,newname:j.dbinfo.name},{success:function(k){e.path("/database/mysql/db/edit/"+encodeURIComponent(j.dbinfo.name));j.processing=false},error:function(){j.processing=false}})};j.selectexportfolder=function(){j.selector.onlydir=true;j.selector.onlyfile=false;j.selector.load(j.exportpath?j.exportpath:"/root");j.selector.selecthandler=function(k){$("#selector").modal("hide");j.exportpath=k};$("#selector").modal()};j.exportdb=function(){j.processing=true;c.call(j,b,"/backend/mysql_export","/backend/mysql_export_"+j.dbname,{password:g.$mysql.password,dbname:j.dbname,path:j.exportpath},function(k){j.processing=false})};j.dropdb=function(){j.processing=true;c.call(j,b,"/backend/mysql_drop","/backend/mysql_drop_"+j.dbname,{password:g.$mysql.password,dbname:j.dbname},function(k){if(k.code==0){e.path("/database");e.search("s","mysql")}j.processing=false})};if(g.$mysql.password_validated){j.loaddbinfo()}}];var DatabaseMySQLNewUserCtrl=["$scope","Module","$rootScope","$location","Request","Message","Backend",function(c,d,a,h,g,f,b){var e="database.mysql.user.new";d.init(e,"添加新用户");c.loaded=true;c.dbname=d.getParam("dbname");c.validate_password=function(){c.processing=true;g.post("/operation/mysql",{action:"checkpwd",password:a.$mysql.password},function(i){if(i.code==0){a.$mysql.password_validated=true}c.processing=false})};c.newuser=function(){if(!c.emptypassword){if(c.password!=c.passwordc){f.setError("新密码和确认密码不一致！");return}}var i=c.user+"@"+c.host;c.processing=true;b.call(c,e,"/backend/mysql_createuser","/backend/mysql_createuser_"+i,{password:a.$mysql.password,user:c.user,host:c.host,pwd:c.emptypassword?"":c.password},{success:function(j){h.path("/database/mysql/user/edit/"+encodeURIComponent(i));if(c.dbname){h.search("dbname",c.dbname)}c.processing=false},error:function(){c.processing=false}})};c.genpassword=function(){var n="ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";var p=16;var m="";var j=0;var o=0;for(var l=0;l<p;l++){if((Math.floor(Math.random()*2)==0)&&o<3||j>=5){var k=Math.floor(Math.random()*10);m+=k;o+=1}else{var k=Math.floor(Math.random()*n.length);m+=n.substring(k,k+1);j+=1}}c.randpassword=c.password=c.passwordc=m}}];var DatabaseMySQLEditUserCtrl=["$scope","Module","$rootScope","$routeParams","$location","Request","Message","Backend",function(l,d,i,k,e,a,g,c){var j=k.section;l.username=decodeURIComponent(j);var f=l.username.split("@");l.user=f[0];l.host=f[1];var b="database.mysql.user.edit";d.init(b,"管理用户 "+l.username);d.initSection("privs");l.loaded=true;l.validate_password=function(){l.processing=true;a.post("/operation/mysql",{action:"checkpwd",password:i.$mysql.password},function(m){if(m.code==0){i.$mysql.password_validated=true;l.loadprivs();l.loaddbs()}l.processing=false})};l.privsloading=true;l.loadprivs=function(){l.privsloading=true;c.call(l,b,"/backend/mysql_userprivs","/backend/mysql_userprivs_"+l.username,{password:i.$mysql.password,username:l.username},{success:function(m){l.privs=m.data;l.privsloading=false;var n=d.getParam("dbname");var o=d.getParam("privtype");if(n){l.privs_dbname=n;l.editprivs(false,o)}},error:function(){l.privsloading=false}})};l.$watch("selectall",function(m){angular.forEach(l.curprivs,function(n,o){if(o.indexOf("_priv")>0){l.curprivs[o]=m?"Y":"N"}})});var h={Select_priv:"N",Insert_priv:"N",Update_priv:"N",Delete_priv:"N",Create_priv:"N",Alter_priv:"N",Index_priv:"N",Drop_priv:"N",Create_tmp_table_priv:"N",Show_view_priv:"N",Create_routine_priv:"N",Alter_routine_priv:"N",Execute_priv:"N",Create_view_priv:"N",Event_priv:"N",Trigger_priv:"N",Grant_priv:"N",Lock_tables_priv:"N",References_priv:"N"};l.editprivs=function(o,p){if(p=="global"){l.orgprivs=l.privs.global;l.curprivs=angular.copy(l.privs.global)}else{if(!o){if(!l.privs_dbname){return}var n=false;for(var m=0;m<l.privs.bydb.length;m++){if(l.privs.bydb[m].Db==l.privs_dbname){l.orgprivs=l.privs.bydb[m];l.curprivs=angular.copy(l.privs.bydb[m]);n=true;break}}if(!n){l.orgprivs=null;l.curprivs=angular.copy(h);l.curprivs.Db=l.privs_dbname;l.curprivs.flag="new"}}else{l.orgprivs=o;l.curprivs=angular.copy(o)}}if(!l.curprivs.Db){l.privsedit_title="设置 "+l.username+" 的全局权限"}else{l.privsedit_title="设置 "+l.username+" 在数据库 "+l.curprivs.Db+" 的权限"}$("#privsedit").modal()};l.updateprivs=function(){c.call(l,b,"/backend/mysql_updateuserprivs","/backend/mysql_updateuserprivs_"+encodeURIComponent(l.username+(l.curprivs.Db?"_"+l.curprivs.Db:"")),{password:i.$mysql.password,username:l.username,privs:angular.toJson(l.curprivs),dbname:l.curprivs.Db},{success:function(m){if(l.curprivs.flag=="new"){l.privs.bydb.push(l.curprivs)}else{angular.copy(l.curprivs,l.orgprivs)}var n=d.getParam("dbname");if(n){e.path("/database/mysql/db/edit/"+encodeURIComponent(n))}}})};l.loaddbs=function(){l.dbloading=true;c.call(l,b,"/backend/mysql_databases","/backend/mysql_databases",{password:i.$mysql.password},{success:function(m){l.dbs=m.data}},true)};l.setpassword=function(){if(!l.emptypassword){if(l.newpassword!=l.newpasswordc){g.setError("新密码和确认密码不一致！");return}}l.processing=true;c.call(l,b,"/backend/mysql_setuserpassword","/backend/mysql_setuserpassword_"+l.username,{password:i.$mysql.password,username:l.username,pwd:l.emptypassword?"":l.newpassword},{success:function(m){l.processing=false;if(l.username=="root@localhost"){i.$mysql={password:"",password_validated:false}}},error:function(){l.processing=false}})};l.dropuser=function(){l.processing=true;c.call(l,b,"/backend/mysql_dropuser","/backend/mysql_dropuser_"+l.username,{password:i.$mysql.password,username:l.username},function(m){if(m.code==0){e.path("/database");e.search("s","mysql")}l.processing=false})};if(i.$mysql.password_validated){l.loadprivs();l.loaddbs()}}];