var FileCtrl=["$scope","$routeParams","Module","Message","Request","Backend",function(m,h,r,a,o,i){var e="file";r.init(e,"文件管理");var b=h.path;var j=h.file;var k=true;var n=true;m.path=m.lastpath="/root";m.curpath="";m.showhidden=false;m.clipboard={srcpath:"",count:0,items:{}};m.confirm=m.cancel=function(){};var d=function(){var v=m.curpath.split("/");var s=[];for(var t=1;t<v.length;t++){if(!v[t]){continue}var u=v[t-1]+"/"+v[t];s.push({name:v[t],path:u});v[t]=u}m.pathinfos=s};m.loaded=false;m.load=function(){if(b||j){m.loaded=true;k=false;n=false;if(j){b=j.split("/");j=b.pop();b=b.join("/");if(!b){b="/"}}m.listdir(b,true,function(){if(j){m.editfile(j)}})}else{o.post("/operation/file",{action:"last"},function(u){if(u.code==0){m.loaded=true;var t=u.data.lastfile;var s=u.data.lastdir;m.listdir(s,true,function(){if(t&&t.indexOf(s)===0){t=t.replace(s+"/","");if(t.indexOf("/")==-1){m.editfile(t)}}})}},false,true)}};m.fileloading=false;m.listdir=function(t,s,v){if(t){m.path=t}if(m.path==""){m.path="/root"}else{if(m.path!="/"&&m.path.substr(-1)=="/"){m.path=m.path.substr(0,m.path.length-1)}}m.path=m.path.replace("//","/");var u=m.path;m.fileloading=true;o.post("/operation/file",{action:"listdir",path:u,showhidden:m.showhidden,remember:k},function(w){if(w.code==0){m.items=w.data;m.curpath=u;m.lastpath=u;if(s){m.selects={};m.selectall=false}}else{m.path=m.lastpath}m.fileloading=false;d();if(v){v.call()}},false,true)};m.getitem=function(s,t){if(!t){t=s}else{delete m.selects[t]}o.post("/operation/file",{action:"getitem",path:m.curpath+"/"+s},function(z){if(z.code==0){var v=z.data;var y=false;for(var u=0;u<m.items.length;u++){if(m.items[u].name==t){m.items[u]=v;y=true;break}}if(!y){var w=false;var u=0;if(v.isdir||v.islnk&&v.link_isdir){for(;u<m.items.length;u++){var x=m.items[u];if(x.isdir||x.islnk&&x.link_isdir){if(m.items[u].name.localeCompare(v.name)>1){m.items.splice(u,0,v);w=true;break}}else{break}}}else{for(;u<m.items.length;u++){var x=m.items[u];if(x.isdir||x.islnk&&x.link_isdir){continue}if(m.items[u].name.localeCompare(v.name)>1){m.items.splice(u,0,v);w=true;break}}}if(!w){m.items.splice(u,0,v)}}}else{for(var u=0;u<m.items.length;u++){if(m.items[u].name==s){m.items.splice(u,1);break}}}},false,true)};m.upandlist=function(){var s=m.curpath.split("/");s.pop();m.listdir(s.join("/")+"/",true)};m.editfile=function(s){o.post("/operation/file",{action:"fread",path:m.curpath+"/"+s,remember:n},function(u){if(u.code==0){a.setSuccess("");var t=u.data;m.filename=t.filename;m.filepath=t.filepath;m.filecharset=t.charset;m.filecharset_org=t.charset;g.setValue("");$("#list").hide();$("#edit").show();g.setOption("mode",t.mimetype);g.setValue(t.content);q=false}})};m.return2list=m.canceledit=function(){if(q){m.confirm_title="是否放弃修改？";m.confirm_body=m.filepath+" 已被修改，是否放弃修改？";$("#confirm").modal();m.cancel=function(){};m.confirm=function(){$("#edit").hide();$("#list").show();o.post("/operation/file",{action:"fclose"},false,false,true)}}else{$("#edit").hide();$("#list").show();o.post("/operation/file",{action:"fclose"},false,false,true)}};m.savefile=function(){if(!q&&m.filecharset==m.filecharset_org){a.setInfo("文件未修改，无须保存！");return}o.post("/operation/file",{action:"fwrite",path:m.filepath,charset:m.filecharset,content:g.getValue()},function(s){if(s.code==0){q=false;m.getitem(m.filename)}})};m.newfolder=function(){m.newname_title="新建文件夹";m.newname_label="文件夹名称";m.newname_name="";$("#newname").modal();m.newname=function(){o.post("/operation/file",{action:"createfolder",path:m.curpath,name:m.newname_name},function(s){if(s.code==0){m.getitem(m.newname_name)}})}};m.newfile=function(){m.newname_title="新建文件";m.newname_label="文件名称";m.newname_name="";$("#newname").modal();m.newname=function(){o.post("/operation/file",{action:"createfile",path:m.curpath,name:m.newname_name},function(s){if(s.code==0){m.getitem(m.newname_name)}})}};m.upload=function(){$("#upload").modal()};m.doupload=function(){var s=$("#uploadform").find("input[name=ufile]").val().split(/[\\\/]/);var t=s[s.length-1];o.post("/operation/file",{action:"getitem",path:m.curpath+"/"+t},function(u){if(u.code==0){m.confirm_title="上传文件覆盖确认";m.confirm_body="<p>系统检测到当前目录下已存在同名文件 "+t+"。</p><p>确认要覆盖这个文件吗？</p>";$("#confirm").modal();m.confirm=function(){$("#uploadform").submit()}}else{$("#uploadform").submit()}},false,true)};m.download=function(){$("#download").modal();m.dodownload=function(){i.call(m,e,"/backend/wget","/backend/wget_"+encodeURIComponent(encodeURIComponent(m.downloadurl)),{url:m.downloadurl,path:m.curpath},{success:function(s){m.listdir()}})}};m.togglehidden=function(){m.showhidden=!m.showhidden;m.listdir()};m.rename=function(s){m.newname_title="重命名";m.newname_label="新名称";m.newname_name=s;$("#newname").modal();m.newname=function(){o.post("/operation/file",{action:"rename",path:m.curpath+"/"+s,name:m.newname_name},function(t){if(t.code==0){m.getitem(m.newname_name,s)}})}};var p=function(s){return function(u,v){var t=m.clipboard;if(t.srcpath!=m.curpath){t.items={};t.count=0}if(typeof v=="undefined"){if(typeof t.items[u]=="undefined"){t.srcpath=m.curpath;t.items[u]=s;t.count++}else{if(t.items[u]==s){delete t.items[u];t.count--}else{if(typeof v=="undefined"){t.items[u]=s}}}}else{if(v){if(typeof t.items[u]=="undefined"){t.srcpath=m.curpath;t.count++}t.items[u]=s}else{if(typeof t.items[u]!="undefined"){delete t.items[u];t.count--}}}}};m.togglecopy=p("copy");m.togglecut=p("cut");m.togglelink=p("link");m.paste=function(){f()};var l=function(v,t,s,u){if(v=="copy"){i.call(m,e,"/backend/copy","/backend/copy_"+t+"_"+s,{srcpath:t,despath:s},{success:function(w){delete m.clipboard.items[u];m.selects={};m.listdir();f()},error:function(w){m.listdir()}})}else{if(v=="cut"){i.call(m,e,"/backend/move","/backend/move_"+t+"_"+s,{srcpath:t,despath:s},{success:function(w){delete m.clipboard.items[u];m.selects={};m.listdir();f()},error:function(w){m.listdir()}})}else{if(v=="link"){o.post("/operation/file",{action:"link",srcpath:t,despath:s},function(w){if(w.code==0){m.selects={};m.listdir();delete m.clipboard.items[u];f()}})}}}};var f=function(t){var s="";for(s in m.clipboard.items){break}if(!s){return}var u=m.clipboard.items[s];o.post("/operation/file",{action:"exist",name:t?t:s,path:m.curpath},function(x){if(x.code==0){var w=m.clipboard.srcpath+"/"+s;var v=m.curpath+"/"+(t?t:s);if(x.data){m.overwrite_filename=(t?t:s);m.overwrite_option="rename";m.overwrite_newname=(t?t:s)+".new";$("#overwriteconfirm").modal();m.overwrite=function(){if(m.overwrite_option=="rename"){f(m.overwrite_newname)}else{l(u,w,v,s)}}}else{l(u,w,v,s)}}})};m.move2trash=function(s){o.post("/operation/file",{action:"delete",paths:m.curpath+"/"+s},function(v){if(v.code==0){m.getitem(s);var t="."+s+".bak";for(var u=0;u<m.items.length;u++){if(m.items[u].name==t){m.getitem(t);break}}}})};m.compressconfirm=function(s,t){m.compress_isreg=t;m.compress_type=t?".gz":".tar.gz";m.compress_zipname=s;m.compress_name=s;m.compress_names=[];$("#compressconfirm").modal()};m.compress=function(){var t=m.curpath+"/"+m.compress_zipname+m.compress_type;var s=m.curpath+"/"+m.compress_name;i.call(m,e,"/backend/compress","/backend/compress_"+t+"_"+s,{zippath:t,paths:s},{success:function(v){var u=m.compress_zipname+m.compress_type;if(m.compress_type==".gz"){m.getitem(u,m.compress_name)}else{m.getitem(u)}}})};m.decompress=function(t){var u=t.split(".");var s=u.pop();var w=u.pop();if(s=="gz"&&w!="tar"){var v=m.curpath+"/"+t;i.call(m,e,"/backend/decompress","/backend/decompress_"+v+"_",{zippath:v},{success:function(x){m.getitem(t.substr(0,t.length-3),t)}});return}m.selector_title="请选择要解压到的目录";m.selector.onlydir=true;m.selector.onlyfile=false;m.selector.load(m.curpath);m.selector.selecthandler=function(x){$("#selector").modal("hide");a.setInfo("正在检测目录...",true);o.post("/operation/file",{action:"listdir",path:x,showhidden:true,remember:false},function(z){if(z.code==0){a.setInfo("");var y=function(){var A=m.curpath+"/"+t;i.call(m,e,"/backend/decompress","/backend/decompress_"+A+"_"+x,{zippath:A,despath:x},{success:function(B){if(m.curpath==x){m.listdir()}}})};if(z.data.length>0){m.confirm_title="解压确认";m.confirm_body="<p>系统检测到目录 "+x+" 下存在文件，继续解压将可能覆盖这些文件。</p><p>确认要继续解压吗？</p>";$("#confirm").modal();m.confirm=y}else{y()}}else{a.setError("检测目录失败！")}},false,true)};$("#selector").modal()};m.$watch("selectall",function(s){angular.forEach(m.items,function(t){m.selects[t.name]=s})});m.multicopy=function(){var s=false;angular.forEach(m.selects,function(t,u){m.togglecopy(u,t);if(t){s=true}});if(!s){a.setError("请先选择文件或目录！");return}};m.multicut=function(){var s=false;angular.forEach(m.selects,function(t,u){m.togglecut(u,t);if(t){s=true}});if(!s){a.setError("请先选择文件或目录！");return}};m.multidel=function(){var s=[];angular.forEach(m.selects,function(t,u){if(t){s.push(m.curpath+"/"+u)}});if(s.length==0){a.setError("请先选择文件或目录！");return}o.post("/operation/file",{action:"delete",paths:s.join(",")},function(t){if(t.code==0){m.selects={};m.listdir()}})};m.tarconfirm=function(){var s=[];angular.forEach(m.selects,function(t,u){if(t){s.push(u)}});if(s.length==0){a.setError("请先选择文件或目录！");return}if(s.length==1){m.compressconfirm(s[0],false);return}m.compress_isreg=false;m.compress_type=".tar.gz";m.compress_zipname=m.curpath.split("/").pop();m.compress_name="多个项目";m.compress_names=s;$("#compressconfirm").modal()};m.tar=function(){var u=m.curpath+"/"+m.compress_zipname+m.compress_type;var s=[];for(var t=0;t<m.compress_names.length;t++){s.push(m.curpath+"/"+m.compress_names[t])}if(s.length==0){a.setError("请先选择文件或目录！");return}i.call(m,e,"/backend/compress","/backend/compress_"+u+"_"+s.join(","),{zippath:u,paths:s.join(",")},{success:function(v){m.listdir()}})};m.chownconfirm=function(u,t,w,s){if(!u){var v=[];angular.forEach(m.selects,function(x,y){if(x){v.push(y)}});if(v.length==0){a.setError("请先选择文件或目录！");return}}if(!m.users){o.post("/operation/user",{action:"listuser",fullinfo:false},function(x){if(x.code==0){m.users=x.data}},false,true)}if(!m.groups){o.post("/operation/user",{action:"listgroup",fullinfo:false},function(x){if(x.code==0){m.groups=x.data}},false,true)}if(u){m.chown_user=t;m.chown_group=w;m.chown_names=[u];m.chown_recursively=true;m.chown_hasdir=s}else{m.chown_names=v;m.chown_recursively=true;m.chown_hasdir=true}$("#chownconfirm").modal()};m.chown=function(){var t=[];for(var s=0;s<m.chown_names.length;s++){t.push(m.curpath+"/"+m.chown_names[s])}t=t.join(",");i.call(m,e,"/backend/chown","/backend/chown_"+t,{paths:t,user:m.chown_user,group:m.chown_group,recursively:m.chown_recursively},{success:function(u){if(m.chown_names.length==1){m.getitem(m.chown_names[0])}else{m.listdir()}}})};m.chmodconfirm=function(t,u,s){if(!t){var v=[];angular.forEach(m.selects,function(w,x){if(w){v.push(x)}});if(v.length==0){a.setError("请先选择文件或目录！");return}u="0744"}u=parseInt(u,8);m.chmod_permbits=[[(u&256)!=0,(u&128)!=0,(u&64)!=0],[(u&32)!=0,(u&16)!=0,(u&8)!=0],[(u&4)!=0,(u&2)!=0,(u&1)!=0],];m.chmod_recursively=true;if(t){m.chmod_names=[t];m.chmod_hasdir=s}else{m.chmod_names=v;m.chmod_hasdir=true}$("#chmodconfirm").modal()};m.chmod=function(){var u=0;for(var t=0;t<3;t++){for(var s=0;s<3;s++){u|=(m.chmod_permbits[t][s]<<(8-t*3-s))}}u=u.toString(8);var v=[];for(var t=0;t<m.chmod_names.length;t++){v.push(m.curpath+"/"+m.chmod_names[t])}v=v.join(",");i.call(m,e,"/backend/chmod","/backend/chmod_"+v,{paths:v,perms:u,recursively:m.chmod_recursively},{success:function(w){if(m.chmod_names.length==1){m.getitem(m.chmod_names[0])}else{m.listdir()}}})};var q=false;var g=CodeMirror(document.getElementById("editor"),{value:"",lineNumbers:true,lineWrapping:true,matchBrackets:true,onCursorActivity:function(){g.setLineClass(c,null,null);c=g.setLineClass(g.getCursor().line,null,"activeline");if(!$.browser.msie){g.matchHighlight("CodeMirror-matchhighlight")}},onChange:function(){q=true}});var c=g.setLineClass(0,"activeline")}];var FileTrashCtrl=["$scope","$routeParams","Module","Message","Request","Backend",function(b,g,c,f,e,a){var d="file.trash";c.init(d,"回收站管理");b.loaded=true;b.confirm=function(){};b.fileloading=false;b.tlist=function(){b.fileloading=true;e.post("/operation/file",{action:"tlist"},function(h){if(h.code==0){b.items=h.data;b.fileloading=false}})};b.restore=function(h,i){e.post("/operation/file",{action:"trestore",mount:h,uuid:i},function(j){if(j.code==0){b.tlist()}})};b.tdeleteconfirm=function(i,h,j){b.confirm_title="删除确认";b.confirm_body="<p>删除后文件将不可恢复！</p><p>确认要删除 "+i+" 吗？</p>";$("#confirm").modal();b.confirm=function(){b.tdelete(h,j)}};b.tdelete=function(h,i){e.post("/operation/file",{action:"titem",mount:h,uuid:i},function(j){if(j.code==0){var k=j.data.realpath;a.call(b,d,"/backend/remove","/backend/remove_"+k,{paths:k},function(){e.post("/operation/file",{action:"tdelete",mount:h,uuid:i},function(l){if(l.code==0){b.tlist()}})})}})};b.tcleanconfirm=function(){b.confirm_title="清空确认";b.confirm_body="<p>清空回收站后，回收站中的所有文件都将被删除且不可恢复！<p>								<p>确认要清空回收站吗？</p>";$("#confirm").modal();b.confirm=function(){b.tclean()}};b.tclean=function(){e.post("/operation/file",{action:"trashs"},function(h){if(h.code==0){var i=h.data.join(",");a.call(b,d,"/backend/remove","/backend/remove_"+i,{paths:i},function(){f.setSuccess("清空回收站完成！");b.tlist()})}})}}];