var SiteCtrl=["$scope","Module","$routeParams","Request","Message","Backend",function(i,e,h,a,f,d){var c="site";e.init(c,"网站管理");i.loaded=false;var g=e.getSection();i.has_httpserver=false;i.nginx_supported=false;i.apache_supported=false;i.site_packages=[];i.load=function(){a.get("/query/service.nginx,service.httpd",function(j){if(j["service.nginx"]&&j["service.nginx"].status){i.nginx_supported=true}if(j["service.httpd"]&&j["service.httpd"].status){i.apache_supported=true}i.has_httpserver=i.nginx_supported||i.apache_supported;if(i.has_httpserver){if(g){if(g=="nginx"&&i.nginx_supported){e.setSection("nginx")}else{if(g=="apache"&&i.apache_supported){e.setSection("apache")}else{if(g=="package"){e.setSection("package")}else{e.setSection(i.nginx_supported?"nginx":"apache")}}}}else{e.setSection(i.nginx_supported?"nginx":"apache")}}i.loaded=true;i.loadsites()});a.get("/sitepackage/getlist",function(j){if(j.code==0){i.site_packages=j.data}})};i.package_install_setting=function(j){i.curpkg=j;i.curver=j.versions[0];i.pkgver=i.curver.code;i.installpath="/var/www";$("#pkg_install_setting").modal()};i.package_version_select=function(j){i.pkgver=j.code;i.curver=j};i.selectinstallpath=function(j){i.selector_title="请选择安装目录";i.selector.onlydir=true;i.selector.onlyfile=false;i.selector.load(i.installpath);i.selector.selecthandler=function(k){$("#selector").modal("hide");i.installpath=k};$("#selector").modal()};i.package_install=function(){f.setInfo("正在检测安装目录...",true);a.post("/operation/file",{action:"listdir",path:i.installpath,showhidden:true,remember:false},function(j){if(j.code==0){f.setInfo("");if(j.data.length>0){i.confirm_title="安装确认";i.confirm_body="<p>系统检测到目录 "+i.installpath+" 下存在文件，继续安装将可能会覆盖原文件。</p><p>确认要继续安装吗？</p>";$("#confirm").modal();i.confirm=b}else{b()}}else{f.setError("安装失败！"+j.msg)}},false,true)};function b(){f.setInfo("正在请求安装文件...");a.get("/sitepackage/getdownloadtask?name="+i.curpkg.code+"&version="+i.pkgver,function(j){if(j.code==0){i.downloadurl=j.data.url;i.downloadpath=j.data.path;i.extractpath=j.data.temp;d.call(i,c,"/backend/wget","/backend/wget_"+encodeURIComponent(encodeURIComponent(i.downloadurl)),{url:i.downloadurl,path:i.downloadpath},{success:function(l){var m=i.downloadpath;var k=i.extractpath;d.call(i,c,"/backend/decompress","/backend/decompress_"+m+"_"+k,{zippath:m,despath:k},{success:function(p){var q=i.curver.core_path;var o=i.extractpath+"/"+q+"/*";var n=i.installpath;d.call(i,c,"/backend/copy","/backend/copy_"+o+"_"+n,{srcpath:o,despath:n},{success:function(r){f.setInfo("正在清理安装临时文件...");d.call(i,c,"/backend/remove","/backend/remove_"+i.extractpath,{paths:i.extractpath},function(){f.setInfo("正在设置目录权限...");d.call(i,c,"/backend/chown","/backend/chown_"+i.installpath,{paths:i.installpath,user:"apache",group:"apache",recursively:true},{success:function(s){f.setSuccess(i.curpkg.name+" v"+i.pkgver+" 安装完成！")}})},true)},error:function(r){f.setError("复制安装文件过程中出现错误，安装取消！")}})}})},error:function(k){f.setError("下载安装包过程中出现错误，安装取消！")}},false)}})}i.loadsites=function(){if(i.nginx_supported){i.loadnginx()}if(i.apache_supported){i.loadapache()}};i.nginxloading=false;i.loadnginx=function(){i.nginxloading=true;a.post("/operation/nginx",{action:"getservers"},function(j){if(j.code==0){i.servers=j.data;i.nginxloading=false}})};i.loadapache=function(){};i.nginx_enableserver=function(l,k,j){a.post("/operation/nginx",{action:"enableserver",ip:l,port:k,server_name:j},function(m){if(m.code==0){i.loadnginx()}})};i.nginx_disableserver=function(l,k,j){a.post("/operation/nginx",{action:"disableserver",ip:l,port:k,server_name:j},function(m){if(m.code==0){i.loadnginx()}})};i.nginx_deleteserverconfirm=function(l,k,j){i.nginx_ip=l;i.nginx_port=k;i.nginx_server_name=j;$("#nginx_deleteserverconfirm").modal()};i.nginx_deleteserver=function(){a.post("/operation/nginx",{action:"deleteserver",ip:i.nginx_ip,port:i.nginx_port,server_name:i.nginx_server_name},function(j){if(j.code==0){i.loadnginx()}})}}];var SiteNginxCtrl=["$scope","Module","$routeParams","$location","Request","Backend","Timeout",function(n,u,h,k,q,i,s){var j=h.section;var p=j=="new"?"new":"edit";var l=p=="edit"?j.substr(5):"";var e,f,o;if(p=="edit"){l=l.split("_");if(l.length==3){e=l[0];f=l[1];o=l[2]}else{if(l.length==4&&l[3]==""){e=l[0];f=l[1];o="_"}else{k.path("/site");return}}}var b="site.nginx";u.init(b,p=="new"?"新建站点（Nginx）":"编辑站点（Nginx）");n.loaded=false;n.showglobaladv=false;n.curloc=-1;n.setloc=function(v){n.curloc=v};n.action=p;var d={server_names:[],listens:[],charset:"",index:"index.html index.htm index.php",locations:[],limit_rate:"",limit_conn:"",ssl_crt:"",ssl_key:"",rewrite_enable:false,rewrite_rules:""};var t={name:"",default_name:false};var r={ip:"",port:"80",ssl:false,default_server:false};var a={urlpath:"/",engine:"static","static":{root:"/var/www/",autocreate:true,autoindex:false,rewrite_enable:false,rewrite_detect_file:true,rewrite_rules:""},fastcgi:{root:"/var/www/",autocreate:true,fastcgi_pass:"127.0.0.1:9000",rewrite_enable:false,rewrite_detect_file:true,rewrite_rules:""},proxy:{protocol:"http",host:"",realip:true,charset:"",backends:[],balance:"ip_hash",keepalive:"10",proxy_cache_enable:false,proxy_cache:"",proxy_cache_min_uses:"",proxy_cache_methods_post:false,proxy_cache_key:{schema:true,host:false,proxy_host:true,uri:true,},proxy_cache_valid:[],proxy_cache_use_stale:{error:false,timeout:false,invalid_header:false,updating:false,http_500:false,http_502:false,http_503:false,http_504:false,http_404:false},proxy_cache_lock:false,proxy_cache_lock_timeout:"5"},redirect:{url:"",type:"301",option:"keep"},error:{code:"404"}};var m={server:"",weight:"",fail_timeout:"10",max_fails:"3"};var g={code:"any",time:"1",time_unit:"h"};n.setting=angular.copy(d);n.gen_by_vpsmate=p=="new"?true:false;var c={"301_1":"rewrite ^ http://example.com$request_uri? permanent","301_2":"rewrite ^ http://example.com/ permanent","302_1":"rewrite ^ http://example.com$request_uri? redirect","302_2":"rewrite ^ http://example.com/ redirect"};n.$watch("rewrite_template",function(v){n.setting.rewrite_rules=v?c[v]:""});n.load=function(){if(p=="new"){n.loaded=true}else{n.getserver()}i.call(n,b,"/backend/yum_info","/backend/yum_info_nginx",{pkg:"nginx",repo:"installed"},{success:function(v){n.nginx_version=v.data[0].version},error:function(v){n.nginx_version=""}},true);n.loadproxycaches()};n.proxy_caches=[];n.loadproxycaches=function(){q.post("/operation/nginx",{action:"gethttpsettings",items:"proxy_cache_path[]"},function(x){if(x.code==0){var w=$.browser.msie?[""]:[];var y=x.data.proxy_cache_path;if(y){for(var v=0;v<y.length;v++){w.push(y[v].name)}}n.proxy_caches=w}},false,true)};n.getserver=function(v){q.post("/operation/nginx",{action:"getserver",ip:e,port:f,server_name:o},function(B){if(B.code==0){var E=B.data;var K=n.setting;n.gen_by_vpsmate=E._vpsmate;for(A in E.server_names){var w=E.server_names[A];K.server_names.push({name:w,default_name:w=="_"})}for(A in E.listens){var z=E.listens[A];var I=angular.copy(r);if(typeof z.ip!="undefined"){I.ip=z.ip}if(typeof z.port!="undefined"){I.port=z.port}if(typeof z.ssl!="undefined"){I.ssl=z.ssl}if(typeof z.default_server!="undefined"){I.default_server=z.default_server}K.listens.push(I)}if(E.index){K.index=E.index}if(E.charset){K.charset=E.charset}if(E.limit_rate){K.limit_rate=E.limit_rate}if(E.limit_conn){K.limit_conn=E.limit_conn}if(E.ssl_crt){K.ssl_crt=E.ssl_crt}if(E.ssl_key){K.ssl_key=E.ssl_key}if(E.rewrite_rules){K.rewrite_rules=E.rewrite_rules.join("\n");if(K.rewrite_rules){K.rewrite_enable=true}}if(E.locations){for(A in E.locations){var C=E.locations[A];var I=angular.copy(a);if(typeof C.urlpath!="undefined"){I.urlpath=C.urlpath;I.oldurlpath=I.urlpath}if(typeof C.error_code!="undefined"){I.engine="error";I.error.code=C.error_code}else{if(typeof C.fastcgi_pass!="undefined"){I.engine="fastcgi";I.fastcgi.fastcgi_pass=C.fastcgi_pass;if(C.root){I.fastcgi.root=C.root}I.fastcgi.rewrite_detect_file=C.rewrite_detect_file?true:false;if(C.rewrite_rules){I.fastcgi.rewrite_rules=C.rewrite_rules.join(";\n");if(I.fastcgi.rewrite_rules){I.fastcgi.rewrite_rules+=";";I.fastcgi.rewrite_enable=true}}}else{if(typeof C.proxy_protocol!="undefined"){I.engine="proxy";I.proxy.protocol=C.proxy_protocol;if(typeof C.proxy_host!="undefined"){I.proxy.host=C.proxy_host}if(typeof C.proxy_realip!="undefined"){I.proxy.realip=C.proxy_realip}if(typeof C.proxy_balance!="undefined"){I.proxy.balance=C.proxy_balance}if(typeof C.proxy_keepalive!="undefined"){I.proxy.keepalive=C.proxy_keepalive}for(A in C.proxy_backends){var F=C.proxy_backends[A];var G=angular.copy(m);if(typeof F.server!="undefined"){G.server=F.server}if(typeof F.weight!="undefined"){G.weight=F.weight}if(typeof F.fail_timeout!="undefined"){G.fail_timeout=F.fail_timeout}if(typeof F.max_fails!="undefined"){G.max_fails=F.max_fails}I.proxy.backends.push(G)}if(typeof C.proxy_cache!="undefined"){I.proxy.proxy_cache_enable=true;I.proxy.proxy_cache=C.proxy_cache;if(typeof C.proxy_cache_min_uses!="undefined"){I.proxy.proxy_cache_min_uses=C.proxy_cache_min_uses}if(typeof C.proxy_cache_methods!="undefined"){I.proxy.proxy_cache_methods_post=C.proxy_cache_methods=="POST"}if(typeof C.proxy_cache_key!="undefined"){var y=C.proxy_cache_key.split("$");var J=I.proxy.proxy_cache_key;for(var A=0;A<y.length;A++){if(y[A]=="schema"){J.schema=true}else{if(y[A]=="host"){J.host=true}else{if(y[A]=="proxy_host"){J.proxy_host=true}else{if(y[A]=="request_uri"){J.uri=true}}}}}}if(typeof C.proxy_cache_valid!="undefined"){var D=C.proxy_cache_valid;for(var A=0;A<D.length;A++){I.proxy.proxy_cache_valid.push({code:D[A].code,time:parseInt(D[A].time)+"",time_unit:D[A].time.substr(D[A].time.length-1),})}}if(typeof C.proxy_cache_use_stale!="undefined"){var x=C.proxy_cache_use_stale;var H=I.proxy.proxy_cache_use_stale;for(var A=0;A<x.length;A++){if(x[A]=="error"){H.error=true}else{if(x[A]=="timeout"){H.timeout=true}else{if(x[A]=="invalid_header"){H.invalid_header=true}else{if(x[A]=="updating"){H.updating=true}else{if(x[A]=="http_500"){H.http_500=true}else{if(x[A]=="http_502"){H.http_502=true}else{if(x[A]=="http_503"){H.http_503=true}else{if(x[A]=="http_504"){H.http_504=true}else{if(x[A]=="http_404"){H.http_404=true}}}}}}}}}}}if(typeof C.proxy_cache_lock!="undefined"){I.proxy.proxy_cache_lock=C.proxy_cache_lock;if(typeof C.proxy_cache_lock_timeout!="undefined"){I.proxy.proxy_cache_lock_timeout=C.proxy_cache_lock_timeout}}}}else{if(typeof C.redirect_url!="undefined"){I.engine="redirect";I.redirect.url=C.redirect_url;if(typeof C.redirect_type!="undefined"){I.redirect.type=C.redirect_type}if(typeof C.redirect_option!="undefined"){I.redirect.option=C.redirect_option}}else{if(typeof C.root!="undefined"){I.engine="static";I["static"].root=C.root;I["static"].rewrite_detect_file=C.rewrite_detect_file?true:false;if(typeof C.autoindex!="undefined"){I["static"].autoindex=C.autoindex}if(C.rewrite_rules){I["static"].rewrite_rules=C.rewrite_rules.join(";\n");if(I["static"].rewrite_rules){I["static"].rewrite_rules+=";";I["static"].rewrite_enable=true}}}}}}}if(I.proxy.backends.length==0){I.proxy.backends.push(angular.copy(m))}K.locations.push(I)}}n.curloc=0;n.loaded=true}else{s(function(){k.path("/site")},1000,b)}},false,v)};n.deleteservername=function(v){n.setting.server_names.splice(v,1)};n.addservername=function(){n.setting.server_names.push(angular.copy(t))};n.deletelisten=function(v){n.setting.listens.splice(v,1)};n.addlisten=function(){n.setting.listens.push(angular.copy(r))};n.deletelocation=function(v){n.setting.locations.splice(v,1);n.curloc--;if(n.curloc<0&&n.setting.locations.length>0){n.curloc=0}};n.addlocation=function(){var v=n.setting.locations;v.splice(n.curloc+1,0,angular.copy(a));n.proxy_addbackend(n.curloc+1);n.curloc++};n.proxy_deletebackend=function(v,w){n.setting.locations[v].proxy.backends.splice(w,1)};n.proxy_addbackend=function(v){n.setting.locations[v].proxy.backends.push(angular.copy(m));n.proxy_addvalid(v)};n.proxy_deletevalid=function(v,w){n.setting.locations[v].proxy.proxy_cache_valid.splice(w,1)};n.proxy_addvalid=function(v){n.setting.locations[v].proxy.proxy_cache_valid.push(angular.copy(g))};n.$watch("setting.server_names[0].name",function(D,x){var w=D;var v=x;var A=n.setting.locations;for(var z=0;z<A.length;z++){if(A[z].urlpath=="/"){var B=a["static"].root;var y=B+"/"+v;y=y.replace("//","/");if(A[z]["static"].root==y){var C=B+"/"+w;A[z]["static"].root=C.replace("//","/")}var B=a.fastcgi.root;var y=B+"/"+v;y=y.replace("//","/");if(A[z].fastcgi.root==y){var C=B+"/"+w;A[z].fastcgi.root=C.replace("//","/")}}}});n.urlpathchange=function(w){if(w.urlpath.length==0){w.urlpath="/"}if(w.engine=="fastcgi"&&w.fastcgi.rewrite_enable){var v=new RegExp("([\\^\\s])("+(w.oldurlpath+"/").replace("//","/").replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")+")","gm");w.fastcgi.rewrite_rules=w.fastcgi.rewrite_rules.replace(v,"$1"+(w.urlpath+"/").replace("//","/"));w.oldurlpath=w.urlpath}};n.selectstaticfolder=function(v){n.selector_title="请选择站点目录";n.selector.onlydir=true;n.selector.onlyfile=false;n.selector.load(n.setting.locations[v]["static"].root);n.selector.selecthandler=function(w){$("#selector").modal("hide");n.setting.locations[v]["static"].root=w};$("#selector").modal()};n.selectfastcgifolder=function(v){n.selector_title="请选择站点目录";n.selector.onlydir=true;n.selector.onlyfile=false;n.selector.load(n.setting.locations[v].fastcgi.root);n.selector.selecthandler=function(w){$("#selector").modal("hide");n.setting.locations[v].fastcgi.root=w};$("#selector").modal()};n.selectsslcrt=function(v){n.selector_title="请选择CRT文件（*.crt）";n.selector.onlydir=false;n.selector.onlyfile=true;n.selector.load("/root");n.selector.selecthandler=function(w){$("#selector").modal("hide");n.setting.ssl_crt=w};$("#selector").modal()};n.selectsslkey=function(v){n.selector_title="请选择密钥文件（*.key）";n.selector.onlydir=false;n.selector.onlyfile=true;n.selector.load("/root");n.selector.selecthandler=function(w){$("#selector").modal("hide");n.setting.ssl_key=w};$("#selector").modal()};n.addserver=function(){q.post("/operation/nginx",{action:"addserver",version:n.nginx_version,setting:angular.toJson(n.setting)},function(x){if(x.code==0){var w=n.setting;n.loaded=false;var v=(w.listens[0].ip?w.listens[0].ip:"*")+"_"+w.listens[0].port+"_"+w.server_names[0].name;s(function(){k.path("/site/nginx/edit_"+encodeURIComponent(v))},1000,b)}})};n.updateserver=function(){q.post("/operation/nginx",{action:"updateserver",ip:e,port:f,server_name:o,version:n.nginx_version,setting:angular.toJson(n.setting)},function(x){if(x.code==0){var w=n.setting;n.loaded=false;var v=(w.listens[0].ip?w.listens[0].ip:"*")+"_"+w.listens[0].port+"_"+w.server_names[0].name;s(function(){var y="/site/nginx/edit_"+encodeURIComponent(v);if(y!=k.path()){k.path(y)}else{n.restore()}},1000,b)}})};n.restore=function(){n.setting=angular.copy(d);n.getserver()};if(j=="new"){n.addservername();n.addlisten();n.addlocation()}}];